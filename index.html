<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Bot Elite V7 (Full Suite)</title>
    
    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --accent-color: #8b5cf6;
            --success-color: #22c55e;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --border-color: #e2e8f0;
            --radius-lg: 16px;
            --radius-sm: 8px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --primary-color: #60a5fa;
            --primary-dark: #3b82f6;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.5);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
        }

        /* --- GLOBAL RESET & BASE STYLES --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding-bottom: 90px; /* Space for Bottom Nav */
            user-select: none;
            overflow-x: hidden;
            transition: background 0.3s ease;
        }

        /* --- LOADING SCREEN --- */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-body);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }
        .loader-icon { font-size: 3rem; margin-bottom: 20px; animation: bounce 1.5s infinite; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--border-color);
            border-top-color: var(--primary-color); border-radius: 50%;
            animation: spin 0.8s infinite linear;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* --- HEADER --- */
        .app-header {
            background: var(--bg-card);
            padding: 16px 20px;
            position: sticky; top: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        .header-logo {
            font-weight: 800; font-size: 1.15rem;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .header-badge {
            background: rgba(0,0,0,0.04); color: var(--text-secondary);
            padding: 6px 12px; border-radius: 20px;
            font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; gap: 6px;
        }

        /* --- VIEW CONTAINERS & ANIMATION --- */
        .view-section {
            display: none; 
            padding: 20px; 
            max-width: 700px; 
            margin: 0 auto;
            animation: fadeInSlide 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .view-section.active { display: block; }
        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- NAVIGATION CARDS (Level 1 & 2) --- */
        .nav-block {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px; margin-bottom: 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: var(--transition);
        }
        .nav-block:active { transform: scale(0.98); }
        .nav-block-content { display: flex; align-items: center; gap: 16px; }
        .block-icon {
            width: 48px; height: 48px;
            background: rgba(59, 130, 246, 0.1); color: var(--primary-color);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
        }

        /* --- SELECTION LISTS (Checkboxes) --- */
        .group-header {
            font-weight: 700; color: var(--primary-color); margin-top: 24px; margin-bottom: 8px;
            font-size: 1.1rem; border-bottom: 2px solid var(--border-color); padding-bottom: 4px;
        }

        .check-item {
            background: var(--bg-card); padding: 16px;
            border-radius: var(--radius-lg); margin-bottom: 10px;
            display: flex; align-items: center; gap: 14px;
            border: 1px solid var(--border-color);
            transition: var(--transition); cursor: pointer;
        }
        .check-item.selected {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }
        .custom-checkbox {
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--text-secondary);
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition);
        }
        .check-item.selected .custom-checkbox {
            background: var(--primary-color); border-color: var(--primary-color);
        }
        .custom-checkbox::after { content: 'âœ”'; color: white; font-size: 14px; display: none; }
        .check-item.selected .custom-checkbox::after { display: block; }

        /* --- BREADCRUMB --- */
        .breadcrumbs-bar {
            display: flex; align-items: center; gap: 8px; 
            margin-bottom: 24px; flex-wrap: wrap; font-size: 0.9rem;
        }
        .crumb { color: var(--text-secondary); cursor: pointer; }
        .crumb.active { color: var(--primary-color); font-weight: bold; }
        .crumb-sep { color: var(--border-color); }

        /* --- FLOATING ACTION BUTTON (FAB) --- */
        .fab-next {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
            background: var(--text-primary); color: var(--bg-card);
            padding: 14px 32px; border-radius: 50px;
            font-weight: bold; box-shadow: 0 10px 25px rgba(0,0,0,0.25);
            cursor: pointer; display: none; z-index: 100;
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        body.dark-mode .fab-next { background: var(--primary-color); color: white; }
        @keyframes popIn { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* --- SETUP CHIPS --- */
        .chip-group { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0 25px; }
        .choice-chip {
            background: var(--bg-card); border: 1px solid var(--border-color);
            padding: 10px 20px; border-radius: 40px; cursor: pointer;
            flex: 1; text-align: center; font-size: 0.9rem; transition: 0.2s; white-space: nowrap;
        }
        .choice-chip.active {
            background: var(--primary-color); color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* --- ACTION BUTTONS --- */
        .btn-block {
            width: 100%; background: var(--primary-color); color: white;
            padding: 18px; border-radius: var(--radius-lg); border: none;
            font-size: 1.1rem; font-weight: 700; cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); margin-top: 15px;
            transition: transform 0.1s;
        }
        .btn-block:active { transform: translateY(2px); }

        /* --- QUIZ UI --- */
        .quiz-image { width: 100%; border-radius: var(--radius-lg); margin-bottom: 20px; display: block; border: 1px solid var(--border-color); }
        .question-txt { font-size: 1.25rem; font-weight: 600; line-height: 1.6; margin: 20px 0; }
        .option-card {
            background: var(--bg-card); width: 100%; padding: 18px; margin-bottom: 12px;
            border-radius: 12px; border: 2px solid transparent; cursor: pointer;
            box-shadow: var(--shadow-sm); text-align: right; font-size: 1rem; color: var(--text-primary);
            transition: all 0.2s;
        }
        .option-card:hover { border-color: var(--primary-color); }
        .option-card.correct { background: #dcfce7; border-color: #16a34a; color: #14532d; }
        .option-card.wrong { background: #fee2e2; border-color: #ef4444; color: #7f1d1d; }
        
        .explanation-box {
            display: none; background: #fffbeb; color: #92400e; 
            padding: 20px; border-radius: 12px; margin-top: 20px; line-height: 1.6;
            border: 1px solid #fcd34d; animation: fadeInSlide 0.3s ease;
        }
        body.dark-mode .explanation-box { background: #451a03; color: #fcd34d; border-color: #92400e; }

        /* --- BOTTOM BAR --- */
        .nav-bottom {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 75px;
            background: var(--bg-card); border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-around; align-items: center; z-index: 80;
            padding-bottom: 10px; /* Safe Area */
        }
        .tab-btn { background:none; border:none; display:flex; flex-direction:column; align-items:center; gap:4px; color:var(--text-secondary); cursor:pointer; }
        .tab-btn.active { color: var(--primary-color); }
        .tab-btn svg { width: 26px; height: 26px; fill: currentColor; }
        .tab-lbl { font-size: 0.75rem; font-weight: 500; }

        /* --- SELECT ALL HEADER --- */
        .bulk-select-bar {
            display: flex; align-items: center; gap: 10px;
            background: var(--bg-card); padding: 12px 16px; border-radius: var(--radius-lg);
            border: 1px solid var(--border-color); margin-bottom: 20px;
        }
        
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }

    </style>
</head>
<body>

    <!-- === LOADER === -->
    <div id="loading-screen">
        <div class="loader-icon">ğŸ“‚</div>
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: var(--text-secondary);">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
    </div>

    <!-- === HEADER === -->
    <header class="app-header">
        <div class="header-logo">ExaM Bot Elite V7</div>
        <div class="header-badge">
            ğŸ† <span id="lbl-score">--</span>
        </div>
    </header>

    <!-- === VIEW 1: DASHBOARD (HOME) === -->
    <div id="v-home" class="view-section active">
        <div style="margin-bottom: 20px;">
            <h1 style="margin:0; font-size:1.5rem">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h1>
            <p style="margin:5px 0 0; color:var(--text-secondary)">Ø§Ø®ØªØ± Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙØ¹Ù„ Ø§Ù„ÙŠÙˆÙ…</p>
        </div>

        <div class="nav-block" onclick="startNewSession()">
            <div class="nav-block-content">
                <div class="block-icon">ğŸ“š</div>
                <div>
                    <div style="font-weight:700; font-size:1.1rem">ØªØµÙØ­ Ø§Ù„Ù…Ù†Ù‡Ø¬</div>
                    <div style="font-size:0.85rem; color:var(--text-secondary)">
                        Ø§Ø®ØªÙŠØ§Ø± ØªØ±Ù… > Ù…Ø§Ø¯Ø© > Ø¯Ø±ÙˆØ³ > ÙØµÙˆÙ„
                    </div>
                </div>
            </div>
            <div style="color:var(--text-secondary)">â¬…ï¸</div>
        </div>

        <div class="nav-block" onclick="startMistakesMode()">
            <div class="nav-block-content">
                <div class="block-icon" style="color:var(--danger); background:rgba(239,68,68,0.1)">ğŸ’Š</div>
                <div>
                    <div style="font-weight:700; font-size:1.1rem">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div>
                    <div style="font-size:0.85rem; color:var(--text-secondary)">
                        Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØµØ¹Ø¨Ø©
                    </div>
                </div>
            </div>
            <div style="color:var(--text-secondary)">â¬…ï¸</div>
        </div>
        
        <div style="text-align: center; margin-top: 40px;">
             <button onclick="window.location.reload()" style="background:none; border:none; color:var(--primary-color); font-weight:bold; cursor:pointer;">
                 ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
             </button>
        </div>
    </div>

    <!-- === VIEW 2: TERM SELECTION === -->
    <div id="v-terms" class="view-section">
        <div class="breadcrumbs-bar">
            <span class="crumb active">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span> <span class="crumb-sep">/</span> <span class="crumb">Ø§Ù„ØªØ±Ù…</span>
        </div>
        <h2>Ø£ÙŠ ØªØ±Ù… Ø¯Ø±Ø§Ø³ÙŠØŸ</h2>
        <div id="container-terms"></div>
    </div>

    <!-- === VIEW 3: SUBJECT SELECTION === -->
    <div id="v-subjects" class="view-section">
        <div class="breadcrumbs-bar">
            <span class="crumb" onclick="goHome()">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span> <span class="crumb-sep">/</span>
            <span class="crumb" onclick="startNewSession()">Ø§Ù„ØªØ±Ø±Ù…Ø§Øª</span> <span class="crumb-sep">/</span>
            <span class="crumb active">Ø§Ù„Ù…Ø§Ø¯Ø©</span>
        </div>
        <h2>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©:</h2>
        <div id="container-subjects"></div>
    </div>

    <!-- === VIEW 4: LESSONS (MULTI-SELECT) === -->
    <div id="v-lessons" class="view-section">
        <div class="breadcrumbs-bar">
            <span class="crumb" onclick="backToSubjects()">Ø§Ù„Ù…Ø§Ø¯Ø©</span> <span class="crumb-sep">/</span>
            <span class="crumb active">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯Ø±ÙˆØ³</span>
        </div>
        
        <h2 style="margin-bottom:5px">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±ÙˆØ³</h2>
        <p style="color:var(--text-secondary); margin-top:0">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø¯Ø±Ø³ ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø±</p>

        <div class="bulk-select-bar">
            <div class="custom-checkbox" id="icon-all-lessons" onclick="toggleAllVisibleLessons()"></div>
            <span style="font-weight:bold; cursor:pointer" onclick="toggleAllVisibleLessons()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</span>
        </div>

        <div id="container-lessons"></div>
        <div style="height:60px"></div>
    </div>

    <!-- === VIEW 5: CHAPTERS (NESTED SELECT) === -->
    <div id="v-chapters" class="view-section">
        <div class="breadcrumbs-bar">
            <span class="crumb" onclick="renderLessonsView()">Ø§Ù„Ø¯Ø±ÙˆØ³</span> <span class="crumb-sep">/</span>
            <span class="crumb active">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØµÙˆÙ„</span>
        </div>
        
        <h2 style="margin-bottom:5px">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¯Ù‚Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</h2>
        <p style="color:var(--text-secondary); margin-top:0">Ù‚Ù… Ø¨Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ±ÙŠØ¯Ù‡Ø§ (Ø¥Ù† ÙˆØ¬Ø¯)</p>

        <!-- Dynamic List Grouped by Lesson -->
        <div id="container-chapters"></div>
        <div style="height:80px"></div>
    </div>

    <!-- === VIEW 6: QUIZ SETUP === -->
    <div id="v-setup" class="view-section">
        <div class="breadcrumbs-bar">
            <span class="crumb" onclick="backFromSetup()">â¬…ï¸ Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</span>
        </div>

        <div style="text-align:center; margin-bottom:30px">
            <div style="font-size:3rem; margin-bottom:10px">âš™ï¸</div>
            <h2 style="margin:0">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
            <p id="txt-selection-summary" style="color:var(--text-secondary)"></p>
        </div>

        <label style="font-weight:700">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
        <div class="chip-group" id="grp-mode">
            <div class="choice-chip active" onclick="setMode('new', this)">ğŸŒŸ Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·</div>
            <div class="choice-chip" onclick="setMode('mistake', this)">ğŸš¨ Ø£Ø®Ø·Ø§Ø¡ Ø³Ø§Ø¨Ù‚Ø©</div>
            <div class="choice-chip" onclick="setMode('mixed', this)">ğŸ”€ Ù…Ø®ØªÙ„Ø·</div>
        </div>

        <label style="font-weight:700">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
        <div class="chip-group" id="grp-qty">
            <div class="choice-chip active" onclick="setQty(5, this)">5</div>
            <div class="choice-chip" onclick="setQty(10, this)">10</div>
            <div class="choice-chip" onclick="setQty(25, this)">25</div>
            <div class="choice-chip" onclick="setQty(999, this)">Ø§Ù„ÙƒÙ„</div>
        </div>
        
        <div id="msg-error" style="background:#fee2e2; color:#ef4444; padding:15px; border-radius:12px; margin-bottom:15px; text-align:center; display:none">
            Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©!
        </div>

        <button class="btn-block" onclick="startQuizEngine()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù† ğŸš€</button>
    </div>

    <!-- === VIEW 7: QUIZ RUNNER === -->
    <div id="v-quiz" class="view-section">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-size:0.9rem; color:var(--text-secondary)">
            <span id="txt-q-progress"> Ø§Ù„Ø³Ø¤Ø§Ù„ 1 / 10 </span>
            <span id="txt-q-id" style="font-family:monospace; background:rgba(0,0,0,0.05); padding:2px 6px; border-radius:4px"></span>
            <span onclick="confirmEndQuiz()" style="color:var(--error-color); cursor:pointer; font-weight:bold">Ø¥Ù†Ù‡Ø§Ø¡ âœ–</span>
        </div>

        <div id="quiz-area">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- === VIEW 8: LEADERBOARD === -->
    <div id="v-leader" class="view-section">
        <h2 style="text-align:center; margin-bottom:20px">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ğŸ‘‘</h2>
        <div id="container-leaderboard" style="background:var(--bg-card); border-radius:12px; box-shadow:var(--shadow-md); overflow:hidden;">
            <!-- Loaded via JS -->
        </div>
    </div>

    <!-- FLOATING BUTTON (FAB) -->
    <div id="fab-next" class="fab-next"></div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="nav-bottom">
        <button class="tab-btn active" onclick="goHome()">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span class="tab-lbl">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </button>
        <button class="tab-btn" onclick="openLeaderboard()">
            <svg viewBox="0 0 24 24"><path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/></svg>
            <span class="tab-lbl">Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</span>
        </button>
    </nav>

<script>
    /** 
     * ===============================================
     * CONFIGURATION (UPDATE THESE VALUES)
     * ===============================================
     */
    const CONFIG = {
        firebase: { 
            apiKey: "AIzaSyDEZFJmcXK2LxYAZ-Yjv_M1HbC6zi_qilg",
            authDomain: "exambotdb.firebaseapp.com",
            databaseURL: "https://exambotdb-default-rtdb.firebaseio.com",
            projectId: "exambotdb",
            storageBucket: "exambotdb.firebasestorage.app",
            messagingSenderId: "950600562980",
            appId: "1:950600562980:web:f993c22d45e5cfdd3d9bb1"
        }
    };

    /** 
     * ===============================================
     * GLOBAL APP STATE 
     * ===============================================
     */
    const TG = window.Telegram.WebApp;
    let DB = null; // Firebase DB Instance
    let UserID = "guest_v7"; // Default ID

    const State = {
        // --- DATA ---
        allQuestions: [],   // Flattened Array
        
        // HIERARCHY STRUCTURE
        // tree[Term][Subject][Lesson] = [Chapter1, Chapter2...] (Set of Unique Strings)
        // Note: We need this to list chapters given a lesson name
        tree: {},
        
        userProgress: {},   // { questionID: 'correct'|'wrong' }
        
        // --- NAVIGATION STATE ---
        currentTerm: null,
        currentSubject: null,
        
        // --- SELECTION STATE ---
        // Array of selected Lesson Names (Strings) for the current Subject
        selectedLessons: [],
        
        // Array of selected UNIQUE KEYS for Chapters: "Term|Subject|Lesson|Chapter"
        selectedChapters: [],
        
        // --- QUIZ STATE ---
        isMistakeMode: false,
        settings: { mode: 'new', qty: 5 },
        activeQueue: [],
        activeIdx: 0,
    };

    /** 
     * ===============================================
     * BOOTSTRAP & DATA LOADING
     * ===============================================
     */
    window.onload = function() {
        // Telegram Init
        TG.ready(); TG.expand();
        if(TG.initDataUnsafe?.user?.id) UserID = TG.initDataUnsafe.user.id.toString();
        if(TG.colorScheme === 'dark') document.body.classList.add('dark-mode');

        // Firebase Init
        if(window.firebase && !firebase.apps.length) {
            try {
                firebase.initializeApp(CONFIG.firebase);
                DB = firebase.database();
            } catch(e) { console.error("Firebase Config Error:", e); }
        }

        // Fetch Data
        initializeData();
    };

    async function initializeData() {
        if(!navigator.onLine) {
            document.querySelector('#loading-screen h3').innerText = "Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ù†ØªØ±Ù†Øª!";
            return;
        }

        try {
            // 1. Manifest
            const manifestReq = await fetch('questions_list.json?t=' + Date.now());
            if(!manifestReq.ok) throw new Error("Manifest load failed");
            const filesList = await manifestReq.json();

            // 2. Fetch Files Parallel
            const jobs = filesList.map(f => fetch('Questions/' + f).then(r => r.json()));
            const filesData = await Promise.all(jobs);

            // 3. Process & Index Data
            processFiles(filesData);

            // 4. Fetch User Progress (Async)
            if(DB && UserID !== 'guest_v7') {
                DB.ref(`users/${UserID}/progress`).once('value').then(snap => {
                    State.userProgress = snap.val() || {};
                    updateScoreBadge();
                });
            } else {
                updateScoreBadge(); // 0 for guest
            }

            // Finish Loading
            document.getElementById('loading-screen').style.opacity = '0';
            setTimeout(() => { document.getElementById('loading-screen').style.display = 'none'; }, 500);

        } catch (e) {
            console.error(e);
            alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Console.");
            document.getElementById('loading-screen').innerHTML += `<br><button onclick="location.reload()">retry</button>`;
        }
    }

    function processFiles(dataArray) {
        let qArr = [];
        let hTree = {};

        dataArray.forEach(file => {
            const meta = file.meta || {};
            // Level 1: Term (Source)
            const term = meta.source || meta.term || "General Term";
            // Level 2: Subject
            const sub = meta.subject || "General Subject";
            // Level 3: Lesson
            const lesson = meta.lesson || "General Lesson";

            // Init Tree Path
            if(!hTree[term]) hTree[term] = {};
            if(!hTree[term][sub]) hTree[term][sub] = {};
            if(!hTree[term][sub][lesson]) hTree[term][sub][lesson] = new Set(); // Using Set for Unique Chapters

            file.questions.forEach(q => {
                // Level 4: Chapter
                const chap = q.chapter || "General Topic";
                
                // Construct Unique ID Key for tracking selection
                const uniqueKey = `${term}|${sub}|${lesson}|${chap}`;
                
                // Enhanced Question Object
                const qObj = {
                    ...q,
                    _hierarchyKey: uniqueKey, // for easy filtering later
                    _meta: { term, subject: sub, lesson, chapter: chap }
                };

                qArr.push(qObj);
                hTree[term][sub][lesson].add(chap); // Add chapter name to set
            });
        });

        // Convert Sets to Arrays for easier rendering later
        Object.keys(hTree).forEach(t => {
            Object.keys(hTree[t]).forEach(s => {
                Object.keys(hTree[t][s]).forEach(l => {
                    hTree[t][s][l] = Array.from(hTree[t][s][l]).sort();
                });
            });
        });

        State.allQuestions = qArr;
        State.tree = hTree;
    }

    /** 
     * ===============================================
     * VIEW MANAGEMENT 
     * ===============================================
     */
    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('fab-next').style.display = 'none'; // Default hidden
        window.scrollTo(0,0);
        
        // Tab Bar Highlight
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(id === 'v-leader') document.querySelectorAll('.tab-btn')[1].classList.add('active');
        else document.querySelectorAll('.tab-btn')[0].classList.add('active');
    }

    function goHome() {
        // Reset navigation state
        State.currentTerm = null;
        State.currentSubject = null;
        State.selectedLessons = [];
        State.selectedChapters = [];
        State.isMistakeMode = false;
        
        switchView('v-home');
        updateScoreBadge();
    }

    /** 
     * ===============================================
     * NAVIGATION LOGIC (THE 4 LEVELS)
     * ===============================================
     */
    
    // LEVEL 1: NEW SESSION -> TERMS
    function startNewSession() {
        switchView('v-terms');
        const container = document.getElementById('container-terms');
        container.innerHTML = '';

        Object.keys(State.tree).forEach(termName => {
            const card = document.createElement('div');
            card.className = 'nav-block';
            card.onclick = () => { State.currentTerm = termName; renderSubjectsView(); };
            card.innerHTML = `
                <div class="nav-block-content">
                    <div class="block-icon">ğŸ“…</div>
                    <div style="font-weight:700">${termName}</div>
                </div>
                <div style="color:var(--text-secondary)">â¬…ï¸</div>
            `;
            container.appendChild(card);
        });
    }

    // LEVEL 2: SUBJECTS
    function renderSubjectsView() {
        switchView('v-subjects');
        const container = document.getElementById('container-subjects');
        container.innerHTML = '';
        const subjects = State.tree[State.currentTerm];

        Object.keys(subjects).forEach(subName => {
            const card = document.createElement('div');
            card.className = 'nav-block';
            card.onclick = () => { State.currentSubject = subName; State.selectedLessons = []; renderLessonsView(); };
            card.innerHTML = `
                <div class="nav-block-content">
                    <div class="block-icon">ğŸ“˜</div>
                    <div style="font-weight:700">${subName}</div>
                </div>
                <div style="color:var(--text-secondary)">â¬…ï¸</div>
            `;
            container.appendChild(card);
        });
    }

    function backToSubjects() { renderSubjectsView(); }

    // LEVEL 3: LESSONS (CHECKBOX LIST)
    function renderLessonsView() {
        switchView('v-lessons');
        const container = document.getElementById('container-lessons');
        container.innerHTML = '';
        
        const term = State.currentTerm;
        const subj = State.currentSubject;
        // Access Object where Keys are Lesson Names
        const lessonsMap = State.tree[term][subj];
        const lessonNames = Object.keys(lessonsMap);

        if(lessonNames.length === 0) { container.innerHTML = "<p>ÙØ§Ø±Øº</p>"; return; }

        lessonNames.forEach(lsnName => {
            const isSelected = State.selectedLessons.includes(lsnName);
            const div = document.createElement('div');
            div.className = `check-item ${isSelected ? 'selected' : ''}`;
            // Handle row click
            div.onclick = (e) => { 
                // toggle logic logic is simpler if we just toggle
                toggleLessonSelect(lsnName); 
            };

            div.innerHTML = `
                <div class="custom-checkbox"></div>
                <div>
                    <div style="font-weight:600">${lsnName}</div>
                    <div style="font-size:0.85em;color:var(--text-secondary)">${lessonsMap[lsnName].length} Ù…ÙˆØ§Ø¶ÙŠØ¹ ÙØ±Ø¹ÙŠØ©</div>
                </div>
            `;
            container.appendChild(div);
        });
        
        updateLessonsFab();
    }

    function toggleLessonSelect(lName) {
        if(State.selectedLessons.includes(lName)) {
            State.selectedLessons = State.selectedLessons.filter(x => x !== lName);
        } else {
            State.selectedLessons.push(lName);
        }
        renderLessonsView(); // Re-render for visual update (easier than manipulating DOM directly)
    }

    function toggleAllVisibleLessons() {
        const term = State.currentTerm;
        const subj = State.currentSubject;
        const allLessonNames = Object.keys(State.tree[term][subj]);
        
        // Logic: If all are selected, deselect all. Otherwise, select all.
        const allSelected = allLessonNames.every(l => State.selectedLessons.includes(l));
        
        if(allSelected) {
            State.selectedLessons = [];
        } else {
            State.selectedLessons = [...allLessonNames];
        }
        renderLessonsView();
    }

    function updateLessonsFab() {
        const fab = document.getElementById('fab-next');
        const count = State.selectedLessons.length;
        if(count > 0) {
            fab.style.display = 'block';
            fab.innerText = `Ø§Ù„ØªØ§Ù„ÙŠ (${count}) â¬…ï¸`;
            fab.onclick = () => renderChaptersView();
        } else {
            fab.style.display = 'none';
        }
    }

    // LEVEL 4: CHAPTERS (NESTED SELECTION)
    function renderChaptersView() {
        switchView('v-chapters');
        const container = document.getElementById('container-chapters');
        container.innerHTML = '';

        const term = State.currentTerm;
        const subj = State.currentSubject;
        
        // Iterate only Selected Lessons
        State.selectedLessons.forEach(lName => {
            // Header for Group
            const header = document.createElement('div');
            header.className = 'group-header';
            header.innerText = `ğŸ“‚ Ø¯Ø±Ø³: ${lName}`;
            container.appendChild(header);

            // Get Chapters List (Array of strings)
            const chaptersList = State.tree[term][subj][lName];
            
            // Render Items
            chaptersList.forEach(cName => {
                // Construct ID
                const uniqueKey = `${term}|${subj}|${lName}|${cName}`;
                
                // IMPORTANT: Default Logic
                // If this is the FIRST TIME rendering chapters for this session (and user picked lessons), 
                // we probably want them ALL selected by default?
                // For V7 implementation: To implement "Select All by Default", we can verify:
                // Is this uniqueKey inside State.selectedChapters? 
                // If State.selectedChapters is EMPTY at start, fill it? No, preserving user choice is better.
                // Simple Approach: Default unselected, but allow "Select All"
                
                // OPTIMIZED UX: Users usually want Everything in the lesson unless excluded.
                // Let's modify behavior: The moment we transition from Lessons -> Chapters,
                // Any chapter belonging to selected lessons that is NOT EXPLICITLY UNSELECTED should be added?
                // Let's stick to explicit Checkbox management for robustness.
                
                // Check if selected
                const isSelected = State.selectedChapters.includes(uniqueKey);
                
                const div = document.createElement('div');
                div.className = `check-item ${isSelected?'selected':''}`;
                div.onclick = () => toggleChapterSelect(uniqueKey);
                
                div.innerHTML = `
                   <div class="custom-checkbox"></div>
                   <div style="font-weight:500">${cName}</div>
                `;
                container.appendChild(div);
            });
            
            // "Select All In This Lesson" shortcut
            const bulkBtn = document.createElement('div');
            bulkBtn.style = "padding:5px 10px; font-size:0.8rem; color:var(--primary-color); cursor:pointer; margin-bottom:15px";
            bulkBtn.innerText = "âš¡ ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ ÙƒÙ„ Ù…ÙˆØ§Ø¶ÙŠØ¹ Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³";
            bulkBtn.onclick = () => bulkToggleChapters(lName, chaptersList);
            container.appendChild(bulkBtn);
        });
        
        updateChaptersFab();
    }
    
    function bulkToggleChapters(lessonName, chaptersList) {
        const term = State.currentTerm;
        const subj = State.currentSubject;
        
        // Generate Keys
        const keys = chaptersList.map(c => `${term}|${subj}|${lessonName}|${c}`);
        
        // Check if all active
        const allActive = keys.every(k => State.selectedChapters.includes(k));
        
        if(allActive) {
            State.selectedChapters = State.selectedChapters.filter(k => !keys.includes(k));
        } else {
            // Add missing
            keys.forEach(k => {
                if(!State.selectedChapters.includes(k)) State.selectedChapters.push(k);
            });
        }
        renderChaptersView();
    }

    function toggleChapterSelect(uKey) {
        if(State.selectedChapters.includes(uKey)) {
            State.selectedChapters = State.selectedChapters.filter(k => k !== uKey);
        } else {
            State.selectedChapters.push(uKey);
        }
        renderChaptersView();
    }

    function updateChaptersFab() {
        const fab = document.getElementById('fab-next');
        const count = State.selectedChapters.length;
        if(count > 0) {
            fab.style.display = 'block';
            fab.innerText = `Ø¥Ù†Ù‡Ø§Ø¡: ØªÙƒÙˆÙŠÙ† (${count}) âœ…`;
            fab.onclick = goToSetup; // Next Step
        } else {
            fab.style.display = 'none';
        }
    }

    /** 
     * ===============================================
     * QUIZ CONFIGURATION 
     * ===============================================
     */
    function backToChapters() {
        if(State.isMistakeMode) goHome();
        else renderChaptersView();
    }
    
    function backFromSetup() {
        if(State.isMistakeMode) goHome();
        else renderChaptersView();
    }

    function startMistakesMode() {
        // Find wrongs
        const wrongs = State.allQuestions.filter(q => State.userProgress[q.id] === 'wrong');
        
        if(wrongs.length === 0) { alert("Ø£Ø­Ø³Ù†Øª! Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø£Ø®Ø·Ø§Ø¡."); return; }
        
        State.isMistakeMode = true;
        
        // Send directly to Setup, bypassing selections
        // But store these qs in a temp hold
        State.activeQueue = wrongs; 
        
        goToSetup();
        document.getElementById('txt-selection-summary').innerText = "ÙˆØ¶Ø¹ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„";
        // Override Mode chip to Mistakes only
        setMode('mistake', document.querySelectorAll('#grp-mode .choice-chip')[1]);
    }

    function goToSetup() {
        switchView('v-setup');
        
        if(!State.isMistakeMode) {
             document.getElementById('txt-selection-summary').innerText = `${State.selectedChapters.length} ÙØµÙ„/Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø­Ø¯Ø¯`;
        }
        document.getElementById('msg-error').style.display = 'none';
    }

    // Setters
    window.setMode = (m, el) => {
        State.settings.mode = m;
        document.querySelectorAll('#grp-mode .choice-chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    };
    window.setQty = (q, el) => {
        State.settings.qty = q;
        document.querySelectorAll('#grp-qty .choice-chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    };

    /** 
     * ===============================================
     * QUIZ ENGINE 
     * ===============================================
     */
    function startQuizEngine() {
        let pool = [];

        if(State.isMistakeMode) {
            pool = State.activeQueue; // These are all wrongs
        } else {
            // Filter global questions list by selected chapter keys
            pool = State.allQuestions.filter(q => State.selectedChapters.includes(q._hierarchyKey));
        }

        // Apply filters (Mode)
        const m = State.settings.mode;
        if(m === 'new') pool = pool.filter(q => State.userProgress[q.id] !== 'correct');
        else if(m === 'mistake') pool = pool.filter(q => State.userProgress[q.id] === 'wrong');
        
        if(pool.length === 0) {
            document.getElementById('msg-error').style.display='block';
            return;
        }

        // Randomize
        pool.sort(() => Math.random() - 0.5);
        // Cut to Qty
        State.activeQueue = pool.slice(0, State.settings.qty);
        State.activeIdx = 0;
        
        State.isMistakeMode = false; // Reset flag
        renderQuizCard();
    }

    function renderQuizCard() {
        switchView('v-quiz');
        const Q = State.activeQueue[State.activeIdx];
        
        // Header Info
        document.getElementById('txt-q-progress').innerText = `Ø§Ù„Ø³Ø¤Ø§Ù„: ${State.activeIdx+1} / ${State.activeQueue.length}`;
        document.getElementById('txt-q-id').innerText = `ID: ${Q.id}`;

        const box = document.getElementById('quiz-area');
        let html = '';

        if(Q.image) html += `<img src="${Q.image}" class="quiz-image">`;
        html += `<div class="question-txt">${Q.question}</div>`;
        html += `<div id="opts-wrap"></div>`; // Options go here
        
        // Explanation Box (Hidden)
        html += `<div id="expl" class="explanation-box"></div>`;
        
        // Next Button (Hidden)
        html += `<button id="btn-next" onclick="nextQuestion()" class="btn-block" style="display:none; margin-top:20px; background:var(--text-primary)">Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸</button>`;

        box.innerHTML = html;

        if(Q.type === 'matching') {
            // Handle Unsupported Type gracefully
             box.innerHTML += "<p style='text-align:center; color:red'>Ø³Ø¤Ø§Ù„ ØªÙˆØµÙŠÙ„ - ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙØŒ ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ.</p>";
             document.getElementById('btn-next').style.display='block';
             return;
        }

        // Generate Option Cards
        const optCont = document.getElementById('opts-wrap');
        Q.options.forEach((txt, i) => {
             const div = document.createElement('div');
             div.className = 'option-card';
             div.innerText = txt;
             div.onclick = () => handleAnswer(i, Q, div);
             optCont.appendChild(div);
        });
        
        window.scrollTo(0,0);
    }

    function handleAnswer(selectedIdx, Q, cardEl) {
        if(cardEl.parentElement.classList.contains('locked')) return;
        cardEl.parentElement.classList.add('locked'); // Lock answers

        const isCorrect = (selectedIdx === Q.correct_option_id);
        const status = isCorrect ? 'correct' : 'wrong';

        // Styling
        if(isCorrect) {
            cardEl.classList.add('correct');
        } else {
            cardEl.classList.add('wrong');
            // Highlight right one
            cardEl.parentElement.children[Q.correct_option_id].classList.add('correct');
        }

        // Show Explanation
        if(Q.explanation) {
             const exp = document.getElementById('expl');
             exp.innerHTML = `<strong>ğŸ’¡ ØªÙˆØ¶ÙŠØ­:</strong><br>${Q.explanation}`;
             exp.style.display = 'block';
        }

        // Show Next
        document.getElementById('btn-next').style.display = 'block';

        // SYNC DATA
        State.userProgress[Q.id] = status;
        
        // Save to Firebase
        if(DB && UserID !== 'guest_v7') {
             // 1. Update Progress Map
             DB.ref(`users/${UserID}/progress/${Q.id}`).set(status);
             // 2. If Correct, atomic Increment score
             if(isCorrect) {
                 DB.ref(`users/${UserID}/score`).transaction(count => (count||0) + 1);
             }
             // 3. Save Name (Optional, good for leaderboard)
             if(TG.initDataUnsafe?.user?.first_name) {
                 DB.ref(`users/${UserID}/name`).set(TG.initDataUnsafe.user.first_name);
             }
        }
        
        updateScoreBadge();
    }

    function nextQuestion() {
        if(State.activeIdx < State.activeQueue.length - 1) {
            State.activeIdx++;
            renderQuizCard();
        } else {
            alert("ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰");
            goHome();
        }
    }
    
    function confirmEndQuiz() {
        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ.")) goHome();
    }

    function updateScoreBadge() {
        const correctCnt = Object.values(State.userProgress).filter(x => x==='correct').length;
        document.getElementById('lbl-score').innerText = correctCnt;
    }

    /** 
     * ===============================================
     * LEADERBOARD 
     * ===============================================
     */
    function openLeaderboard() {
        switchView('v-leader');
        const list = document.getElementById('container-leaderboard');
        list.innerHTML = `<div style="text-align:center; padding:30px">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</div>`;

        if(!DB) { list.innerHTML="<p align='center'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„</p>"; return; }

        DB.ref('users').orderByChild('score').limitToLast(30).once('value')
        .then(snap => {
            let data = [];
            snap.forEach(row => {
                 data.push({
                     name: row.val().name || 'Ù…Ø³ØªØ®Ø¯Ù…',
                     score: row.val().score || 0,
                     isMe: row.key === UserID
                 });
            });
            // Reverse (Desc)
            data.sort((a,b) => b.score - a.score);

            if(data.length===0) { list.innerHTML = "<p align='center' style='padding:20px'>ÙƒÙ† Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©!</p>"; return; }

            let html = "";
            data.forEach((u, i) => {
                 const badge = i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰': `#${i+1}`;
                 html += `
                    <div class="rank-item ${u.isMe?'rank-hl':''}">
                        <div><span style="display:inline-block;width:30px">${badge}</span> ${u.name} ${u.isMe?'(Ø£Ù†Øª)':''}</div>
                        <div style="font-weight:700">${u.score}</div>
                    </div>
                 `;
            });
            list.innerHTML = html;
        })
        .catch(err => {
            console.error(err);
            list.innerHTML = `<p style='text-align:center; color:red; padding:20px'>ÙŠØ¬Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Rules)</p>`;
        });
    }

</script>
</body>
</html>
