<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Bot Elite V8</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* --- THEMES & VARIABLES --- */
        :root {
            --primary: #3b82f6;
            --primary-bg: #eff6ff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --success: #22c55e;
            --danger: #ef4444;
            --radius: 14px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            --font-size: 16px;
        }

        /* Themes */
        body.theme-dark {
            --primary: #60a5fa;
            --primary-bg: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --border: #334155;
        }

        body.theme-warm {
            --primary: #d97706;
            --primary-bg: #fffbeb;
            --bg-body: #fdf6e3;
            --bg-card: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 100px; /* Space for floating footer */
            font-size: var(--font-size);
            transition: background 0.3s, color 0.3s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- LAYOUT --- */
        .app-header {
            background: var(--bg-card); padding: 15px; position: sticky; top: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); box-shadow: var(--shadow);
        }
        
        .view-container { display: none; padding: 15px; max-width: 700px; margin: 0 auto; animation: fadeUp 0.25s ease-out; }
        .view-container.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS & LISTS --- */
        .nav-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 18px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: transform 0.1s;
        }
        .nav-card:active { transform: scale(0.98); background: var(--primary-bg); }
        
        .card-info h3 { margin: 0 0 5px 0; font-size: 1.1em; }
        .card-info span { font-size: 0.85em; color: var(--text-sub); background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 10px; }

        /* --- SELECTION ROWS --- */
        .check-row {
            background: var(--bg-card); padding: 15px; border-radius: var(--radius);
            margin-bottom: 8px; border: 2px solid transparent; box-shadow: var(--shadow);
            display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s;
        }
        .check-row.checked { border-color: var(--primary); background: var(--primary-bg); }
        
        .custom-chk {
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--text-sub);
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .check-row.checked .custom-chk { background: var(--primary); border-color: var(--primary); color: white; }
        .custom-chk::after { content: '‚úî'; font-size: 14px; display: none; }
        .check-row.checked .custom-chk::after { display: block; }

        /* --- FLOATING FOOTER (Key Requirement) --- */
        .floating-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-card); padding: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid var(--border);
        }
        .btn-action {
            background: var(--primary); color: white; border: none;
            padding: 12px 25px; border-radius: 50px; font-weight: bold; font-size: 1em;
            cursor: pointer; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: 0.2s;
        }
        .btn-action:active { transform: translateY(2px); }

        /* --- SELECT ALL BUTTON --- */
        .select-all-btn {
            background: var(--bg-card); border: 2px solid var(--border); color: var(--text-main);
            padding: 12px; border-radius: var(--radius); margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        .select-all-btn.active {
            background: var(--primary); color: white; border-color: var(--primary);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); /* Glowing effect */
        }

        /* --- SETTINGS MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: var(--bg-card); width: 90%; max-width: 400px;
            border-radius: var(--radius); padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .setting-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); cursor: pointer; }
        .setting-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- QUIZ --- */
        .q-meta-tag { font-size: 0.75em; background: var(--border); padding: 3px 8px; border-radius: 4px; color: var(--text-main); margin-left: 8px; }
        .opt-btn { background: var(--bg-card); padding: 15px; margin-bottom: 10px; border-radius: 10px; border: 2px solid transparent; cursor: pointer; width: 100%; text-align: start; color: var(--text-main); box-shadow: var(--shadow); }
        .opt-btn.correct { background: #dcfce7; border-color: var(--success); color: #000; }
        .opt-btn.wrong { background: #fee2e2; border-color: var(--danger); color: #000; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .breadcrumb { font-size: 0.85em; color: var(--text-sub); margin-bottom: 10px; display: flex; overflow-x: auto; white-space: nowrap; gap: 5px; }
        .bc-item { color: var(--primary); cursor: pointer; }
        
        #loader { position: fixed; inset: 0; background: var(--bg-body); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ccc; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:15px" data-key="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>
    </div>

    <!-- HEADER -->
    <header class="app-header">
        <div style="display:flex;align-items:center;gap:10px">
            <span style="font-weight:900; font-size:1.2em">Elite Bot</span>
            <span class="q-meta-tag">V8</span>
        </div>
        <div>
            <button onclick="toggleSettings()" style="background:none;border:none;font-size:1.5em;cursor:pointer">‚öôÔ∏è</button>
        </div>
    </header>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="modal-overlay" onclick="if(event.target===this) toggleSettings()">
        <div class="modal-box">
            <h3 data-key="settings_title">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</h3>
            
            <div class="setting-row">
                <span data-key="lang">ÿßŸÑŸÑÿ∫ÿ©</span>
                <div>
                    <button class="setting-btn" id="btn-lang-ar" onclick="setLang('ar')">ÿπÿ±ÿ®Ÿä</button>
                    <button class="setting-btn" id="btn-lang-en" onclick="setLang('en')">Eng</button>
                </div>
            </div>

            <div class="setting-row">
                <span data-key="theme">ÿßŸÑŸÖÿ∏Ÿáÿ±</span>
                <div>
                    <button class="setting-btn" onclick="setTheme('light')">‚òÄÔ∏è</button>
                    <button class="setting-btn" onclick="setTheme('dark')">üåë</button>
                    <button class="setting-btn" onclick="setTheme('warm')">‚òï</button>
                </div>
            </div>

            <div class="setting-row">
                <span data-key="fontsize">ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑</span>
                <div>
                    <button class="setting-btn" onclick="setFont(14)">A-</button>
                    <button class="setting-btn" onclick="setFont(16)">A</button>
                    <button class="setting-btn" onclick="setFont(18)">A+</button>
                </div>
            </div>

            <button class="btn-action" onclick="toggleSettings()" data-key="close">ÿ•ÿ∫ŸÑÿßŸÇ</button>
        </div>
    </div>

    <!-- VIEW 1: TERMS (HOME) -->
    <div id="view-terms" class="view-container active">
        <h2 data-key="select_term">ÿ£Ÿä ÿ™ÿ±ŸÖ ÿØÿ±ÿßÿ≥Ÿäÿü</h2>
        <div id="list-terms"></div>
    </div>

    <!-- VIEW 2: SUBJECTS -->
    <div id="view-subjects" class="view-container">
        <div class="breadcrumb">
            <span class="bc-item" onclick="goHome()" data-key="home">ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span> / <span id="bc-term"></span>
        </div>
        <h2 data-key="select_subject">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿßÿØÿ©:</h2>
        <div id="list-subjects"></div>
    </div>

    <!-- VIEW 3: LESSONS (Multi-Select) -->
    <div id="view-lessons" class="view-container">
        <div class="breadcrumb">... / <span class="bc-item" onclick="backToSubjects()">ÿßŸÑŸÖÿßÿØÿ©</span> / <span data-key="lessons">ÿßŸÑÿØÿ±Ÿàÿ≥</span></div>
        
        <div class="select-all-btn" id="btn-all-lessons" onclick="toggleAllLessons()">
            <span class="custom-chk"></span> <span data-key="select_all">ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ</span>
        </div>

        <div id="list-lessons"></div>
    </div>

    <!-- VIEW 4: CHAPTERS (Grouped) -->
    <div id="view-chapters" class="view-container">
        <div class="breadcrumb">... / <span class="bc-item" onclick="renderLessons()">ÿßŸÑÿØÿ±Ÿàÿ≥</span> / <span data-key="chapters">ÿßŸÑŸÅÿµŸàŸÑ</span></div>
        
        <h3 style="margin-top:0"><span data-key="refine_selection">ÿØŸÇÿ© ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±</span> (<span id="total-q-count">0</span> <span data-key="qs">ÿ≥ÿ§ÿßŸÑ</span>)</h3>

        <!-- Prominent Select All Button -->
        <div class="select-all-btn" id="btn-all-chapters" onclick="toggleAllChapters()">
            <span class="custom-chk"></span> <span data-key="select_all_chapters">ÿ™ÿ≠ÿØŸäÿØ ŸÉŸÑ ÿßŸÑÿ¥ÿ®ÿßÿ™ÿ± ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ÿ©</span>
        </div>

        <div id="list-chapters"></div>
    </div>

    <!-- VIEW 5: QUIZ -->
    <div id="view-quiz" class="view-container">
        <div style="display:flex;justify-content:space-between;margin-bottom:15px;font-size:0.9em;color:var(--text-sub)">
            <span><span data-key="question">ÿ≥ÿ§ÿßŸÑ</span> <span id="q-idx">1</span> / <span id="q-total">10</span></span>
            <span onclick="confirmExit()" style="color:var(--danger);cursor:pointer;font-weight:bold" data-key="exit">ÿÆÿ±Ÿàÿ¨</span>
        </div>

        <div id="q-content"></div>
    </div>

    <!-- FLOATING FOOTER (Navigation Actions) -->
    <div id="floating-footer" class="floating-footer hidden">
        <div style="font-size:0.9em">
            <span data-key="selected">ŸÖÿ≠ÿØÿØ:</span> <b id="footer-count">0</b>
        </div>
        <button id="footer-btn" class="btn-action" style="width:auto; min-width:120px">ÿßŸÑÿ™ÿßŸÑŸä ‚¨ÖÔ∏è</button>
    </div>

<script>
    /* --- CONFIG --- */
    const CONFIG = {
        firebase: {
            apiKey: "AIzaSyDEZFJmcXK2LxYAZ-Yjv_M1HbC6zi_qilg",
            authDomain: "exambotdb.firebaseapp.com",
            databaseURL: "https://exambotdb-default-rtdb.firebaseio.com",
            projectId: "exambotdb",
            storageBucket: "exambotdb.firebasestorage.app",
            messagingSenderId: "950600562980",
            appId: "1:950600562980:web:f993c22d45e5cfdd3d9bb1"            
        }
    };

    /* --- LOCALIZATION --- */
    const TEXTS = {
        ar: {
            loading: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...",
            select_term: "ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿ±ŸÖ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä:",
            select_subject: "ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿßÿØÿ©:",
            home: "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
            lessons: "ÿßŸÑÿØÿ±Ÿàÿ≥",
            chapters: "ÿßŸÑŸÅÿµŸàŸÑ",
            select_all: "ÿ™ÿ≠ÿØŸäÿØ / ÿ•ŸÑÿ∫ÿßÿ° ŸÉŸÑ ÿßŸÑÿØÿ±Ÿàÿ≥",
            select_all_chapters: "ÿ™ÿ≠ÿØŸäÿØ / ÿ•ŸÑÿ∫ÿßÿ° ŸÉŸÑ ÿßŸÑÿ¥ÿ®ÿßÿ™ÿ±",
            refine_selection: "ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÅÿµŸàŸÑ",
            qs: "ÿ≥ÿ§ÿßŸÑ",
            question: "ÿ≥ÿ§ÿßŸÑ",
            exit: "ÿ•ŸÜŸáÿßÿ°",
            selected: "ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ:",
            next: "ÿßŸÑÿ™ÿßŸÑŸä ‚¨ÖÔ∏è",
            start: "ÿ®ÿØÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± üöÄ",
            settings_title: "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™",
            lang: "ÿßŸÑŸÑÿ∫ÿ©",
            theme: "ÿßŸÑŸÖÿ∏Ÿáÿ±",
            fontsize: "ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ∑",
            close: "ÿ•ÿ∫ŸÑÿßŸÇ",
            no_data: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™",
            correct: "ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©",
            wrong: "ÿ•ÿ¨ÿßÿ®ÿ© ÿÆÿßÿ∑ÿ¶ÿ©",
            explanation: "ÿßŸÑÿ¥ÿ±ÿ≠",
            id: "ŸÉŸàÿØ"
        },
        en: {
            loading: "Loading Data...",
            select_term: "Select Term:",
            select_subject: "Select Subject:",
            home: "Home",
            lessons: "Lessons",
            chapters: "Chapters",
            select_all: "Select / Deselect All Lessons",
            select_all_chapters: "Select / Deselect All Chapters",
            refine_selection: "Refine Chapters",
            qs: "Qs",
            question: "Q",
            exit: "Exit",
            selected: "Selected:",
            next: "Next ‚û°Ô∏è",
            start: "Start Quiz üöÄ",
            settings_title: "Settings",
            lang: "Language",
            theme: "Theme",
            fontsize: "Font Size",
            close: "Close",
            no_data: "No Data",
            correct: "Correct",
            wrong: "Wrong",
            explanation: "Explanation",
            id: "ID"
        }
    };

    /* --- STATE --- */
    const App = {
        data: [], // Flat list
        tree: {}, // Hierarchy: Tree[Term][Subj][Lesson][Chapter] = [QIDs]
        metaCounts: {}, // Cache for counts
        
        selection: { term: null, subject: null, lessons: [], chapters: [] },
        
        quiz: { queue: [], index: 0 },
        
        settings: { lang: 'ar', theme: 'light', font: 16 }
    };

    const TG = window.Telegram.WebApp;

    /* --- INIT --- */
    window.onload = async () => {
        TG.ready(); TG.expand();
        
        // Load Settings
        const saved = localStorage.getItem('elite_settings');
        if(saved) App.settings = JSON.parse(saved);
        applySettings();

        // Firebase
        if(window.firebase && !firebase.apps.length) {
            try { firebase.initializeApp(CONFIG.firebase); } catch(e){}
        }

        await loadData();
    };

    async function loadData() {
        try {
            const list = await fetch('questions_list.json?t='+Date.now()).then(r=>r.json());
            const jobs = list.map(f => fetch('Questions/'+f).then(r=>r.json()));
            const files = await Promise.all(jobs);

            processFiles(files);
            
            document.getElementById('loader').classList.add('hidden');
            renderTerms();
        } catch(e) {
            alert("Error loading data: " + e.message);
        }
    }

    function processFiles(files) {
        // Build Tree: Term -> Subject -> Lesson -> Chapter -> Array[Q]
        let tree = {};
        let qList = [];

        files.forEach(f => {
            const meta = f.meta || {};
            const term = meta.source || "General";
            const subj = meta.subject || "General";
            const lsn  = meta.lesson || "Misc";

            f.questions.forEach(q => {
                const chap = q.chapter || "General";
                const qObj = { ...q, _meta: { term, subj, lsn, chap } };
                qList.push(qObj);

                if(!tree[term]) tree[term] = {};
                if(!tree[term][subj]) tree[term][subj] = {};
                if(!tree[term][subj][lsn]) tree[term][subj][lsn] = {};
                if(!tree[term][subj][lsn][chap]) tree[term][subj][lsn][chap] = [];
                
                tree[term][subj][lsn][chap].push(qObj);
            });
        });
        
        App.tree = tree;
        App.data = qList;
    }

    /* --- HELPER: COUNTS --- */
    function getCount(node) {
        // Recursively count questions in a node (object or array)
        if(Array.isArray(node)) return node.length;
        let sum = 0;
        Object.values(node).forEach(child => sum += getCount(child));
        return sum;
    }

    /* --- NAVIGATION & RENDERING --- */

    function switchView(id) {
        document.querySelectorAll('.view-container').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('floating-footer').classList.add('hidden');
        window.scrollTo(0,0);
    }

    /* 1. TERMS */
    function renderTerms() {
        switchView('view-terms');
        const c = document.getElementById('list-terms');
        c.innerHTML = '';
        
        Object.keys(App.tree).forEach(term => {
            const count = getCount(App.tree[term]);
            const div = document.createElement('div');
            div.className = 'nav-card';
            div.onclick = () => selectTerm(term);
            div.innerHTML = `
                <div class="card-info">
                    <h3>${term}</h3>
                    <span>${count} ${txt('qs')}</span>
                </div>
                <div>‚¨ÖÔ∏è</div>
            `;
            c.appendChild(div);
        });
    }

    function selectTerm(t) {
        App.selection.term = t;
        renderSubjects();
    }

    /* 2. SUBJECTS */
    function renderSubjects() {
        switchView('view-subjects');
        document.getElementById('bc-term').innerText = App.selection.term;
        const c = document.getElementById('list-subjects');
        c.innerHTML = '';

        const subjects = App.tree[App.selection.term];
        Object.keys(subjects).forEach(subj => {
            const count = getCount(subjects[subj]);
            const div = document.createElement('div');
            div.className = 'nav-card';
            div.onclick = () => selectSubject(subj);
            div.innerHTML = `
                <div class="card-info">
                    <h3>${subj}</h3>
                    <span>${count} ${txt('qs')}</span>
                </div>
                <div>‚¨ÖÔ∏è</div>
            `;
            c.appendChild(div);
        });
    }

    function selectSubject(s) {
        App.selection.subject = s;
        App.selection.lessons = []; // Reset
        renderLessons();
    }
    
    function backToSubjects() { renderSubjects(); }

    /* 3. LESSONS (CHECKBOXES) */
    function renderLessons() {
        switchView('view-lessons');
        const t = App.selection.term;
        const s = App.selection.subject;
        const lessons = App.tree[t][s];
        const container = document.getElementById('list-lessons');
        container.innerHTML = '';

        Object.keys(lessons).forEach(lName => {
            const count = getCount(lessons[lName]);
            const isSel = App.selection.lessons.includes(lName);
            
            const div = document.createElement('div');
            div.className = `check-row ${isSel ? 'checked' : ''}`;
            div.onclick = () => toggleLesson(lName);
            div.innerHTML = `
                <div class="custom-chk"></div>
                <div style="flex-grow:1">
                    <div style="font-weight:600">${lName}</div>
                    <div style="font-size:0.85em;color:var(--text-sub)">${count} ${txt('qs')}</div>
                </div>
            `;
            container.appendChild(div);
        });

        updateLessonUI();
    }

    function toggleLesson(l) {
        if(App.selection.lessons.includes(l)) {
            App.selection.lessons = App.selection.lessons.filter(x => x !== l);
        } else {
            App.selection.lessons.push(l);
        }
        renderLessons(); // Re-render to update classes
    }

    function toggleAllLessons() {
        const all = Object.keys(App.tree[App.selection.term][App.selection.subject]);
        const isFull = all.every(l => App.selection.lessons.includes(l));
        
        if(isFull) App.selection.lessons = [];
        else App.selection.lessons = [...all];
        
        renderLessons();
    }

    function updateLessonUI() {
        // Sync "Select All" Button
        const all = Object.keys(App.tree[App.selection.term][App.selection.subject]);
        const btn = document.getElementById('btn-all-lessons');
        const isFull = all.length > 0 && all.every(l => App.selection.lessons.includes(l));
        
        if(isFull) btn.classList.add('active'); else btn.classList.remove('active');

        // Footer
        const count = App.selection.lessons.length;
        const foot = document.getElementById('floating-footer');
        const fBtn = document.getElementById('footer-btn');
        
        if(count > 0) {
            foot.classList.remove('hidden');
            document.getElementById('footer-count').innerText = count;
            fBtn.innerText = txt('next');
            fBtn.onclick = renderChapters;
        } else {
            foot.classList.add('hidden');
        }
    }

    /* 4. CHAPTERS (NESTED CHECKBOXES) */
    function renderChapters() {
        // On entry, default select ALL chapters of the chosen lessons if not already set
        // Strategy: Build a list of all available chapter Keys (Lesson|Chapter)
        // If selection.chapters is empty or mismatches context, reset.
        
        // Simple logic: Always pre-select ALL chapters from the selected lessons,
        // unless the user unchecks them. To keep it simple, we rebuild the list.
        // Or better: We only track UNSELECTED chapters? No, tracking Selected is safer.
        
        // Let's generate the valid keys for current view
        const t = App.selection.term;
        const s = App.selection.subject;
        let availableChapters = []; // Objects { lesson, chap, count, key }
        
        App.selection.lessons.forEach(l => {
            const chaps = App.tree[t][s][l];
            Object.keys(chaps).forEach(c => {
                availableChapters.push({ 
                    l, c, 
                    count: chaps[c].length, 
                    key: `${l}|${c}` 
                });
            });
        });

        // Initialize selection if coming forward (naive check: if empty)
        // Better: Ensure App.selection.chapters contains valid items.
        // For V8: Let's Auto-Select ALL initially.
        if(App.selection.chapters.length === 0) {
            App.selection.chapters = availableChapters.map(x => x.key);
        }

        switchView('view-chapters');
        const cList = document.getElementById('list-chapters');
        cList.innerHTML = '';
        
        // Group by Lesson
        App.selection.lessons.forEach(lName => {
            const header = document.createElement('h4');
            header.style.cssText = "margin:15px 0 5px; color:var(--primary); border-bottom:1px solid var(--border)";
            header.innerText = `üìÇ ${lName}`;
            cList.appendChild(header);

            const lessonChaps = availableChapters.filter(x => x.l === lName);
            
            lessonChaps.forEach(item => {
                const isSel = App.selection.chapters.includes(item.key);
                const row = document.createElement('div');
                row.className = `check-row ${isSel?'checked':''}`;
                row.onclick = () => toggleChapter(item.key);
                row.innerHTML = `
                    <div class="custom-chk"></div>
                    <div style="flex-grow:1">
                        <div style="font-weight:600">${item.c}</div>
                        <div style="font-size:0.85em;color:var(--text-sub)">${item.count} ${txt('qs')}</div>
                    </div>
                `;
                cList.appendChild(row);
            });
        });

        updateChapterUI(availableChapters);
    }

    function toggleChapter(key) {
        if(App.selection.chapters.includes(key)) {
            App.selection.chapters = App.selection.chapters.filter(k => k !== key);
        } else {
            App.selection.chapters.push(key);
        }
        // Hack to re-render without full rebuild? No, just re-render is safer for UI sync
        // But we need to pass availableChapters. Let's make it global or re-calc.
        // Re-calc is fast enough.
        renderChapters(); 
    }

    function toggleAllChapters() {
        // Get all keys in current context
        const t = App.selection.term;
        const s = App.selection.subject;
        let allKeys = [];
        App.selection.lessons.forEach(l => {
            Object.keys(App.tree[t][s][l]).forEach(c => allKeys.push(`${l}|${c}`));
        });

        const isFull = allKeys.every(k => App.selection.chapters.includes(k));
        
        if(isFull) App.selection.chapters = [];
        else App.selection.chapters = [...allKeys];

        renderChapters();
    }

    function updateChapterUI(available) {
        // Select All Button
        const allKeys = available.map(x => x.key);
        const isFull = allKeys.length > 0 && allKeys.every(k => App.selection.chapters.includes(k));
        const btnAll = document.getElementById('btn-all-chapters');
        
        if(isFull) btnAll.classList.add('active'); else btnAll.classList.remove('active');

        // Stats
        let totalQs = 0;
        available.forEach(x => {
            if(App.selection.chapters.includes(x.key)) totalQs += x.count;
        });
        document.getElementById('total-q-count').innerText = totalQs;

        // Footer
        const count = App.selection.chapters.length;
        const foot = document.getElementById('floating-footer');
        const fBtn = document.getElementById('footer-btn');

        if(count > 0 && totalQs > 0) {
            foot.classList.remove('hidden');
            document.getElementById('footer-count').innerText = count;
            fBtn.innerText = txt('start');
            fBtn.onclick = startQuiz;
        } else {
            foot.classList.add('hidden');
        }
    }

    /* 5. QUIZ ENGINE */
    function startQuiz() {
        // Collect questions
        const t = App.selection.term;
        const s = App.selection.subject;
        let pool = [];

        App.selection.chapters.forEach(key => {
            const [l, c] = key.split('|');
            const qs = App.tree[t][s][l][c];
            if(qs) pool.push(...qs);
        });

        // Shuffle
        pool.sort(() => Math.random() - 0.5);
        App.quiz.queue = pool;
        App.quiz.index = 0;
        
        renderQuestion();
    }

    function renderQuestion() {
        switchView('view-quiz');
        const q = App.quiz.queue[App.quiz.index];
        
        document.getElementById('q-idx').innerText = App.quiz.index + 1;
        document.getElementById('q-total').innerText = App.quiz.queue.length;

        const container = document.getElementById('q-content');
        // Structure: Question Text, Meta (ID | Lesson | Chap), Options, Explanation
        container.innerHTML = `
            <div style="margin-bottom:20px">
                <span style="font-size:0.8em;color:var(--primary);background:var(--primary-bg);padding:4px 8px;border-radius:6px">
                    ${txt('id')}: ${q.id} | ${q._meta.lsn} | ${q._meta.chap}
                </span>
            </div>
            <div style="font-weight:bold;font-size:1.15em;margin-bottom:20px;line-height:1.5">
                ${q.question}
            </div>
            <div id="opts-area"></div>
            <div id="expl-area" class="hidden" style="margin-top:20px;background:var(--primary-bg);padding:15px;border-radius:10px;border:1px solid var(--primary)"></div>
            <button id="next-q-btn" class="btn-action hidden" onclick="nextQ()" style="margin-top:20px">${txt('next')}</button>
        `;

        const optsArea = document.getElementById('opts-area');
        q.options.forEach((opt, idx) => {
            const btn = document.createElement('div');
            btn.className = 'opt-btn';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(q, idx, btn);
            optsArea.appendChild(btn);
        });
    }

    function checkAnswer(q, idx, el) {
        if(el.parentElement.classList.contains('locked')) return;
        el.parentElement.classList.add('locked');

        const isCorrect = (idx === q.correct_option_id); // Assuming JSON has correct_option_id (0-based)
        // Note: Some JSONs use 1-based or letters. Adjust if needed. 
        // Based on previous files: correct_option_id seems to be index.
        
        if(isCorrect) {
            el.classList.add('correct');
        } else {
            el.classList.add('wrong');
            // Show correct
            el.parentElement.children[q.correct_option_id].classList.add('correct');
        }

        // Show Explanation
        if(q.explanation) {
            const exp = document.getElementById('expl-area');
            exp.classList.remove('hidden');
            exp.innerHTML = `<b>${txt('explanation')}:</b><br>${q.explanation}`;
        }

        document.getElementById('next-q-btn').classList.remove('hidden');
        // Auto scroll
        document.getElementById('next-q-btn').scrollIntoView({behavior:'smooth'});
    }

    function nextQ() {
        if(App.quiz.index < App.quiz.queue.length - 1) {
            App.quiz.index++;
            renderQuestion();
        } else {
            alert("Quiz Finished!");
            goHome();
        }
    }

    function confirmExit() {
        if(confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü")) goHome();
    }
    
    function goHome() {
        switchView('view-terms');
        App.selection = { term:null, subject:null, lessons:[], chapters:[] };
    }

    /* --- SETTINGS & UTILS --- */
    function toggleSettings() {
        const m = document.getElementById('settingsModal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    }

    function setLang(l) {
        App.settings.lang = l;
        applySettings();
    }

    function setTheme(t) {
        App.settings.theme = t;
        applySettings();
    }

    function setFont(s) {
        App.settings.font = s;
        applySettings();
    }

    function applySettings() {
        const s = App.settings;
        
        // Lang
        document.documentElement.lang = s.lang;
        document.documentElement.dir = (s.lang === 'ar') ? 'rtl' : 'ltr';
        document.querySelectorAll('[data-key]').forEach(el => {
            el.innerText = txt(el.getAttribute('data-key'));
        });

        // Theme
        document.body.className = `theme-${s.theme}`;

        // Font
        document.documentElement.style.setProperty('--font-size', s.font + 'px');

        // Save
        localStorage.setItem('elite_settings', JSON.stringify(s));

        // Highlight buttons
        document.querySelectorAll('.setting-btn').forEach(b => b.classList.remove('active'));
        if(document.getElementById(`btn-lang-${s.lang}`)) 
           document.getElementById(`btn-lang-${s.lang}`).classList.add('active');
    }

    function txt(key) {
        return TEXTS[App.settings.lang][key] || key;
    }

</script>
</body>
</html>
