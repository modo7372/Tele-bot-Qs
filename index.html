<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Bot Elite</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f5f5f5; --card: #fff; --text: #333; --hint: #777;
            --primary: #2481cc; --accent: #2e8b57; --danger: #e53935;
            --radius: 12px; --shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        body.dark-mode {
            --bg: #1c1c1e; --card: #2c2c2e; --text: #fff; --hint: #aaa;
            --primary: #3b9cd4; --shadow: 0 2px 4px rgba(0,0,0,0.4);
        }

        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; user-select: none; }
        
        /* HEADER */
        header { background: var(--card); padding: 12px 16px; box-shadow: var(--shadow); position: sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center; }
        .score-pill { background:rgba(0,0,0,0.05); padding:4px 12px; border-radius:20px; font-weight:bold; font-size:0.9em; }

        /* CONTAINERS */
        .view { display: none; padding: 16px; max-width:600px; margin:0 auto; animation: fadeIn 0.2s; }
        .view.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* LIST ITEMS (Nav) */
        .list-item {
            background: var(--card); border-radius: var(--radius); padding: 16px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow); cursor: pointer; transition: 0.1s;
        }
        .list-item:active { transform: scale(0.98); }
        .checkbox-wrapper { display: flex; align-items: center; gap: 12px; flex-grow: 1; }
        input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer; }

        /* BUTTONS */
        .btn-main {
            background: var(--primary); color: white; border: none; padding: 15px; width: 100%;
            border-radius: var(--radius); font-size: 1em; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(36, 129, 204, 0.3); margin-top:10px;
        }
        .fab-action {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: white; padding: 12px 24px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-weight: bold; display: none; cursor: pointer; z-index: 100;
        }

        /* CHIPS (Setup) */
        .chips-grid { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0 20px 0; }
        .chip {
            background: var(--card); border: 1px solid rgba(128,128,128,0.3); padding: 8px 16px;
            border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: 0.2s;
        }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* QUIZ */
        .q-badge { background: #eee; color:#444; padding:3px 6px; border-radius:4px; font-family:monospace; font-size:0.8em; }
        .q-text { font-size: 1.15em; font-weight: 600; margin: 15px 0 20px; line-height: 1.5; }
        .opt-btn {
            background: var(--card); padding: 15px; border-radius: 10px; width: 100%; text-align: right;
            border: 1px solid rgba(0,0,0,0.08); margin-bottom: 10px; color: var(--text);
        }
        .opt-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
        .opt-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        
        /* BOTTOM NAV */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--card);
            border-top: 1px solid rgba(0,0,0,0.1); display: flex; z-index: 50;
        }
        .nav-item { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--hint); font-size:0.75em; border:none; background:none; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.6em; margin-bottom: 2px; }

        /* LEADERBOARD */
        .rank-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; font-size: 0.95em; }
        .rank-hl { background: rgba(36, 129, 204, 0.1); font-weight: bold; border-radius: 8px; border:none; }

        /* LOADING */
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <!-- 1. LOADER -->
    <div id="loader">
        <div style="font-size:2em">ğŸ“¥</div>
        <p id="loaderTxt" style="margin-top:10px">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <!-- 2. HEADER -->
    <header>
        <div style="font-weight:bold">ğŸ¤– Exam Bot</div>
        <div class="score-pill">ğŸ† <span id="uScore">0</span></div>
    </header>

    <!-- 3. VIEWS -->
    
    <!-- A. HOME -->
    <div id="v-home" class="view active">
        <div class="list-item" onclick="browseContent()">
            <div>
                <h3>ğŸ“ ØªØµÙØ­ Ø§Ù„Ù…Ù†Ù‡Ø¬</h3>
                <p style="font-size:0.8em; color:var(--hint)">Ø¯Ø±ÙˆØ³ØŒ ÙØµÙˆÙ„ØŒ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø¬Ù…Ø¹Ø©</p>
            </div>
            <div style="font-size:1.5em">ğŸ“š</div>
        </div>

        <div class="list-item" onclick="openMistakesMode()">
            <div>
                <h3>ğŸ›  Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h3>
                <p style="font-size:0.8em; color:var(--hint)">Ø£Ø³Ø¦Ù„Ø© Ø£Ø¬Ø¨ØªÙ‡Ø§ Ø¨Ø´ÙƒÙ„ Ø®Ø§Ø·Ø¦ Ø³Ø§Ø¨Ù‚Ø§Ù‹</p>
            </div>
            <div style="font-size:1.5em">ğŸš§</div>
        </div>
        
        <div style="text-align:center; margin-top:30px; font-size:0.8em; color:var(--hint)">
            ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¥Ù†ØªØ±Ù†Øª Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©<br>
            <button onclick="window.location.reload()" style="background:none; border:none; color:var(--primary); margin-top:5px">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        </div>
    </div>

    <!-- B. NAV BROWSER (Dynamic Hierarchy) -->
    <div id="v-browser" class="view">
        <button onclick="goHome()" style="background:none; border:none; color:var(--primary); margin-bottom:10px">â¬…ï¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <h3 id="browserTitle">Ø§Ù„Ù…Ø­ØªÙˆÙ‰:</h3>
        
        <!-- Controls for multi-select -->
        <div style="margin-bottom:10px; display:flex; justify-content:space-between">
            <label style="display:flex; align-items:center; gap:5px; font-size:0.9em">
                <input type="checkbox" onchange="toggleAll(this)" id="checkAllBox"> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
            </label>
        </div>

        <div id="browserList"></div>
    </div>

    <!-- C. SETUP CONFIG (Mode & Qty) -->
    <div id="v-setup" class="view">
        <button onclick="backToBrowser()" style="background:none; border:none; color:var(--primary); margin-bottom:10px">â¬…ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</button>
        <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
        <p style="color:var(--hint); font-size:0.9em" id="setupSubtitle"></p>

        <h4>Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</h4>
        <div class="chips-grid">
            <div class="chip active" onclick="setMode('new', this)">ğŸ†• Ø¬Ø¯ÙŠØ¯Ø©</div>
            <div class="chip" onclick="setMode('mistake', this)">ğŸ– Ø£Ø®Ø·Ø§Ø¡ Ø³Ø§Ø¨Ù‚Ø©</div>
            <div class="chip" onclick="setMode('mixed', this)">ğŸ”€ Ù…Ø®ØªÙ„Ø·</div>
        </div>

        <h4>Ø§Ù„Ø¹Ø¯Ø¯:</h4>
        <div class="chips-grid">
            <div class="chip active" onclick="setQty(5, this)">5</div>
            <div class="chip" onclick="setQty(10, this)">10</div>
            <div class="chip" onclick="setQty(20, this)">20</div>
            <div class="chip" onclick="setQty(999, this)">Ø§Ù„ÙƒÙ„</div>
        </div>
        
        <p id="filterError" style="color:var(--danger); display:none; text-align:center">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ØªØ·Ø§Ø¨Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙˆØ·.</p>

        <button class="btn-main" onclick="startFinalQuiz()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† ğŸš€</button>
    </div>

    <!-- D. QUIZ -->
    <div id="v-quiz" class="view">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; color:var(--hint); font-size:0.9em">
            <span id="qCount">1 / 10</span>
            <span class="q-badge" id="qID">ID: 000</span>
            <span onclick="confirmExit()" style="color:var(--danger); cursor:pointer">âœ–</span>
        </div>
        <div id="quizContainer"></div>
    </div>

    <!-- E. LEADERBOARD -->
    <div id="v-leader" class="view">
        <h3 style="text-align:center">ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ†</h3>
        <div class="rank-card" id="leaderList" style="background:var(--card); border-radius:10px; box-shadow:var(--shadow)">
            <p style="text-align:center; padding:20px">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</p>
        </div>
        <p style="text-align:center; font-size:0.8em; color:var(--hint); margin-top:10px">ÙŠØ¹ØªÙ…Ø¯ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</p>
    </div>

    <!-- FLOATING ACTION BUTTON (For Selection) -->
    <div id="fabBtn" class="fab-action" onclick="goToSetup()">
        âœ… ØªÙƒÙˆÙŠÙ† Ø§Ø®ØªØ¨Ø§Ø± (<span id="selCount">0</span>)
    </div>

    <!-- 4. BOTTOM NAV -->
    <div class="nav-bar">
        <button class="nav-item active" onclick="goHome()">
            <div class="nav-icon">ğŸ </div> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>
        <button class="nav-item" onclick="loadLeaderboard()">
            <div class="nav-icon">ğŸ“Š</div> Ø§Ù„Ø£ÙˆØ§Ø¦Ù„
        </button>
    </div>

<script>
    /* =========================================
       1. CONFIG & INIT
       ========================================= */
    const CONFIG = {
        firebase: {
            // !!! Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§ !!!
            apiKey: "AIzaSyDEZFJmcXK2LxYAZ-Yjv_M1HbC6zi_qilg",
            authDomain: "exambotdb.firebaseapp.com",
            databaseURL: "https://exambotdb-default-rtdb.firebaseio.com",
            projectId: "exambotdb",
            storageBucket: "exambotdb.firebasestorage.app",
            messagingSenderId: "950600562980",
            appId: "1:950600562980:web:f993c22d45e5cfdd3d9bb1"
        }
    };

    const TG = window.Telegram.WebApp;
    let DB = null;
    let UserID = "guest_1";
    let AppState = {
        allData: [],      // Flat list of questions
        tree: {},         // Hierarchy { Subject: { Lesson: [qs] } }
        progress: {},     // { qId: 'correct'|'wrong' }
        
        // Navigation & Selection
        navLevel: 'root', // root -> subject -> lesson
        currContext: null,// pointer to current tree node
        selectedItems: [], // items selected for quiz

        // Setup
        config: { mode: 'new', qty: 5 },
        quizQueue: [],
        qIdx: 0
    };

    function init() {
        TG.ready(); TG.expand();
        if(TG.initDataUnsafe?.user?.id) UserID = TG.initDataUnsafe.user.id.toString();
        
        if(TG.colorScheme === 'dark') document.body.classList.add('dark-mode');

        if(window.firebase && !firebase.apps.length) {
            firebase.initializeApp(CONFIG.firebase);
            DB = firebase.database();
        }

        fetchContent();
    }

    async function fetchContent() {
        if(!navigator.onLine) {
            alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø§Ù†ØªØ±Ù†Øª!");
            document.getElementById('loaderTxt').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©";
            return;
        }

        try {
            // 1. Get Questions
            const list = await fetch('questions_list.json?t='+Date.now()).then(r=>r.json());
            const jobs = list.map(f => fetch('Questions/'+f).then(r=>r.json()));
            const data = await Promise.all(jobs);

            // 2. Flatten & Structure
            let flat = [];
            let hierarchy = {}; 

            data.forEach(d => {
                const meta = d.meta || {};
                const subj = meta.lesson || "Ø¹Ø§Ù…"; // Using 'lesson' from meta as Top Category (User specific request) 
                
                // Assuming hierarchy: Subject (Folder Name) -> Lesson (Inside file) -> Question
                // Based on previous chats, structure is confusing. Let's Standardize:
                // Level 1: "source" or "term"
                // Level 2: "lesson"
                
                // Fallback standardization:
                const term = meta.source || meta.term || "Ø§Ù„Ù…Ù†Ù‡Ø¬";
                const lessonName = meta.lesson || "ØºÙŠØ± Ù…ØµÙ†Ù";

                if(!hierarchy[term]) hierarchy[term] = {};
                if(!hierarchy[term][lessonName]) hierarchy[term][lessonName] = [];

                d.questions.forEach(q => {
                    const enhancedQ = { ...q, _h: {term, lesson: lessonName} };
                    flat.push(enhancedQ);
                    hierarchy[term][lessonName].push(enhancedQ);
                });
            });

            AppState.allData = flat;
            AppState.tree = hierarchy;

            // 3. Sync User Progress
            if(DB && UserID !== 'guest') {
                const snap = await DB.ref(`users/${UserID}/progress`).once('value');
                AppState.progress = snap.val() || {};
            }

            // Finish
            updateHeaderScore();
            document.getElementById('loader').style.display = 'none';

        } catch(e) {
            console.error(e);
            document.getElementById('loaderTxt').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (ØªØ£ÙƒØ¯ Ù…Ù† Rules)";
            setTimeout(()=> document.getElementById('loader').style.display='none', 2000);
        }
    }

    /* =========================================
       2. NAVIGATION & BROWSER (Selection Logic)
       ========================================= */
    
    function switchView(id) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('fabBtn').style.display = 'none'; // Hide FAB by default
    }

    function goHome() { switchView('v-home'); updateHeaderScore(); }

    function browseContent() {
        // Show Top Level (Terms/Sources)
        renderBrowser(AppState.tree, 'root');
    }

    // Dynamic Render of Checkbox List
    function renderBrowser(dataSource, levelName) {
        switchView('v-browser');
        const listDiv = document.getElementById('browserList');
        listDiv.innerHTML = '';
        AppState.navLevel = levelName;
        AppState.currContext = dataSource;
        AppState.selectedItems = []; // Reset selection when changing view depth
        updateFab();

        const keys = Object.keys(dataSource);
        
        if(keys.length === 0) { listDiv.innerHTML = "<p>ÙØ§Ø±Øº</p>"; return; }

        keys.forEach(k => {
            const isLeaf = Array.isArray(dataSource[k]); // Is it array of questions?
            const count = isLeaf ? dataSource[k].length : Object.keys(dataSource[k]).length + " ÙˆØ­Ø¯Ø§Øª";

            const row = document.createElement('div');
            row.className = 'list-item';
            
            // If leaf (Actual lessons containing questions), Show Checkbox
            // If folder, Show Folder Icon & Click to enter
            if(isLeaf) {
                row.innerHTML = `
                    <label class="checkbox-wrapper">
                        <input type="checkbox" value="${k}" onchange="handleSelect('${k}')">
                        <div>
                            <div style="font-weight:600">${k}</div>
                            <div style="font-size:0.8em; color:var(--hint)">${count} Ø³Ø¤Ø§Ù„</div>
                        </div>
                    </label>
                `;
            } else {
                row.innerHTML = `
                    <div style="flex-grow:1" onclick="drillDown('${k}')">
                        <div style="font-weight:600">ğŸ“‚ ${k}</div>
                        <div style="font-size:0.8em; color:var(--hint)">${count}</div>
                    </div>
                    <div>â¡ï¸</div>
                `;
            }
            listDiv.appendChild(row);
        });
        
        // Hide Check All box if we are just looking at folders
        const hasLeaves = keys.some(k => Array.isArray(dataSource[k]));
        document.getElementById('checkAllBox').parentElement.style.display = hasLeaves ? 'flex' : 'none';
        document.getElementById('checkAllBox').checked = false;
    }

    function drillDown(key) {
        renderBrowser(AppState.currContext[key], key);
        document.getElementById('browserTitle').innerText = key;
    }
    
    function backToBrowser() {
        switchView('v-browser');
        document.getElementById('fabBtn').style.display = 'block'; // Show FAB again
    }

    // -- Selection Handling --
    function handleSelect(key) {
        if(AppState.selectedItems.includes(key)) {
            AppState.selectedItems = AppData.selectedItems.filter(i => i !== key);
        } else {
            AppState.selectedItems.push(key);
        }
        updateFab();
    }
    
    function toggleAll(chk) {
        const boxes = document.querySelectorAll('#browserList input[type="checkbox"]');
        AppState.selectedItems = [];
        boxes.forEach(b => {
            b.checked = chk.checked;
            if(chk.checked) AppState.selectedItems.push(b.value);
        });
        updateFab();
    }

    function updateFab() {
        const c = AppState.selectedItems.length;
        document.getElementById('selCount').innerText = c;
        document.getElementById('fabBtn').style.display = c > 0 ? 'block' : 'none';
    }

    function goToSetup() {
        switchView('v-setup');
        document.getElementById('setupSubtitle').innerText = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ${AppState.selectedItems.join(' + ')}`;
        document.getElementById('filterError').style.display = 'none';
    }

    /* =========================================
       3. MISTAKES MODE SPECIFIC
       ========================================= */
    function openMistakesMode() {
        // Find ALL wrong IDs
        const wrongs = Object.keys(AppState.progress).filter(id => AppState.progress[id] === 'wrong');
        if(wrongs.length === 0) {
            alert("Ø±Ø§Ø¦Ø¹! Ø³Ø¬Ù„Ùƒ Ù†Ø¸ÙŠÙ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ âœ…");
            return;
        }

        // Just collect all wrong questions and push to queue immediately or Setup
        // Let's send to Setup for consistency
        const wrongQs = AppState.allData.filter(q => wrongs.includes(q.id.toString()));
        
        // Skip Browse, go strictly to config
        AppState.tempQueue = wrongQs;
        switchView('v-setup');
        document.getElementById('setupSubtitle').innerText = "ÙˆØ¶Ø¹ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„ (ÙƒÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³)";
        // Force settings visually
        setMode('mistake', document.querySelectorAll('#v-setup .chip')[1]);
    }

    /* =========================================
       4. QUIZ CONFIGURATION & START
       ========================================= */
    function setMode(m, el) { 
        AppState.config.mode = m; 
        document.querySelectorAll('.chips-grid .chip').forEach(c=>c.classList.remove('active'));
        if(el) el.classList.add('active');
    }
    function setQty(q, el) { 
        AppState.config.qty = q; 
        // Visual toggle code similar to above
         document.querySelectorAll('.chips-grid').forEach(g=>{/*logic omit for brevity*/});
         el.parentElement.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
         el.classList.add('active');
    }

    function startFinalQuiz() {
        // 1. Gather Candidate Questions based on Context
        let candidates = [];
        
        if(AppState.tempQueue) {
            // Came from "Mistakes" main button
            candidates = AppState.tempQueue;
        } else {
            // Came from Browser Selection
            // Look up questions inside the selected keys in currContext
            AppState.selectedItems.forEach(key => {
                const questions = AppState.currContext[key];
                if(questions) candidates.push(...questions);
            });
        }

        // 2. Filter by Mode (New vs Mistake)
        const m = AppState.config.mode;
        if(m === 'new') candidates = candidates.filter(q => AppState.progress[q.id] !== 'correct');
        else if (m === 'mistake') candidates = candidates.filter(q => AppState.progress[q.id] === 'wrong');
        
        // 3. Randomize & Slice
        if(candidates.length === 0) {
            document.getElementById('filterError').style.display = 'block';
            return;
        }

        candidates.sort(() => Math.random() - 0.5);
        AppState.quizQueue = candidates.slice(0, AppState.config.qty);
        AppState.qIdx = 0;
        AppState.tempQueue = null; // Clear

        runQuiz();
    }

    /* =========================================
       5. QUIZ RUNTIME
       ========================================= */
    function runQuiz() {
        switchView('v-quiz');
        renderQ();
    }

    function renderQ() {
        const Q = AppState.quizQueue[AppState.qIdx];
        document.getElementById('qCount').innerText = (AppState.qIdx+1) + " / " + AppState.quizQueue.length;
        document.getElementById('qID').innerText = "ID: " + (Q.id || 'N/A');
        
        const c = document.getElementById('quizContainer');
        
        let html = `
            ${Q.image ? `<img src="${Q.image}" style="max-width:100%; border-radius:10px">` : ''}
            <div class="q-text">${Q.question}</div>
            <div id="opts"></div>
            <div id="expl" style="display:none; background:#fff3cd; padding:15px; margin-top:15px; border-radius:10px; line-height:1.6"></div>
            <button id="nextBtn" class="btn-main" onclick="nextQ()" style="display:none">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸</button>
        `;
        c.innerHTML = html;
        
        const optsDiv = document.getElementById('opts');
        if(Q.type === 'matching') {
            optsDiv.innerHTML = "<p align='center' style='color:red'>Ø³Ø¤Ø§Ù„ ØªÙˆØµÙŠÙ„ - ØªØ®Ø·ÙŠ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</p>";
            document.getElementById('nextBtn').style.display = 'block';
            return;
        }

        Q.options.forEach((o, i) => {
            const btn = document.createElement('div');
            btn.className = 'opt-btn';
            btn.innerText = o;
            btn.onclick = () => checkAns(i, Q, btn);
            optsDiv.appendChild(btn);
        });
        window.scrollTo(0,0);
    }

    function checkAns(idx, Q, btn) {
        if(btn.parentElement.classList.contains('locked')) return;
        btn.parentElement.classList.add('locked');

        const isCorrect = (idx === Q.correct_option_id);
        const status = isCorrect ? 'correct' : 'wrong';

        if(isCorrect) {
            btn.classList.add('correct');
        } else {
            btn.classList.add('wrong');
            btn.parentElement.children[Q.correct_option_id]?.classList.add('correct');
        }

        if(Q.explanation) {
            const el = document.getElementById('expl');
            el.innerHTML = "<b>ğŸ’¡ Ø§Ù„Ø´Ø±Ø­:</b><br>" + Q.explanation;
            el.style.display = 'block';
        }

        // SAVE & SYNC
        AppState.progress[Q.id] = status;
        if(DB && UserID!=='guest') {
            // Save Progress
            DB.ref(`users/${UserID}/progress/${Q.id}`).set(status);
            // Increment simple total score for leaderboard sorting
            if(isCorrect) DB.ref(`users/${UserID}/totalScore`).transaction(v => (v||0)+1);
            // Optional: Save name
            if(TG.initDataUnsafe?.user?.first_name) {
                DB.ref(`users/${UserID}/name`).set(TG.initDataUnsafe.user.first_name);
            }
        }
        
        document.getElementById('nextBtn').style.display = 'block';
    }

    function nextQ() {
        if(AppState.qIdx < AppState.quizQueue.length-1) {
            AppState.qIdx++;
            renderQ();
        } else {
            alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±! ğŸ‰");
            goHome();
        }
    }
    
    function confirmExit() { if(confirm("Ø®Ø±ÙˆØ¬ØŸ")) goHome(); }
    
    function updateHeaderScore() {
        const correctCount = Object.values(AppState.progress).filter(v=>v==='correct').length;
        document.getElementById('uScore').innerText = correctCount;
    }

    /* =========================================
       6. LEADERBOARD (PERMISSION FIX)
       ========================================= */
    
    function loadLeaderboard() {
        switchView('v-leader');
        const list = document.getElementById('leaderList');
        list.innerHTML = "<p style='text-align:center'>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p>";
        
        if(!DB) { list.innerHTML = "<p style='padding:20px; text-align:center'>ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ø£ÙˆÙ„Ø§Ù‹</p>"; return; }

        // The query that usually fails if rules are strictly "auth != null"
        // Ensure you apply the rules provided below
        DB.ref('users').orderByChild('totalScore').limitToLast(30).once('value')
        .then(snap => {
            let data = [];
            snap.forEach(child => {
                const val = child.val();
                data.push({
                    name: val.name || "Student",
                    score: val.totalScore || 0,
                    id: child.key
                });
            });
            
            data.sort((a,b) => b.score - a.score); // Highest first
            
            let html = "";
            let rank = 1;
            data.forEach(p => {
                const isMe = p.id === UserID;
                const badge = rank===1?'ğŸ¥‡':rank===2?'ğŸ¥ˆ':rank===3?'ğŸ¥‰':`#${rank}`;
                html += `
                    <div class="rank-row ${isMe ? 'rank-hl' : ''}">
                        <div><span style="display:inline-block; width:30px">${badge}</span> ${p.name} ${isMe?'(Ø£Ù†Øª)':''}</div>
                        <div><b>${p.score}</b></div>
                    </div>
                `;
                rank++;
            });
            list.innerHTML = html || "<p style='padding:20px; text-align:center'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø§ÙØ³ÙŠÙ† Ø¨Ø¹Ø¯.</p>";
        })
        .catch(err => {
            console.error(err);
            list.innerHTML = `<div style="padding:15px; color:#c62828; text-align:center; font-size:0.9em">
                <b>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Permission Denied)</b><br>
                ÙŠØ¬Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù€ Rules ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø§Ù…Ø©.<br>
                Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù€ Console Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.
            </div>`;
        });
    }

    // BOOT
    window.addEventListener('load', init);

</script>
</body>
</html>
