<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Bot Elite V5 (Deep Hierarchy)</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-color: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --primary: #2563eb;
            --primary-glow: rgba(37, 99, 235, 0.3);
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #ca8a04;
            --radius: 16px;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --card-color: #1e293b;
            --text-main: #f8fafc;
            --text-light: #94a3b8;
            --primary: #3b82f6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 90px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.3s;
        }

        /* --- Header --- */
        header {
            background: var(--card-color);
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
        }
        .app-logo { font-size: 1.1rem; font-weight: 800; background: linear-gradient(45deg, var(--primary), #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stats-badge { background: rgba(0,0,0,0.05); padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; }

        /* --- Views --- */
        .view { display: none; padding: 16px; max-width: 650px; margin: 0 auto; animation: fadeUp 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards & Navigation --- */
        .nav-card {
            background: var(--card-color); border-radius: var(--radius); padding: 20px;
            margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.03);
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        .nav-card:active { transform: scale(0.98); }
        .nav-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-left: 15px; background: rgba(37,99,235,0.1); color: var(--primary); }

        /* --- List Items (Selection) --- */
        .select-row {
            background: var(--card-color); border-radius: 12px; padding: 15px; margin-bottom: 10px;
            display: flex; align-items: center; transition: 0.2s;
        }
        .select-row.active { border: 1.5px solid var(--primary); background: rgba(37,99,235,0.03); }
        .chk-input { width: 22px; height: 22px; margin-left: 15px; accent-color: var(--primary); }
        .row-info div:first-child { font-weight: 600; margin-bottom: 3px; }
        .row-info div:last-child { font-size: 0.8rem; color: var(--text-light); }

        /* --- Breadcrumb --- */
        .breadcrumb { display: flex; align-items: center; font-size: 0.9rem; margin-bottom: 20px; color: var(--text-light); white-space: nowrap; overflow-x: auto; padding-bottom: 5px; }
        .bc-btn { background: none; border: none; color: var(--primary); font-weight: bold; cursor: pointer; padding: 0; margin-left: 8px; flex-shrink: 0;}

        /* --- Quiz Setup Chips --- */
        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0 25px 0; }
        .chip {
            background: var(--card-color); border: 1px solid rgba(128,128,128,0.2);
            padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 0.9rem; flex: 1; text-align: center; white-space: nowrap; transition: 0.2s;
        }
        .chip.selected { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px var(--primary-glow); }

        /* --- Action Button --- */
        .btn-action {
            background: var(--primary); color: white; width: 100%; border: none; padding: 18px;
            border-radius: var(--radius); font-weight: 800; font-size: 1.1rem;
            box-shadow: 0 8px 20px var(--primary-glow); cursor: pointer; transition: 0.2s;
        }
        .btn-action:active { transform: translateY(2px); }

        /* --- Floating FAB --- */
        .fab {
            position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%);
            background: #111; color: white; padding: 12px 30px; border-radius: 40px;
            font-weight: bold; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 90; display: none; cursor: pointer; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        body.dark-mode .fab { background: var(--primary); }
        @keyframes popIn { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* --- Quiz UI --- */
        .q-text { font-size: 1.2rem; font-weight: 600; line-height: 1.6; margin: 20px 0; }
        .opt-btn {
            background: var(--card-color); width: 100%; padding: 16px; margin-bottom: 12px;
            border-radius: 12px; border: 2px solid transparent; text-align: right;
            font-size: 1rem; color: var(--text-main); cursor: pointer; transition: 0.15s;
        }
        .opt-btn.correct { background: #dcfce7; border-color: #16a34a; color: #14532d; }
        .opt-btn.wrong { background: #fee2e2; border-color: #dc2626; color: #7f1d1d; }

        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: var(--card-color); display: flex; align-items: center; justify-content: space-around;
            border-top: 1px solid rgba(0,0,0,0.05); z-index: 100;
        }
        .nav-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: var(--text-light); gap: 4px; font-size: 0.75rem; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* --- Leaderboard --- */
        .rank-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .rank-hl { background: rgba(37,99,235,0.05); font-weight: bold; border-left: 3px solid var(--primary); }

        #loader { position: fixed; inset: 0; background: var(--bg-color); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ccc; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:15px; font-weight:500">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p>
    </div>

    <!-- Header -->
    <header>
        <div class="app-logo">ExaM Bot V5</div>
        <div class="stats-badge">
            <span style="color:var(--success)">âœ…</span> <span id="userScore">--</span>
        </div>
    </header>

    <!-- 1. HOME -->
    <div id="v-home" class="view active">
        <div class="nav-card" onclick="startBrowsing()">
            <div style="display:flex;align-items:center">
                <div class="nav-icon">ğŸ“š</div>
                <div>
                    <div style="font-weight:700">ØªØµÙØ­ Ø§Ù„Ù…Ù†Ù‡Ø¬</div>
                    <div style="font-size:0.85rem;color:var(--text-light)">Ø§Ù„ØªØ±Ù… â¬…ï¸ Ø§Ù„Ù…Ø§Ø¯Ø© â¬…ï¸ Ø§Ù„Ø¯Ø±Ø³</div>
                </div>
            </div>
            <div>â¬…ï¸</div>
        </div>

        <div class="nav-card" onclick="enterMistakesMode()">
            <div style="display:flex;align-items:center">
                <div class="nav-icon" style="color:var(--danger);background:rgba(220,38,38,0.1)">ğŸ–</div>
                <div>
                    <div style="font-weight:700">Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div>
                    <div style="font-size:0.85rem;color:var(--text-light)">ØªØµØ­ÙŠØ­ Ù…ÙØ§Ù‡ÙŠÙ…Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
                </div>
            </div>
            <div>â¬…ï¸</div>
        </div>

        <div style="text-align:center; margin-top:30px">
            <button onclick="location.reload()" style="background:none; border:none; color:var(--primary); font-weight:600">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
    </div>

    <!-- 2. BROWSER (The Deep Hierarchy Navigator) -->
    <div id="v-browser" class="view">
        <div class="breadcrumb">
            <span onclick="goHome()" style="cursor:pointer">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            <span id="bc-path"></span>
        </div>
        
        <h2 id="browser-title" style="margin-top:0">Ø§Ø®ØªØ±:</h2>

        <!-- Select All Control (Visible only at Leaf/Chapter level) -->
        <div id="selectAllContainer" style="display:none; margin-bottom:15px; background:var(--card-color); padding:10px; border-radius:10px; align-items:center; gap:10px; border:1px solid rgba(0,0,0,0.05)">
            <input type="checkbox" id="chkAll" class="chk-input" onchange="toggleSelectAll(this)">
            <label for="chkAll" style="font-weight:bold; font-size:0.9rem; cursor:pointer">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ (ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„ÙØ±Ø¹ÙŠØ©)</label>
        </div>

        <div id="browser-content"></div>
        <div style="height:60px"></div>
    </div>

    <!-- 3. SETUP CONFIG -->
    <div id="v-setup" class="view">
        <button class="bc-btn" onclick="backToBrowser()" style="margin:0 0 15px 0">â¬…ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</button>
        
        <div style="text-align:center; margin-bottom:20px">
            <div style="font-size:2.5rem; margin-bottom:10px">âš™ï¸</div>
            <h2 style="margin:0">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
            <p id="setup-count" style="color:var(--text-light)"></p>
        </div>

        <label style="font-weight:bold">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
        <div class="chips-container" id="modeChips">
            <div class="chip selected" onclick="setMode('new', this)">ğŸ†• Ø¬Ø¯ÙŠØ¯Ø©</div>
            <div class="chip" onclick="setMode('mistake', this)">ğŸš¨ Ø£Ø®Ø·Ø§Ø¡</div>
            <div class="chip" onclick="setMode('mixed', this)">ğŸ”€ Ù…Ø®ØªÙ„Ø·</div>
        </div>

        <label style="font-weight:bold">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
        <div class="chips-container" id="qtyChips">
            <div class="chip selected" onclick="setQty(5, this)">5</div>
            <div class="chip" onclick="setQty(10, this)">10</div>
            <div class="chip" onclick="setQty(20, this)">20</div>
            <div class="chip" onclick="setQty(999, this)">Ø§Ù„ÙƒÙ„</div>
        </div>

        <div id="empty-msg" style="display:none; color:var(--danger); text-align:center; padding:15px; background:rgba(220,38,38,0.1); border-radius:12px; margin-bottom:20px">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªÙˆÙØ±Ø© ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©!
        </div>

        <button class="btn-action" onclick="launchQuiz()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† ğŸš€</button>
    </div>

    <!-- 4. QUIZ UI -->
    <div id="v-quiz" class="view">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; color:var(--text-light); font-size:0.9rem">
            <span id="q-progress"></span>
            <span style="font-family:monospace; background:#eee; color:#444; padding:2px 6px; border-radius:4px" id="q-id"></span>
            <span onclick="confirmExit()" style="color:var(--danger); cursor:pointer; font-weight:bold">Ø¥Ù†Ù‡Ø§Ø¡</span>
        </div>

        <div id="q-content"></div>
    </div>

    <!-- 5. LEADERBOARD -->
    <div id="v-leader" class="view">
        <h2 style="text-align:center">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ğŸ‘‘</h2>
        <div style="background:var(--card-color); border-radius:12px; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,0.05)" id="leaderboard-list">
            <div style="padding:20px; text-align:center">ØªØ­Ù…ÙŠÙ„...</div>
        </div>
        <p style="text-align:center; font-size:0.8rem; margin-top:15px; color:var(--text-light)">ÙŠØ¹ØªÙ…Ø¯ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</p>
    </div>

    <!-- Floating FAB -->
    <div id="fab" class="fab" onclick="goToSetup()">
        ØªÙƒÙˆÙŠÙ† (<span id="sel-count">0</span>) âœ…
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="goHome()">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>
        <button class="nav-btn" onclick="openLeaderboard()">
            <svg viewBox="0 0 24 24"><path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/></svg>
            Ø§Ù„Ø£ÙˆØ§Ø¦Ù„
        </button>
    </div>

<script>
    /** ========== CONFIGURATION ========== */
    const CONFIG = {
        firebase: {
            apiKey: "AIzaSyDEZFJmcXK2LxYAZ-Yjv_M1HbC6zi_qilg",
            authDomain: "exambotdb.firebaseapp.com",
            databaseURL: "https://exambotdb-default-rtdb.firebaseio.com",
            projectId: "exambotdb",
            storageBucket: "exambotdb.firebasestorage.app",
            messagingSenderId: "950600562980",
            appId: "1:950600562980:web:f993c22d45e5cfdd3d9bb1"
        }
    };

    /** ========== STATE & VARS ========== */
    const TG = window.Telegram.WebApp;
    let DB = null, UserID = "guest";

    const App = {
        data: [],           // All questions flattened
        // Deep Hierarchy: Term -> Subject -> Lesson -> Chapter -> Array of QIDs
        hierarchy: {},      
        userProgress: {},   // QID -> 'correct'/'wrong'
        
        // Navigation State
        navStack: [],       // [Term, Subject, Lesson] for Breadcrumb & Pointer Logic
        currentPointer: null, // Points to current object in hierarchy
        
        // Selection State (Array of unique Keys "Term|Subject|Lesson|Chapter")
        // NOTE: We now select CHAPTERS/Subtopics, which are the lowest level
        selectedIds: [], 

        // Quiz Config
        setup: { mode: 'new', qty: 5 },
        queue: [],
        qIndex: 0
    };

    /** ========== INITIALIZATION ========== */
    window.onload = function() {
        TG.ready(); TG.expand();
        if(TG.initDataUnsafe?.user?.id) UserID = TG.initDataUnsafe.user.id.toString();
        if(TG.colorScheme === 'dark') document.body.classList.add('dark-mode');

        if(window.firebase && !firebase.apps.length) {
            firebase.initializeApp(CONFIG.firebase);
            DB = firebase.database();
        }
        
        fetchData();
    };

    async function fetchData() {
        if(!navigator.onLine) {
             document.querySelector('#loader p').innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø§Ù†ØªØ±Ù†Øª!";
             return;
        }

        try {
            const list = await fetch('questions_list.json?t=' + Date.now()).then(r => r.json());
            const jobs = list.map(f => fetch('Questions/'+f).then(r => r.json()));
            const files = await Promise.all(jobs);

            let allQ = [];
            let tree = {};

            files.forEach(f => {
                const meta = f.meta || {};
                const term = meta.source || meta.term || "Ø§Ù„Ù…Ù†Ù‡Ø¬";
                const subject = meta.subject || "Ø¹Ø§Ù…";
                const lesson = meta.lesson || "ØºÙŠØ± Ù…ØµÙ†Ù";

                // Build Deep Hierarchy: Term -> Subject -> Lesson -> Chapter
                if(!tree[term]) tree[term] = {};
                if(!tree[term][subject]) tree[term][subject] = {};
                if(!tree[term][subject][lesson]) tree[term][subject][lesson] = {};

                f.questions.forEach(q => {
                    const chapter = q.chapter || "Ø¹Ø§Ù…";
                    
                    const uniqueKey = `${term}|${subject}|${lesson}|${chapter}`;
                    
                    const enhancedQ = {
                        ...q,
                        _key: uniqueKey, // Grouping key (Chapter level)
                        _meta: { term, subject, lesson, chapter }
                    };
                    allQ.push(enhancedQ);
                    
                    if(!tree[term][subject][lesson][chapter]) tree[term][subject][lesson][chapter] = [];
                    tree[term][subject][lesson][chapter].push(enhancedQ.id);
                });
            });

            App.data = allQ;
            App.hierarchy = tree;

            if(DB && UserID !== 'guest') {
                const snap = await DB.ref(`users/${UserID}/progress`).once('value');
                App.userProgress = snap.val() || {};
            }
            updateScoreHeader();
            document.getElementById('loader').style.display = 'none';

        } catch (e) {
            console.error(e);
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù„Ù questions_list.json ÙˆÙ‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        }
    }

    /** ========== DEEP HIERARCHY NAVIGATION ========== */
    
    function setView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('fab').style.display = 'none';
    }

    function goHome() {
        setView('v-home');
        App.navStack = [];
        updateBottomNav(0);
    }

    function startBrowsing() {
        App.navStack = [];
        App.selectedIds = []; 
        renderBrowser(App.hierarchy, "Ø§Ù„ØªØ±Ù…");
    }

    function renderBrowser(node, title) {
        setView('v-browser');
        App.currentPointer = node;
        document.getElementById('browser-title').innerText = "Ø§Ø®ØªØ± " + title + ":";
        updateBreadcrumb();
        
        const container = document.getElementById('browser-content');
        container.innerHTML = '';
        document.getElementById('selectAllContainer').style.display = 'none';

        const keys = Object.keys(node);
        if(keys.length === 0) { container.innerHTML = "<p>ÙØ§Ø±Øº</p>"; return; }

        // CHECK LEVEL: Are we at Leaf (Chapter) level?
        // Logic: if value is Array, then it's [QIDs], meaning this node contains keys like 'Acromegaly'->[...]
        const isLeafLevel = Array.isArray(node[keys[0]]); 

        if(isLeafLevel) {
            // === CHAPTER SELECTOR VIEW ===
            document.getElementById('selectAllContainer').style.display = 'flex';
            document.getElementById('browser-title').innerText = "Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹:";
            
            keys.forEach(k => { // k = Chapter Name
                // Reconstruct Full ID
                const term = App.navStack[0];
                const subj = App.navStack[1];
                const lsn = App.navStack[2];
                const uniqueKey = `${term}|${subj}|${lsn}|${k}`;
                
                const qCount = node[k].length;
                const isSelected = App.selectedIds.includes(uniqueKey);

                const row = document.createElement('div');
                row.className = `select-row ${isSelected ? 'active' : ''}`;
                row.onclick = (e) => { if(e.target.type!=='checkbox') row.querySelector('input').click(); };
                
                row.innerHTML = `
                    <input type="checkbox" class="chk-input" ${isSelected?'checked':''} 
                           onchange="toggleItem('${uniqueKey}', this)">
                    <div class="row-info" style="margin-left:12px">
                        <div>${k}</div>
                        <div>${qCount} Ø³Ø¤Ø§Ù„</div>
                    </div>
                `;
                container.appendChild(row);
            });
            syncSelectAllUI();
        } else {
            // === FOLDER VIEW (Term / Subject / Lesson) ===
            // Identify level name for UX
            let nextTitle = "Ø§Ù„Ø®ÙŠØ§Ø±";
            if(App.navStack.length === 0) nextTitle = "Ø§Ù„Ù…Ø§Ø¯Ø©";      // After choosing Term
            else if(App.navStack.length === 1) nextTitle = "Ø§Ù„Ø¯Ø±Ø³";  // After choosing Subject
            else if(App.navStack.length === 2) nextTitle = "Ø§Ù„ÙØµÙ„";  // After choosing Lesson

            keys.forEach(k => {
                const card = document.createElement('div');
                card.className = 'nav-card';
                card.innerHTML = `
                    <div style="font-weight:600">ğŸ“‚ ${k}</div>
                    <div style="color:var(--text-light)">â¬…ï¸</div>
                `;
                card.onclick = () => enterFolder(k, nextTitle);
                container.appendChild(card);
            });
        }
        updateFab();
    }

    function enterFolder(key, titleLabel) {
        App.navStack.push(key);
        // Safety: check if key exists
        if(App.currentPointer[key]) {
             renderBrowser(App.currentPointer[key], titleLabel);
        } else {
            alert("Error in structure");
        }
    }

    function stepBack() {
        if(App.navStack.length === 0) { goHome(); return; }
        App.navStack.pop();
        
        let ptr = App.hierarchy;
        App.navStack.forEach(k => ptr = ptr[k]);
        
        let label = "Ø§Ù„Ø¹Ù†ØµØ±";
        // Logic to reverse-guess label (Cosmetic only)
        if(App.navStack.length===0) label="Ø§Ù„ØªØ±Ù…";
        else if(App.navStack.length===1) label="Ø§Ù„Ù…Ø§Ø¯Ø©";
        else if(App.navStack.length===2) label="Ø§Ù„Ø¯Ø±Ø³";

        renderBrowser(ptr, label);
    }

    function updateBreadcrumb() {
        const span = document.getElementById('bc-path');
        const backBtn = document.querySelector('.bc-btn');
        if(App.navStack.length > 0) {
            backBtn.onclick = stepBack;
            backBtn.style.display = "block";
            backBtn.innerText = "â¬…ï¸ Ø±Ø¬ÙˆØ¹";
            span.innerHTML = " / " + App.navStack.join(" / ");
        } else {
             backBtn.style.display = "none";
             span.innerHTML = "";
        }
    }

    /** ========== SELECTION LOGIC ========== */

    window.toggleItem = function(id, el) {
        if(el.checked) {
            if(!App.selectedIds.includes(id)) App.selectedIds.push(id);
            el.closest('.select-row').classList.add('active');
        } else {
            App.selectedIds = App.selectedIds.filter(x => x !== id);
            el.closest('.select-row').classList.remove('active');
        }
        syncSelectAllUI();
        updateFab();
    }

    window.toggleSelectAll = function(el) {
        if(App.navStack.length < 3) return; // Must be at Leaf view (Chapter)
        
        const term = App.navStack[0];
        const subj = App.navStack[1];
        const lsn = App.navStack[2];

        // All keys in CURRENT view
        const currentChapters = Object.keys(App.currentPointer); // e.g. ["Acromegaly", "Other"]
        const fullIds = currentChapters.map(c => `${term}|${subj}|${lsn}|${c}`);

        if(el.checked) {
            // Select All Visible
            fullIds.forEach(id => {
                if(!App.selectedIds.includes(id)) App.selectedIds.push(id);
            });
            // Visual
            document.querySelectorAll('.select-row').forEach(r => {
                r.classList.add('active');
                r.querySelector('input').checked = true;
            });
        } else {
            // Deselect All Visible
            App.selectedIds = App.selectedIds.filter(id => !fullIds.includes(id));
            // Visual
            document.querySelectorAll('.select-row').forEach(r => {
                r.classList.remove('active');
                r.querySelector('input').checked = false;
            });
        }
        updateFab();
    }

    function syncSelectAllUI() {
        if(App.navStack.length < 3) return;
        const term = App.navStack[0]; const subj = App.navStack[1]; const lsn = App.navStack[2];
        const visibleIds = Object.keys(App.currentPointer).map(k => `${term}|${subj}|${lsn}|${k}`);
        
        const allSelected = visibleIds.length > 0 && visibleIds.every(id => App.selectedIds.includes(id));
        document.getElementById('chkAll').checked = allSelected;
    }

    function updateFab() {
        const count = App.selectedIds.length;
        document.getElementById('sel-count').innerText = count;
        const fab = document.getElementById('fab');
        fab.style.display = count > 0 ? 'block' : 'none';
    }

    /** ========== SETUP & QUIZ ========== */
    
    function goToSetup() {
        setView('v-setup');
        document.getElementById('setup-count').innerText = `${App.selectedIds.length} ÙØµÙˆÙ„ Ù…Ø®ØªØ§Ø±Ø©`;
        document.getElementById('empty-msg').style.display = 'none';
    }

    function backToBrowser() {
        if(App.mistakeModeActive) { goHome(); return; }
        
        // Return to last browser state
        setView('v-browser'); 
        updateFab();
    }

    // Config Setters
    window.setMode = (m, e) => {
        App.setup.mode = m;
        document.querySelector('#modeChips').querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
        e.classList.add('selected');
    }
    window.setQty = (q, e) => {
        App.setup.qty = q;
        document.querySelector('#qtyChips').querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
        e.classList.add('selected');
    }

    window.enterMistakesMode = function() {
        const hasWrongs = App.data.some(q => App.userProgress[q.id] === 'wrong');
        if(!hasWrongs) { alert("Ù…Ù…ØªØ§Ø²! Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø£Ø®Ø·Ø§Ø¡ Ù…Ø³Ø¬Ù„Ø©."); return; }
        
        App.mistakeModeActive = true;
        goToSetup();
        document.getElementById('setup-count').innerText = "Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡";
        window.setMode('mistake', document.querySelectorAll('#modeChips .chip')[1]);
    }

    window.launchQuiz = function() {
        let pool = [];

        if(App.mistakeModeActive) {
            pool = App.data; // Filter later by mode
        } else {
            // Use _key logic.
            // _key = Term|Subject|Lesson|Chapter
            pool = App.data.filter(q => App.selectedIds.includes(q._key));
        }

        // Apply Mode
        const m = App.setup.mode;
        if(m === 'new') pool = pool.filter(q => App.userProgress[q.id] !== 'correct');
        else if(m === 'mistake') pool = pool.filter(q => App.userProgress[q.id] === 'wrong');

        if(pool.length === 0) {
            document.getElementById('empty-msg').style.display = 'block';
            return;
        }

        pool.sort(()=>Math.random()-0.5);
        App.queue = pool.slice(0, App.setup.qty);
        App.qIndex = 0;
        
        App.mistakeModeActive = false;
        renderQuiz();
    }

    function renderQuiz() {
        setView('v-quiz');
        const Q = App.queue[App.qIndex];
        
        document.getElementById('q-progress').innerText = `Ø³Ø¤Ø§Ù„: ${App.qIndex+1} / ${App.queue.length}`;
        document.getElementById('q-id').innerText = `ID: ${Q.id}`;

        const c = document.getElementById('q-content');
        let html = '';
        if(Q.image) html += `<img src="${Q.image}" style="width:100%; border-radius:12px; margin-bottom:15px">`;
        html += `<div class="q-text">${Q.question}</div>`;
        html += `<div id="opt-container"></div>`;
        html += `<div id="expl-box" style="display:none; background:#ecfdf5; padding:15px; border-radius:12px; margin-top:15px; line-height:1.5; color:#064e3b"></div>`;
        html += `<button id="nxt-btn" onclick="nextQ()" class="btn-action" style="margin-top:20px; display:none">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ</button>`;
        
        c.innerHTML = html;

        if(Q.type === 'matching') {
            c.innerHTML += `<p style='color:red;text-align:center'>Ø³Ø¤Ø§Ù„ ØªÙˆØµÙŠÙ„ - ØªØ®Ø·ÙŠ</p>`;
            document.getElementById('nxt-btn').style.display='block';
            return;
        }

        Q.options.forEach((txt, i) => {
            const btn = document.createElement('div');
            btn.className = 'opt-btn';
            btn.innerText = txt;
            btn.onclick = () => answer(i, Q, btn);
            document.getElementById('opt-container').appendChild(btn);
        });
        window.scrollTo(0,0);
    }

    function answer(i, Q, btn) {
        if(btn.parentElement.classList.contains('locked')) return;
        btn.parentElement.classList.add('locked');

        const isCorrect = (i === Q.correct_option_id);
        btn.classList.add(isCorrect ? 'correct' : 'wrong');
        
        if(!isCorrect) {
             btn.parentElement.children[Q.correct_option_id].classList.add('correct');
        }

        if(Q.explanation) {
             const box = document.getElementById('expl-box');
             box.style.display='block';
             box.innerHTML = `<b>ØªÙˆØ¶ÙŠØ­:</b><br>${Q.explanation}`;
        }

        const stat = isCorrect ? 'correct' : 'wrong';
        App.userProgress[Q.id] = stat;

        if(DB && UserID !== 'guest') {
             DB.ref(`users/${UserID}/progress/${Q.id}`).set(stat);
             if(isCorrect) DB.ref(`users/${UserID}/totalScore`).transaction(v => (v||0)+1);
             if(TG.initDataUnsafe?.user?.first_name) {
                 DB.ref(`users/${UserID}/name`).set(TG.initDataUnsafe.user.first_name);
             }
        }
        
        document.getElementById('nxt-btn').style.display='block';
    }

    window.nextQ = function() {
        if(App.qIndex < App.queue.length - 1) {
            App.qIndex++;
            renderQuiz();
        } else {
            alert("âœ¨ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!");
            goHome();
            updateScoreHeader();
        }
    }
    
    window.confirmExit = function() {
        if(confirm("Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù†ØŸ")) goHome();
    }

    function updateScoreHeader() {
        const s = Object.values(App.userProgress).filter(x => x==='correct').length;
        document.getElementById('userScore').innerText = s;
    }

    window.openLeaderboard = function() {
        setView('v-leader');
        updateBottomNav(1);
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = `<div style="padding:20px;text-align:center">ØªØ­Ù…ÙŠÙ„...</div>`;
        
        if(!DB) return;

        DB.ref('users').orderByChild('totalScore').limitToLast(25).once('value', snap => {
            let arr = [];
            snap.forEach(c => arr.push({ n: c.val().name||'Ø·Ø§Ù„Ø¨', s: c.val().totalScore||0, me: c.key === UserID }));
            arr.sort((a,b) => b.s - a.s);

            let html = "";
            arr.forEach((u, i) => {
                let badge = `#${i+1}`;
                if(i===0) badge="ğŸ¥‡"; else if(i===1) badge="ğŸ¥ˆ"; else if(i===2) badge="ğŸ¥‰";
                
                html += `
                <div class="rank-item ${u.me ? 'rank-hl' : ''}">
                    <div>${badge} &nbsp; ${u.n} ${u.me?'(Ø£Ù†Øª)':''}</div>
                    <div style="font-weight:bold">${u.s}</div>
                </div>`;
            });
            list.innerHTML = html || "<p style='text-align:center;padding:10px'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>";
        });
    }

    function updateBottomNav(idx) {
        document.querySelectorAll('.nav-btn').forEach((b,i) => {
            if(i===idx) b.classList.add('active'); else b.classList.remove('active');
        });
    }

</script>
</body>
</html>
