<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --light-bg: #f4f6f7;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
        }

        header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.8rem;
        }

        /* Home Screen Grid */
        .grid-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            animation: fadeIn 0.5s ease;
        }

        .menu-card {
            background: white;
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--card-shadow);
            border-bottom: 5px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Specific Card Styles */
        .card-start { border-color: var(--secondary-color); }
        .card-mistakes { border-color: var(--accent-color); }
        .card-search { border-color: #f39c12; }
        .card-fav { border-color: #9b59b6; } /* Innovation 1 */
        .card-random { border-color: #2c3e50; } /* Innovation 2 */

        /* Selection Hierarchy Styles */
        .selection-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            display: none; /* Hidden by default */
        }

        .selection-step {
            margin-bottom: 20px;
            text-align: center;
        }

        .selection-step h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
        }

        .options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .option-btn {
            background: white;
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .option-btn:hover, .option-btn.active {
            background: var(--secondary-color);
            color: white;
        }

        /* Quiz Interface */
        .quiz-container {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--card-shadow);
        }

        .question-meta {
            display: flex;
            justify-content: space-between;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-option {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            text-align: left; /* English questions usually read better LTR alignment even in RTL layout */
            direction: ltr; 
        }

        .quiz-option:hover {
            background-color: #f8f9fa;
        }

        .quiz-option.correct {
            background-color: #d4edda;
            border-color: var(--success-color);
            color: #155724;
        }

        .quiz-option.wrong {
            background-color: #f8d7da;
            border-color: var(--accent-color);
            color: #721c24;
        }

        .explanation-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4fd;
            border-left: 5px solid var(--secondary-color);
            border-radius: 5px;
            display: none;
            direction: ltr;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }

        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            color: white;
        }

        .btn-primary { background-color: var(--secondary-color); }
        .btn-danger { background-color: var(--accent-color); }
        .btn-home { background-color: #95a5a6; }

        .search-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .search-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .search-input {
            width: 80%;
            padding: 10px;
            font-size: 1.2rem;
            margin: 15px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>ğŸ©º Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„</h1>
            <p style="color: #7f8c8d; margin-top: 5px;">Term 7: Endocrine & Surgery</p>
        </header>

        <!-- Main Home Screen -->
        <div id="home-screen" class="grid-menu">
            <!-- Main Button -->
            <div class="menu-card card-start" onclick="startSelectionFlow()">
                <div class="icon">ğŸš€</div>
                <div class="card-title">Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</div>
                <small>Ø§Ø®ØªØ± Ø§Ù„ØªØ±Ù…ØŒ Ø§Ù„Ù…Ø§Ø¯Ø©ØŒ ÙˆØ§Ù„Ø¯Ø±Ø³</small>
            </div>

            <!-- Mistakes Button -->
            <div class="menu-card card-mistakes" onclick="loadMode('mistakes')">
                <div class="icon">âš ï¸</div>
                <div class="card-title">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div>
                <small>Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ Ø£Ø®Ø·Ø£Øª ÙÙŠÙ‡Ø§</small>
            </div>

            <!-- ID Search -->
            <div class="menu-card card-search" onclick="openSearch()">
                <div class="icon">ğŸ”</div>
                <div class="card-title">Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„</div>
                <small>Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¹Ø¨Ø± ID</small>
            </div>

            <!-- Innovation 1: Bookmarks -->
            <div class="menu-card card-fav" onclick="loadMode('bookmarks')">
                <div class="icon">â­</div>
                <div class="card-title">Ø§Ù„Ù…ÙØ¶Ù„Ø©</div>
                <small>Ø£Ø³Ø¦Ù„Ø© Ù‚Ù…Øª Ø¨Ø­ÙØ¸Ù‡Ø§ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</small>
            </div>

            <!-- Innovation 2: Random Challenge -->
            <div class="menu-card card-random" onclick="loadMode('random')">
                <div class="icon">ğŸ²</div>
                <div class="card-title">ØªØ­Ø¯ÙŠ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</div>
                <small>20 Ø³Ø¤Ø§Ù„ Ù…ØªÙ†ÙˆØ¹ Ù„Ù‚ÙŠØ§Ø³ Ù…Ø³ØªÙˆØ§Ùƒ</small>
            </div>
        </div>

        <!-- Selection Screen (Hierarchy) -->
        <div id="selection-screen" class="selection-container">
            <button class="btn btn-home" onclick="goHome()" style="margin-bottom: 15px;">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            
            <div id="step-term" class="selection-step">
                <h3>1. Ø§Ø®ØªØ± Ø§Ù„ØªØ±Ù… (Term)</h3>
                <div class="options-grid" id="term-options"></div>
            </div>

            <div id="step-subject" class="selection-step" style="display:none;">
                <h3>2. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© (Subject)</h3>
                <div class="options-grid" id="subject-options"></div>
            </div>

            <div id="step-lesson" class="selection-step" style="display:none;">
                <h3>3. Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³ (Lesson)</h3>
                <div class="options-grid" id="lesson-options"></div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="quiz-container">
            <div class="question-meta">
                <span id="q-counter">Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 10</span>
                <span id="q-id">ID: 0000</span>
                <span id="q-category" style="direction: ltr;">Category</span>
                <span id="fav-btn" style="cursor: pointer;" onclick="toggleBookmark()">â˜† Ø­ÙØ¸</span>
            </div>

            <div class="question-text" id="question-text" style="direction: ltr;">
                Loading...
            </div>

            <div class="options-list" id="options-container">
                <!-- Options go here -->
            </div>

            <div class="explanation-box" id="explanation">
                <strong>Explanation:</strong> <span id="explanation-text"></span>
            </div>

            <div class="controls">
                <button class="btn btn-home" onclick="goHome()">Ø¥Ù†Ù‡Ø§Ø¡</button>
                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display:none;">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="search-modal" onclick="closeSearch(event)">
        <div class="search-content">
            <h3>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„ (ID)</h3>
            <input type="number" id="search-id-input" class="search-input" placeholder="Ù…Ø«Ø§Ù„: 7650">
            <br>
            <button class="btn btn-primary" onclick="executeSearch()">Ø¨Ø­Ø«</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. DATA LOADING (Simulated Merge)
        // ==========================================
        
        // In a real app, you would fetch these. Here we embed them for the demo to work.
        const file1Data = {
          "meta": { "source": "Term 7 - Endocrine", "lesson": "Diabetes" },
          "questions": [
            { "id": 7650, "question": "A 24-year-old woman with Type 1 diabetes (6 years) on insulin asks about congenital malformation risk. What is the relative risk in infants of diabetic mothers compared with non-diabetics?", "options": ["No increased risk", "2-4 fold increased risk", "8-10 fold", "6-8 fold", "> 10-fold increased risk"], "correct_option_id": 1, "explanation": "Maternal diabetes with suboptimal control during organogenesis increases the risk of congenital malformations (e.g., cardiac, neural tube) by 2-4 fold compared to the general population.", "term": "Term 7", "subject": "Endocrine", "lesson": "Diabetes" },
            { "id": 7651, "question": "A 30-year-old man with insulin-dependent diabetes and hypothyroidism develops fatigue, weight loss, and increasing pigmentation of the skin and buccal mucosa. The most likely cause of the recent complaint is:", "options": ["Vitiligo.", "Pan hypopituitarism.", "Addison's disease.", "Celiac disease.", "Peutz-jeghers syndrome."], "correct_option_id": 2, "explanation": "This indicates Schmidt's Syndrome (APS Type 2): T1DM, Thyroid disease, and Addison's.", "term": "Term 7", "subject": "Endocrine", "lesson": "Diabetes" },
            { "id": 8250, "question": "Which of the following hernias follows the path of the spermatic cord within the cremaster muscle?", "options": ["Direct inguinal", "Femoral", "Indirect inguinal", "Interparietal", "Spigelian"], "correct_option_id": 2, "explanation": "Indirect hernias traverse the deep ring and travel inside the spermatic cord, covered by cremaster muscle.", "term": "Term 7", "subject": "General Surgery", "lesson": "Hernia" },
            { "id": 8251, "question": "The cremaster muscle is derived from:", "options": ["Conjoint tendon", "External oblique aponeurosis", "Internal oblique muscle", "Transversus abdominis muscle", "Transversalis Fascia"], "correct_option_id": 2, "explanation": "As the testis descends through the abdominal wall, it pulls muscle fibers from the internal oblique muscle.", "term": "Term 7", "subject": "General Surgery", "lesson": "Hernia" }
            // Note: I have included a sample. In the full version, all questions from your files would be here.
            // For the sake of this code running, I am using the first few from your input as an example.
            // TO USE FULL DATA: Paste the entire content of the 'questions' arrays from both files into this array.
          ]
        };

        // Let's populate with more data from your prompt to make it realistic
        // I will add a script logic to parse your provided text if this was a backend, 
        // but here I will expand the dataset manually with a few more examples from your JSONs.
        
        const allQuestions = [
            ...file1Data.questions,
            // Adding a few more from your Endocrine file
            { "id": 7662, "question": "Diabetic ketoacidosis caused by:", "options": ["Insulin deficiency.", "Glucagon colitis.", "Both."], "correct_option_id": 0, "explanation": "DKA is primarily driven by absolute or relative insulin deficiency.", "term": "Term 7", "subject": "Endocrine", "lesson": "Diabetes" },
            // Adding a few more from your Surgery file
            { "id": 8261, "question": "The overall ratio of indirect to direct inguinal hernia is:", "options": ["2:1 (indirect : direct)", "1:1 (indirect : direct)", "1:2 (indirect : direct)", "1:3 (indirect : direct)"], "correct_option_id": 0, "explanation": "Indirect inguinal hernias are the most common type of hernia overall.", "term": "Term 7", "subject": "General Surgery", "lesson": "Hernia" },
            { "id": 8295, "question": "Which of the following is not a complication of an inguinal hernia?", "options": ["Irreducibility.", "Inflammation.", "Strangulation.", "Obstruction.", "Bleeding."], "correct_option_id": 4, "explanation": "Bleeding is not a complication of the hernia condition itself.", "term": "Term 7", "subject": "General Surgery", "lesson": "Hernia" }
        ];

        // ==========================================
        // 2. STATE MANAGEMENT
        // ==========================================
        let currentQuizQueue = [];
        let currentIndex = 0;
        let mistakes = JSON.parse(localStorage.getItem('medQuizMistakes')) || [];
        let bookmarks = JSON.parse(localStorage.getItem('medQuizBookmarks')) || [];

        // ==========================================
        // 3. UI LOGIC - NAVIGATION
        // ==========================================

        function goHome() {
            document.getElementById('home-screen').style.display = 'grid';
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('quiz-screen').style.display = 'none';
            resetSelection();
        }

        function startSelectionFlow() {
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('selection-screen').style.display = 'block';
            
            // Step 1: Render Terms
            const terms = [...new Set(allQuestions.map(q => q.term))];
            renderOptions('term-options', terms, handleTermSelect);
        }

        function renderOptions(containerId, items, callback) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = item;
                btn.onclick = () => {
                    // Visual feedback
                    Array.from(container.children).forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    callback(item);
                };
                container.appendChild(btn);
            });
        }

        let selectedTerm = null;
        let selectedSubject = null;

        function handleTermSelect(term) {
            selectedTerm = term;
            document.getElementById('step-subject').style.display = 'block';
            document.getElementById('step-lesson').style.display = 'none'; // reset
            
            // Filter Subjects based on Term
            const subjects = [...new Set(allQuestions.filter(q => q.term === term).map(q => q.subject))];
            renderOptions('subject-options', subjects, handleSubjectSelect);
        }

        function handleSubjectSelect(subject) {
            selectedSubject = subject;
            document.getElementById('step-lesson').style.display = 'block';

            // Filter Lessons based on Term & Subject
            const lessons = [...new Set(allQuestions.filter(q => q.term === selectedTerm && q.subject === subject).map(q => q.lesson))];
            renderOptions('lesson-options', lessons, handleLessonSelect);
        }

        function handleLessonSelect(lesson) {
            // Start Quiz with filtered data
            const questions = allQuestions.filter(q => 
                q.term === selectedTerm && 
                q.subject === selectedSubject && 
                q.lesson === lesson
            );
            startQuiz(questions);
        }

        function resetSelection() {
            selectedTerm = null;
            selectedSubject = null;
            document.getElementById('step-subject').style.display = 'none';
            document.getElementById('step-lesson').style.display = 'none';
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
        }

        // ==========================================
        // 4. SPECIAL MODES
        // ==========================================

        function loadMode(mode) {
            let queue = [];
            if (mode === 'mistakes') {
                if (mistakes.length === 0) { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†!'); return; }
                queue = allQuestions.filter(q => mistakes.includes(q.id));
            } else if (mode === 'bookmarks') {
                if (bookmarks.length === 0) { alert('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙØ§Ø±ØºØ©!'); return; }
                queue = allQuestions.filter(q => bookmarks.includes(q.id));
            } else if (mode === 'random') {
                // Shuffle and pick 20
                queue = [...allQuestions].sort(() => 0.5 - Math.random()).slice(0, 20);
            }

            if (queue.length > 0) {
                document.getElementById('home-screen').style.display = 'none';
                startQuiz(queue);
            }
        }

        function openSearch() {
            document.getElementById('search-modal').style.display = 'flex';
            document.getElementById('search-id-input').focus();
        }

        function closeSearch(e) {
            if (e.target.id === 'search-modal') {
                document.getElementById('search-modal').style.display = 'none';
            }
        }

        function executeSearch() {
            const id = parseInt(document.getElementById('search-id-input').value);
            const question = allQuestions.find(q => q.id === id);
            
            if (question) {
                document.getElementById('search-modal').style.display = 'none';
                document.getElementById('home-screen').style.display = 'none';
                startQuiz([question]);
            } else {
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù….');
            }
        }

        // ==========================================
        // 5. QUIZ ENGINE
        // ==========================================

        function startQuiz(questions) {
            currentQuizQueue = questions;
            currentIndex = 0;
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('quiz-screen').style.display = 'block';
            showQuestion();
        }

        function showQuestion() {
            const q = currentQuizQueue[currentIndex];
            
            // Update Meta
            document.getElementById('q-counter').innerText = `Ø³Ø¤Ø§Ù„ ${currentIndex + 1} Ù…Ù† ${currentQuizQueue.length}`;
            document.getElementById('q-id').innerText = `ID: ${q.id}`;
            document.getElementById('q-category').innerText = `${q.subject} > ${q.lesson}`;
            updateFavIcon(q.id);

            // Update Text
            document.getElementById('question-text').innerText = q.question;
            
            // Render Options
            const optsContainer = document.getElementById('options-container');
            optsContainer.innerHTML = '';
            document.getElementById('explanation').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';

            q.options.forEach((opt, idx) => {
                const div = document.createElement('div');
                div.className = 'quiz-option';
                div.innerText = opt;
                div.onclick = () => handleAnswer(idx, q);
                optsContainer.appendChild(div);
            });
        }

        function handleAnswer(selectedIndex, qData) {
            // Prevent multiple clicks
            if (document.getElementById('explanation').style.display === 'block') return;

            const opts = document.querySelectorAll('.quiz-option');
            const correctIndex = qData.correct_option_id;

            // Mark styles
            opts[correctIndex].classList.add('correct');
            if (selectedIndex !== correctIndex) {
                opts[selectedIndex].classList.add('wrong');
                saveMistake(qData.id);
            } else {
                removeMistake(qData.id); // If answered correctly now, remove from mistakes list
            }

            // Show Explanation
            document.getElementById('explanation-text').innerText = qData.explanation || "No explanation provided.";
            document.getElementById('explanation').style.display = 'block';
            
            // Show Next Button
            if (currentIndex < currentQuizQueue.length - 1) {
                document.getElementById('next-btn').style.display = 'block';
            }
        }

        function nextQuestion() {
            currentIndex++;
            showQuestion();
        }

        // ==========================================
        // 6. STORAGE HELPERS
        // ==========================================

        function saveMistake(id) {
            if (!mistakes.includes(id)) {
                mistakes.push(id);
                localStorage.setItem('medQuizMistakes', JSON.stringify(mistakes));
            }
        }

        function removeMistake(id) {
            const idx = mistakes.indexOf(id);
            if (idx > -1) {
                mistakes.splice(idx, 1);
                localStorage.setItem('medQuizMistakes', JSON.stringify(mistakes));
            }
        }

        function toggleBookmark() {
            const currentId = currentQuizQueue[currentIndex].id;
            const idx = bookmarks.indexOf(currentId);
            
            if (idx > -1) {
                bookmarks.splice(idx, 1);
            } else {
                bookmarks.push(currentId);
            }
            localStorage.setItem('medQuizBookmarks', JSON.stringify(bookmarks));
            updateFavIcon(currentId);
        }

        function updateFavIcon(id) {
            const btn = document.getElementById('fav-btn');
            if (bookmarks.includes(id)) {
                btn.innerText = "â˜… Ù…Ø­ÙÙˆØ¸";
                btn.style.color = "#f39c12";
            } else {
                btn.innerText = "â˜† Ø­ÙØ¸";
                btn.style.color = "#7f8c8d";
            }
        }

    </script>
</body>
</html>
