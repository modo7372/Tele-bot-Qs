<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MedQuiz Elite V8.1</title>
    
    <!-- Scripts loaded traditionally -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        /* --- THEMES & VARIABLES --- */
        :root {
            --primary: #3b82f6; --primary-dark: #2563eb;
            --bg: #f8fafc; --surface: #ffffff;
            --text-main: #1e293b; --text-sub: #64748b;
            --border: #e2e8f0;
            --font-size: 16px;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg: #0f172a; --surface: #1e293b; 
            --text-main: #f1f5f9; --text-sub: #94a3b8; 
            --border: #334155; --primary: #60a5fa;
            --shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        [data-theme="sepia"] {
            --bg: #f4ecd8; --surface: #fdf6e3; 
            --text-main: #433422; --text-sub: #5c5548; 
            --border: #dcd2b8; --primary: #a05a2c;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; font-family: system-ui, -apple-system, sans-serif; }
        
        body {
            background-color: var(--bg); color: var(--text-main); font-size: var(--font-size);
            margin: 0; padding-bottom: 100px;
            transition: background 0.3s, color 0.3s;
            user-select: none;
        }

        /* HEADER */
        .app-bar {
            background: var(--surface); padding: 15px 20px;
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-bottom: 1px solid var(--border);
        }
        .logo { font-weight: 800; font-size: 1.2em; color: var(--primary); }
        .icon-btn { background: none; border: none; font-size: 1.4em; cursor: pointer; color: var(--text-main); }

        /* CARDS */
        .nav-card {
            background: var(--surface); padding: 20px; margin-bottom: 12px;
            border-radius: var(--radius); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow); cursor: pointer;
        }
        .nav-card:active { transform: scale(0.98); opacity: 0.8; }
        .count-badge { background: var(--bg); border: 1px solid var(--border); padding: 4px 8px; border-radius: 6px; font-size: 0.8em; font-weight: bold; }

        /* CHECKBOX ROWS */
        .check-row {
            background: var(--surface); padding: 15px; margin-bottom: 10px;
            border-radius: var(--radius); border: 1px solid var(--border);
            display: flex; align-items: center; cursor: pointer;
        }
        .check-row.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        
        .chk-visual {
            width: 24px; height: 24px; border: 2px solid var(--text-sub); border-radius: 6px;
            margin-left: 15px; display: flex; align-items: center; justify-content: center;
        }
        .check-row.selected .chk-visual { border-color: var(--primary); background: var(--primary); }
        .chk-visual::after { content: 'âœ”'; color: white; font-size: 0.9em; display: none; }
        .check-row.selected .chk-visual::after { display: block; }
        
        /* SELECT ALL BOX */
        .select-all-box {
            background: var(--surface); padding: 15px; border-radius: var(--radius);
            border: 2px solid var(--border); display: flex; align-items: center; margin-bottom: 20px;
            cursor: pointer;
        }
        .select-all-box.active { border-color: var(--primary); }
        .select-all-box.active .chk-visual { background: var(--primary); border-color: var(--primary); }
        
        /* QUIZ */
        .q-meta { display:flex; justify-content:space-between; margin-bottom:15px; font-size:0.85em; color:var(--text-sub); background:rgba(0,0,0,0.03); padding:8px; border-radius:8px; }
        .q-txt { font-weight: 700; font-size: 1.15em; line-height: 1.5; margin: 15px 0; }
        .opt-btn {
            width: 100%; padding: 15px; margin-bottom: 10px; border-radius: var(--radius);
            background: var(--surface); border: 2px solid transparent; color: var(--text-main);
            text-align: right; cursor: pointer; font-size: 1em; box-shadow: var(--shadow);
        }
        .opt-btn.correct { background: #d1fae5; border-color: #10b981; color: #064e3b; }
        .opt-btn.wrong { background: #fee2e2; border-color: #ef4444; color: #7f1d1d; }
        .expl-box { display:none; margin-top:20px; padding:15px; background:rgba(245, 158, 11, 0.1); border-right:4px solid #f59e0b; border-radius:8px; }

        /* FAB */
        .fab-container {
            position: fixed; bottom: 20px; left: 0; right: 0; 
            padding: 0 20px; z-index: 200; pointer-events: none;
            display: flex; justify-content: center;
        }
        .fab {
            background: var(--primary); color: white;
            padding: 15px 40px; border-radius: 50px; font-weight: 800;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: none; cursor: pointer;
            pointer-events: auto; display: none;
        }
        .fab.visible { display: block; animation: popUp 0.3s; }
        @keyframes popUp { from{transform:translateY(100px)} to{transform:translateY(0)} }

        /* VIEWS */
        .view-section { display: none; padding: 20px; max-width: 800px; margin: 0 auto; }
        .view-section.active { display: block; animation: fadeUp 0.3s; }
        @keyframes fadeUp { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

        /* BREADCRUMB */
        .breadcrumb { margin-bottom: 20px; color: var(--text-sub); display: flex; align-items: center; gap: 5px; font-size: 0.9em; }
        .bc-link { color: var(--primary); font-weight: bold; cursor: pointer; }

        /* SETTINGS MODAL */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300;
            display: none; align-items: flex-end; 
        }
        .modal-content {
            background: var(--surface); width: 100%; border-radius: 20px 20px 0 0;
            padding: 25px; animation: slideUp 0.3s;
        }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        .set-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg); margin-left: 5px; cursor: pointer; color: var(--text-main); }
        .set-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    </style>
</head>
<body>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
            <div style="margin-bottom:20px">
                <p>Ø§Ù„Ù…Ø¸Ù‡Ø±:</p>
                <button class="set-btn active" id="btn-theme-light" onclick="setTheme('light')">â˜€ï¸ ÙØ§ØªØ­</button>
                <button class="set-btn" id="btn-theme-dark" onclick="setTheme('dark')">ğŸŒ‘ Ù…Ø¸Ù„Ù…</button>
                <button class="set-btn" id="btn-theme-sepia" onclick="setTheme('sepia')">ğŸ“– Ù‚Ø±Ø§Ø¡Ø©</button>
            </div>
            <div style="margin-bottom:20px">
                <p>Ø§Ù„Ø®Ø·:</p>
                <button class="set-btn" id="btn-font-14" onclick="setFont(14)">ØµØºÙŠØ±</button>
                <button class="set-btn active" id="btn-font-16" onclick="setFont(16)">ÙˆØ³Ø·</button>
                <button class="set-btn" id="btn-font-18" onclick="setFont(18)">ÙƒØ¨ÙŠØ±</button>
            </div>
            <button onclick="closeSettings()" style="width:100%; padding:15px; background:var(--primary); color:#fff; border:none; border-radius:12px">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- APP BAR -->
    <div class="app-bar">
        <button class="icon-btn" onclick="openSettings()">âš™ï¸</button>
        <div class="logo">MedQuiz Elite</div>
        <div style="font-weight:700">#<span id="q-counter">0</span></div>
    </div>

    <!-- VIEWS CONTAINER -->
    <div id="main-container">
        
        <!-- Loader -->
        <div id="v-loader" class="view-section active" style="text-align:center; padding-top:100px;">
            <div style="font-size:3em">ğŸ“¥</div>
            <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h3>
        </div>

        <!-- 1. Source (Term) -->
        <div id="v-source" class="view-section">
            <h2>Ø§Ø®ØªØ± Ø§Ù„ØªØ±Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</h2>
            <div id="list-source"></div>
        </div>

        <!-- 2. Subject -->
        <div id="v-subject" class="view-section">
            <div class="breadcrumb"><span class="bc-link" onclick="goBack('source')">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span> / Ø§Ù„Ù…Ø§Ø¯Ø©</div>
            <h2>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©:</h2>
            <div id="list-subject"></div>
        </div>

        <!-- 3. Lesson -->
        <div id="v-lesson" class="view-section">
            <div class="breadcrumb"><span class="bc-link" onclick="goBack('subject')">...</span> / <span id="bread-subj"></span></div>
            <h2>Ø­Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³:</h2>
            
            <div class="select-all-box" id="lesson-all-btn" onclick="toggleAllLessons()">
                <div class="chk-visual"></div>
                <div class="label" style="margin-right:15px">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</div>
            </div>
            
            <div id="list-lesson"></div>
        </div>

        <!-- 4. Chapter -->
        <div id="v-chapter" class="view-section">
            <div class="breadcrumb"><span class="bc-link" onclick="goBack('lesson')">...</span> / ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØµÙˆÙ„</div>
            <h2>Ø­Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ (Topics):</h2>
            
            <div class="select-all-box" id="chap-all-btn" onclick="toggleAllChapters()">
                <div class="chk-visual"></div>
                <div class="label" style="margin-right:15px">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</div>
            </div>
            
            <div id="list-chapter"></div>
            <div style="height: 100px;"></div>
        </div>

        <!-- 5. Quiz -->
        <div id="v-quiz" class="view-section">
            <div class="breadcrumb"><span class="bc-link" onclick="exitQuiz()">Ø¥Ù†Ù‡Ø§Ø¡ âœ–</span></div>
            
            <div class="q-meta">
                <span id="q-ctx">...</span>
                <span>ID: <span id="q-id"></span></span>
            </div>
            
            <div id="q-content"></div>
        </div>
        
    </div>

    <!-- FAB -->
    <div class="fab-container">
        <button id="fab-action" class="fab"></button>
    </div>

<script>
    /** 
     *  ==============================================
     *  CONFIG: INSERT YOUR FIREBASE DATA HERE ğŸ‘‡
     *  ==============================================
     */
    const FIREBASE_CONFIG = {        
        apiKey: "AIzaSyDEZFJmcXK2LxYAZ-Yjv_M1HbC6zi_qilg",
        authDomain: "exambotdb.firebaseapp.com",
        databaseURL: "https://exambotdb-default-rtdb.firebaseio.com",
        projectId: "exambotdb",
        storageBucket: "exambotdb.firebasestorage.app",
        messagingSenderId: "950600562980",
        appId: "1:950600562980:web:f993c22d45e5cfdd3d9bb1"      
    };
    /* ============================================== */


    const App = {
        data: [], tree: {}, 
        nav: { source:null, subject:null },
        selection: { lessons: new Set(), chapters: new Set() },
        quiz: { queue: [], idx: 0 },
        settings: { theme: 'light', font: 16 }
    };

    window.onload = function() {
        if(window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        // Firebase Init
        if(window.firebase && !firebase.apps.length) {
            try {
                firebase.initializeApp(FIREBASE_CONFIG);
            } catch(e) { console.error("Firebase Config Error:", e); }
        }

        loadSettings();
        fetchData();
    };

    /* DATA LOADING */
    async function fetchData() {
        try {
            const listRes = await fetch('questions_list.json?nocache=' + Date.now());
            const files = await listRes.json();
            
            const fetches = files.map(f => fetch('Questions/' + f).then(r => r.json()));
            const responses = await Promise.all(fetches);

            responses.forEach(json => {
                const src = json.meta?.source || "Other";
                const sub = json.meta?.subject || "General";
                const lsn = json.meta?.lesson || "Misc";

                if (!App.tree[src]) App.tree[src] = {};
                if (!App.tree[src][sub]) App.tree[src][sub] = {};
                if (!App.tree[src][sub][lsn]) App.tree[src][sub][lsn] = {};

                json.questions.forEach(q => {
                    const chap = q.chapter || "General";
                    // Append Context
                    q._ctx = { s: src, su: sub, l: lsn, c: chap };
                    
                    if (!App.tree[src][sub][lsn][chap]) App.tree[src][sub][lsn][chap] = [];
                    App.tree[src][sub][lsn][chap].push(q);
                });
            });

            showView('v-source');
            renderSources();
        } catch(e) {
            console.error(e);
            document.querySelector('#v-loader h3').innerText = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª!";
        }
    }

    /* HELPERS */
    function getCount(node) {
        if(Array.isArray(node)) return node.length;
        return Object.values(node).reduce((s, c) => s + getCount(c), 0);
    }

    function showView(id) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('fab-action').classList.remove('visible');
        window.scrollTo(0,0);
    }

    function goBack(to) {
        if(to === 'source') { showView('v-source'); }
        if(to === 'subject') { renderSubjects(); }
        if(to === 'lesson') { renderLessons(); }
    }

    /* RENDERERS */
    
    // 1. Source
    function renderSources() {
        const div = document.getElementById('list-source');
        div.innerHTML = '';
        Object.keys(App.tree).forEach(k => {
            const count = getCount(App.tree[k]);
            div.innerHTML += cardHTML(k, count, `navToSubject('${k}')`);
        });
    }

    window.navToSubject = (key) => {
        App.nav.source = key;
        renderSubjects();
    };

    // 2. Subject
    function renderSubjects() {
        const div = document.getElementById('list-subject');
        div.innerHTML = '';
        const node = App.tree[App.nav.source];
        
        Object.keys(node).forEach(k => {
            const count = getCount(node[k]);
            div.innerHTML += cardHTML(k, count, `navToLesson('${k}')`);
        });
        showView('v-subject');
    }

    window.navToLesson = (key) => {
        App.nav.subject = key;
        // Reset Lower Selection on new path for safety
        App.selection.lessons.clear(); 
        renderLessons();
    };

    // 3. Lessons
    function renderLessons() {
        const div = document.getElementById('list-lesson');
        div.innerHTML = '';
        document.getElementById('bread-subj').innerText = App.nav.subject;

        const node = App.tree[App.nav.source][App.nav.subject];
        const allKeys = Object.keys(node);

        allKeys.forEach(k => {
            const fullKey = `${App.nav.source}|${App.nav.subject}|${k}`;
            const count = getCount(node[k]);
            const isSel = App.selection.lessons.has(fullKey);

            div.innerHTML += checkHTML('lesson', fullKey, k, count, isSel);
        });

        updateSelectAll('lesson-all-btn', allKeys.length > 0 && allKeys.every(k => App.selection.lessons.has(`${App.nav.source}|${App.nav.subject}|${k}`)));
        updateLessonFab();
        showView('v-lesson');
    }

    window.toggleCheck = (type, key, el) => {
        const set = type === 'lesson' ? App.selection.lessons : App.selection.chapters;
        if(set.has(key)) set.delete(key); else set.add(key);
        
        // Re-render to update UI consistency
        if(type === 'lesson') renderLessons();
        if(type === 'chapter') renderChapters(); // efficient enough for this list size
    };

    // 4. Chapters
    function renderChapters() {
        const div = document.getElementById('list-chapter');
        div.innerHTML = '';
        let totalChaps = 0;
        let selectedChaps = 0;

        const src = App.nav.source; const sub = App.nav.subject;
        
        App.selection.lessons.forEach(lFull => {
            const lName = lFull.split('|')[2];
            const chObj = App.tree[src][sub][lName];

            div.innerHTML += `<div style="margin:20px 0 10px; color:var(--primary); font-weight:bold; border-bottom:1px solid #ccc">ğŸ“‚ ${lName}</div>`;
            
            Object.keys(chObj).forEach(cName => {
                const fullKey = `${src}|${sub}|${lName}|${cName}`;
                
                // AUTO SELECT Logic: If newly seen, assume selected? 
                // For simplicity: Default checked if we just arrived from lessons
                // Here we simply check the Set.
                if(!App.selection.chapters.has(fullKey)) App.selection.chapters.add(fullKey); // Force auto-select

                const qArr = chObj[cName];
                const isSel = App.selection.chapters.has(fullKey);
                
                div.innerHTML += checkHTML('chapter', fullKey, cName, qArr.length, isSel);
                totalChaps++;
                if(isSel) selectedChaps++;
            });
        });

        updateSelectAll('chap-all-btn', totalChaps > 0 && selectedChaps === totalChaps);
        updateChapterFab();
        showView('v-chapter');
    }

    // Toggle All Logic
    window.toggleAllLessons = () => {
        const node = App.tree[App.nav.source][App.nav.subject];
        const keys = Object.keys(node).map(k => `${App.nav.source}|${App.nav.subject}|${k}`);
        
        const allSel = keys.every(k => App.selection.lessons.has(k));
        if(allSel) keys.forEach(k => App.selection.lessons.delete(k));
        else keys.forEach(k => App.selection.lessons.add(k));
        
        renderLessons();
    };

    window.toggleAllChapters = () => {
        // We toggle all visible chapters in the current selected lessons
        const src = App.nav.source; const sub = App.nav.subject;
        let allKeys = [];
        
        App.selection.lessons.forEach(lFull => {
            const l = lFull.split('|')[2];
            Object.keys(App.tree[src][sub][l]).forEach(c => allKeys.push(`${src}|${sub}|${l}|${c}`));
        });

        const allSel = allKeys.every(k => App.selection.chapters.has(k));
        if(allSel) allKeys.forEach(k => App.selection.chapters.delete(k));
        else allKeys.forEach(k => App.selection.chapters.add(k));
        
        renderChapters();
    };

    function updateSelectAll(id, active) {
        const btn = document.getElementById(id);
        if(active) btn.classList.add('active'); else btn.classList.remove('active');
    }

    /* FAB UPDATERS */
    function updateLessonFab() {
        const btn = document.getElementById('fab-action');
        const count = App.selection.lessons.size;
        if(count > 0) {
            btn.innerHTML = `Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙˆÙ„ â¬…ï¸`;
            btn.onclick = () => renderChapters();
            btn.classList.add('visible');
        } else {
            btn.classList.remove('visible');
        }
    }

    function updateChapterFab() {
        const btn = document.getElementById('fab-action');
        
        // Count questions
        let qCount = 0;
        const src = App.nav.source; const sub = App.nav.subject;
        App.selection.chapters.forEach(key => {
            const parts = key.split('|'); // s|su|l|c
            qCount += App.tree[src][sub][parts[2]][parts[3]].length;
        });

        if(qCount > 0) {
            btn.innerHTML = `Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (${qCount} Ø³Ø¤Ø§Ù„) ğŸš€`;
            btn.onclick = () => startQuiz(qCount);
            btn.classList.add('visible');
        } else {
            btn.classList.remove('visible');
        }
    }

    /* QUIZ */
    function startQuiz(total) {
        App.quiz.queue = [];
        const src = App.nav.source; const sub = App.nav.subject;
        
        App.selection.chapters.forEach(key => {
            const parts = key.split('|');
            const arr = App.tree[src][sub][parts[2]][parts[3]];
            App.quiz.queue.push(...arr);
        });

        App.quiz.queue.sort(() => Math.random() - 0.5);
        App.quiz.idx = 0;
        
        renderQuestion();
    }

    function renderQuestion() {
        showView('v-quiz');
        const q = App.quiz.queue[App.quiz.idx];
        const total = App.quiz.queue.length;

        document.getElementById('q-counter').innerText = `${App.quiz.idx + 1} / ${total}`;
        document.getElementById('q-id').innerText = q.id;
        document.getElementById('q-ctx').innerText = `${q._ctx.l} > ${q._ctx.c}`;

        const box = document.getElementById('q-content');
        box.innerHTML = `<div class="q-txt">${q.question}</div><div id="opts"></div><div class="expl-box" id="expl"></div>`;
        
        const opts = document.getElementById('opts');
        q.options.forEach((txt, i) => {
             const btn = document.createElement('div');
             btn.className = 'opt-btn'; btn.innerText = txt;
             btn.onclick = () => answer(i, q, btn);
             opts.appendChild(btn);
        });

        const fab = document.getElementById('fab-action');
        fab.classList.remove('visible');
        fab.innerHTML = (App.quiz.idx < total-1) ? "Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸" : "Ø¥Ù†Ù‡Ø§Ø¡ ğŸ";
        fab.onclick = () => { App.quiz.idx++; renderQuestion(); };
    }

    function answer(idx, q, el) {
        if(el.parentElement.classList.contains('locked')) return;
        el.parentElement.classList.add('locked');

        const correct = idx === q.correct_option_id;
        if(correct) {
            el.classList.add('correct');
        } else {
            el.classList.add('wrong');
            el.parentElement.children[q.correct_option_id].classList.add('correct');
        }

        const expl = document.getElementById('expl');
        if(q.explanation) {
            expl.style.display = 'block';
            expl.innerHTML = `<b>ØªÙˆØ¶ÙŠØ­:</b> ${q.explanation}`;
        }
        document.getElementById('fab-action').classList.add('visible');
    }

    window.exitQuiz = () => { if(confirm("Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) location.reload(); };

    /* HTML GENERATORS */
    function cardHTML(title, count, act) {
        return `<div class="nav-card" onclick="${act}">
            <div style="display:flex;align-items:center"><div class="card-icon">ğŸ“‚</div><b style="margin-right:15px">${title}</b></div>
            <span class="count-badge">${count}</span></div>`;
    }

    function checkHTML(type, key, title, count, checked) {
        return `<div class="check-row ${checked?'selected':''}" onclick="toggleCheck('${type}', '${key}', this)">
            <div class="chk-visual"></div>
            <div style="flex:1; margin-right:15px"><b>${title}</b><div style="font-size:0.8em;color:var(--text-sub)">${count} Ø£Ø³Ø¦Ù„Ø©</div></div>
        </div>`;
    }

    /* SETTINGS */
    function loadSettings() {
        const s = localStorage.getItem('MedQuizSet');
        if(s) App.settings = JSON.parse(s);
        applySet();
    }
    
    function applySet() {
        document.documentElement.setAttribute('data-theme', App.settings.theme);
        document.documentElement.style.setProperty('--font-size', App.settings.font+'px');
        
        ['light','dark','sepia'].forEach(t => toggleCls(`btn-theme-${t}`, t === App.settings.theme));
        [14,16,18].forEach(s => toggleCls(`btn-font-${s}`, s === App.settings.font));
    }
    
    function toggleCls(id, active) {
        const e = document.getElementById(id);
        if(active) e.classList.add('active'); else e.classList.remove('active');
    }

    window.openSettings = () => document.getElementById('settings-modal').style.display='flex';
    window.closeSettings = () => document.getElementById('settings-modal').style.display='none';
    
    window.setTheme = (t) => { App.settings.theme = t; saveSet(); };
    window.setFont = (f) => { App.settings.font = f; saveSet(); };
    
    function saveSet() {
        localStorage.setItem('MedQuizSet', JSON.stringify(App.settings));
        applySet();
    }

</script>
</body>
</html>
