<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedQuiz Pro Elite</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --primary: #34495e;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #27ae60;
            --gold: #f1c40f;
            
            /* Compact Design Variables */
            --font-size: 14px;
            --btn-pad: 5px 10px;
            --radius: 6px;
        }

        /* Themes */
        body.dark-mode {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ecf0f1;
            --primary: #9b59b6;
            --secondary: #00cec9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            font-size: var(--font-size);
            user-select: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* --- Header --- */
        header {
            background: var(--card-bg);
            padding: 8px 15px;
            border-radius: var(--radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        .header-title h1 { margin: 0; font-size: 1.1rem; color: var(--secondary); }
        .header-title small { font-size: 0.75rem; opacity: 0.7; }

        .header-actions button {
            background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-color); margin-left: 5px;
        }

        /* --- Scrollable Content Area --- */
        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
            background: var(--bg-color);
        }

        /* --- Grid Menu --- */
        .grid-menu {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
            padding: 5px;
        }

        .menu-card {
            background: var(--card-bg);
            padding: 12px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .menu-card:hover { border-color: var(--secondary); transform: translateY(-2px); }
        .menu-card .icon { font-size: 1.5rem; margin-bottom: 5px; }
        .menu-card h3 { margin: 0; font-size: 0.9rem; }
        
        .card-innovative { border-left: 3px solid var(--accent); }
        .card-leader { border-left: 3px solid var(--gold); }

        /* --- Selection View --- */
        .compact-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 5px;
        }

        .select-btn {
            background: var(--card-bg);
            border: 1px solid #ddd;
            padding: var(--btn-pad);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1 1 auto; /* Responsive width */
            justify-content: center;
        }

        .select-btn:hover { border-color: var(--secondary); }
        .select-btn.selected { background: var(--secondary); color: white; border-color: var(--secondary); }
        .badge { background: rgba(0,0,0,0.1); padding: 0 4px; border-radius: 3px; font-size: 0.7rem; }

        /* --- Quiz View --- */
        .quiz-view { display: none; padding: 5px; height: 100%; flex-direction: column; }
        
        .q-meta {
            display: flex; gap: 10px; font-size: 0.8rem; color: #777; margin-bottom: 10px;
            background: rgba(0,0,0,0.03); padding: 5px; border-radius: 4px;
        }

        .q-text {
            font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; line-height: 1.4; 
            direction: ltr; text-align: left; background: var(--card-bg); padding: 15px; 
            border-radius: var(--radius); box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .q-options { display: flex; flex-direction: column; gap: 5px; }

        .option {
            background: var(--card-bg); padding: 8px 12px; border: 1px solid #eee; border-radius: var(--radius);
            cursor: pointer; direction: ltr; text-align: left; position: relative; font-size: 0.95rem;
            transition: 0.1s;
        }
        .option:hover { background: #f9f9f9; }
        .option.correct { background: #e8f5e9; border-color: var(--success); color: #2e7d32; }
        .option.wrong { background: #ffebee; border-color: var(--accent); color: #c62828; }
        
        .key-hint { 
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
            font-size: 0.7rem; color: #aaa; border: 1px solid #eee; padding: 1px 4px; border-radius: 3px;
        }

        .explanation {
            margin-top: 10px; padding: 10px; background: #e3f2fd; border-left: 3px solid var(--secondary);
            font-size: 0.85rem; direction: ltr; display: none; color: #333;
        }

        /* --- Action Bar --- */
        .action-bar {
            margin-top: auto; padding-top: 10px; display: flex; justify-content: space-between; align-items: center;
        }

        .btn {
            background: var(--secondary); color: white; border: none; padding: var(--btn-pad); 
            border-radius: var(--radius); cursor: pointer; font-size: 0.85rem;
        }
        .btn-grey { background: #95a5a6; }
        .btn-telegram { background: #0088cc; }

        /* --- Modals --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            display: none; justify-content: center; align-items: center; z-index: 999;
        }
        .modal-content {
            background: var(--card-bg); padding: 20px; border-radius: 8px; width: 90%; max-width: 350px;
            max-height: 80vh; overflow-y: auto; text-align: center;
        }

        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .leaderboard-table th { background: #f0f0f0; padding: 5px; }
        .leaderboard-table td { padding: 5px; border-bottom: 1px solid #eee; }

        /* Utilities */
        .hidden { display: none !important; }
        #timer-bar { height: 3px; background: var(--accent); width: 100%; margin-bottom: 5px; display:none; transition: width 1s linear; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-title">
            <h1>MedQuiz Elite</h1>
            <small id="status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</small>
        </div>
        <div class="header-actions">
            <button onclick="window.open('https://t.me/Heailloo_bot', '_blank')" title="Telegram Bot" style="color:#0088cc;">âœˆï¸</button>
            <button onclick="openLeaderboard()" title="Leaderboard" style="color:var(--gold);">ğŸ†</button>
            <button onclick="openSettings()" title="Settings">âš™ï¸</button>
        </div>
    </header>

    <div class="content-area">
        
        <!-- MAIN MENU -->
        <div id="view-home" class="grid-menu">
            <div class="menu-card" onclick="startFlow('normal')">
                <div class="icon">ğŸš€</div>
                <h3>Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
            </div>
            <div class="menu-card" onclick="startFlow('mistakes')">
                <div class="icon">âš ï¸</div>
                <h3>Ø£Ø®Ø·Ø§Ø¦ÙŠ (Ù…Ù‚Ø³Ù…Ø©)</h3>
            </div>
            <div class="menu-card card-innovative" onclick="startFlow('survival')">
                <div class="icon">ğŸ”¥</div>
                <h3>ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ù‚Ø§Ø¡</h3>
                <small>Ø®Ø·Ø£ ÙˆØ§Ø­Ø¯ = Ø®Ø³Ø§Ø±Ø©</small>
            </div>
            <div class="menu-card card-innovative" onclick="startFlow('timeAttack')">
                <div class="icon">âš¡</div>
                <h3>Ù‡Ø¬ÙˆÙ… Ø§Ù„ÙˆÙ‚Øª</h3>
                <small>60 Ø«Ø§Ù†ÙŠØ©</small>
            </div>
            <div class="menu-card" onclick="startMode('fav')">
                <div class="icon">â­</div>
                <h3>Ø§Ù„Ù…ÙØ¶Ù„Ø© (S)</h3>
            </div>
            <div class="menu-card" onclick="openSearch()">
                <div class="icon">ğŸ”</div>
                <h3>Ø¨Ø­Ø« ID</h3>
            </div>
        </div>

        <!-- SELECTION PANEL -->
        <div id="view-select" class="hidden" style="padding:10px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                <h3 id="select-title" style="margin:0; color:var(--secondary);">Select...</h3>
                <button class="btn btn-grey" onclick="goHome()">Back ğŸ </button>
            </div>
            
            <div id="select-grid" class="compact-list"></div>
            
            <div class="action-bar" style="margin-top:10px;">
                <button id="btn-toggle-all" class="btn btn-grey" onclick="toggleAll()">Ø§Ù„ÙƒÙ„</button>
                <button id="btn-select-next" class="btn" onclick="nextStep()">Ø§Ù„ØªØ§Ù„ÙŠ â¡</button>
            </div>
        </div>

        <!-- QUIZ VIEW -->
        <div id="view-quiz" class="quiz-view">
            <div id="timer-bar"></div>
            <div class="q-meta">
                <span>ID: <b id="q-id"></b></span>
                <span><b id="q-loc"></b></span>
                <span id="fav-btn" style="cursor:pointer; margin-right:auto;" onclick="toggleFav()">â˜†</span>
            </div>

            <div id="q-text" class="q-text">Loading...</div>
            <div id="q-options" class="q-options"></div>
            <div id="q-exp" class="explanation"></div>

            <div class="action-bar">
                <button class="btn btn-grey" onclick="goHome()">Ø®Ø±ÙˆØ¬</button>
                <span id="q-counter" style="font-weight:bold; font-size:0.9rem;">1/10</span>
                <button id="next-btn" class="btn hidden" onclick="nextQ()">Ø§Ù„ØªØ§Ù„ÙŠ (Space)</button>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->
<div id="modal-leaderboard" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content">
        <h2 style="color:var(--gold);">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</h2>
        <div style="margin-bottom:10px;">
            <input type="text" id="player-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©" style="padding:5px; width:70%;">
            <button class="btn" onclick="saveMyScore()">Ø­ÙØ¸ Ù†Ù‚Ø§Ø·ÙŠ</button>
        </div>
        <div style="font-size:0.8rem; color:#777; margin-bottom:5px;">Ù…Ø¬Ù…ÙˆØ¹ Ù†Ù‚Ø§Ø·Ùƒ (XP): <b id="my-xp">0</b></div>
        <table class="leaderboard-table">
            <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>XP</th></tr></thead>
            <tbody id="lb-body"></tbody>
        </table>
        <button class="btn btn-grey" style="margin-top:15px;" onclick="document.getElementById('modal-leaderboard').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="modal-settings" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content">
        <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <p>Ø§Ù„Ø«ÙŠÙ…:</p>
        <div style="display:flex; gap:5px; justify-content:center;">
            <button class="btn" style="background:#ddd; color:#333;" onclick="setTheme('light')">â˜€ï¸</button>
            <button class="btn" style="background:#333;" onclick="setTheme('dark')">ğŸŒ‘</button>
        </div>
        <p>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</p>
        <input type="range" min="12" max="20" value="14" oninput="setFont(this.value)">
        <br><br>
        <button class="btn" onclick="document.getElementById('modal-settings').style.display='none'">Ø­ÙØ¸</button>
    </div>
</div>

<div id="modal-search" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content">
        <h3>Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„</h3>
        <input type="number" id="search-inp" style="padding:8px; width:80%;" placeholder="ID...">
        <br><br>
        <button class="btn" onclick="doSearch()">Ø¨Ø­Ø«</button>
    </div>
</div>

<script>
    // ===========================================
    // 1. FIREBASE CONFIG
    // ===========================================
    const firebaseConfig = {
        apiKey: "AIzaSyDEZFJmcXK2LxYAZ-Yjv_M1HbC6zi_qilg",
        authDomain: "exambotdb.firebaseapp.com",
        databaseURL: "https://exambotdb-default-rtdb.firebaseio.com",
        projectId: "exambotdb",
        storageBucket: "exambotdb.firebasestorage.app",
        messagingSenderId: "950600562980",
        appId: "1:950600562980:web:f993c22d45e5cfdd3d9bb1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===========================================
    // 2. DATA LOADING & STATE
    // ===========================================
    let allData = [];
    let activePool = []; // The pool of questions we are currently selecting from
    let quizQueue = [];
    let qIndex = 0;
    
    // User Data
    let mistakes = JSON.parse(localStorage.getItem('mistakes') || '[]');
    let favs = JSON.parse(localStorage.getItem('favs') || '[]');
    let userXP = parseInt(localStorage.getItem('userXP') || '0');

    // Selection State
    let flowMode = 'normal'; // normal, mistakes, survival, timeAttack
    let sel = { term:null, subj:null, lessons:[], chapters:[] };
    let selStep = '';

    window.onload = async () => {
        try {
            const listRes = await fetch('questions_list.json');
            const fileList = await listRes.json();
            
            let loadedCount = 0;
            for(const file of fileList) {
                try {
                    const res = await fetch(`Questions/${file}`);
                    const json = await res.json();
                    const qs = json.questions.map(q => ({
                        ...q,
                        term: q.term || json.meta.source || "Unknown",
                        subject: q.subject || json.meta.subject || "Unknown",
                        lesson: q.lesson || json.meta.lesson || "Unknown",
                        chapter: q.chapter || "General"
                    }));
                    allData.push(...qs);
                    loadedCount++;
                } catch(err) { console.error(`Error loading ${file}`, err); }
            }
            document.getElementById('status-text').innerText = `${allData.length} Qs Ready`;
        } catch(e) {
            document.getElementById('status-text').innerText = "Error: Create questions_list.json!";
            console.error(e);
        }
    };

    // ===========================================
    // 3. SELECTION LOGIC (Unified for Normal & Mistakes)
    // ===========================================
    function startFlow(mode) {
        flowMode = mode;
        sel = { term:null, subj:null, lessons:[], chapters:[] };

        // Determine Source Data
        if(mode === 'mistakes') {
            activePool = allData.filter(q => mistakes.includes(q.id));
            if(activePool.length === 0) return alert('Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙØ§Ø±Øº! Ø£Ø­Ø³Ù†Øª.');
        } else {
            activePool = allData;
        }

        // Skip selection for Time Attack / Survival if preferred, 
        // BUT user might want to choose subject first. Let's force selection for all.
        goToStep('term');
    }

    function goToStep(step) {
        selStep = step;
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-select').classList.remove('hidden');
        
        const grid = document.getElementById('select-grid');
        grid.innerHTML = '';
        const title = document.getElementById('select-title');
        const nextBtn = document.getElementById('btn-select-next');
        const toggleBtn = document.getElementById('btn-toggle-all');
        toggleBtn.classList.add('hidden');

        // Dynamic Filtering based on previous steps AND activePool
        let items = [];
        let isMulti = false;
        
        // Helper to filter by current selection state
        const getSubset = () => {
            return activePool.filter(q => 
                (sel.term ? q.term === sel.term : true) &&
                (sel.subj ? q.subject === sel.subj : true) &&
                (sel.lessons.length ? sel.lessons.includes(q.lesson) : true)
            );
        };

        if(step === 'term') {
            title.innerText = "1. Ø§Ù„ØªØ±Ù… (Term)";
            items = [...new Set(activePool.map(q => q.term))];
            nextBtn.onclick = () => alert("Ø§Ø®ØªØ± Ø®ÙŠØ§Ø±Ø§Ù‹");
        } 
        else if(step === 'subj') {
            title.innerText = "2. Ø§Ù„Ù…Ø§Ø¯Ø© (Subject)";
            items = [...new Set(getSubset().map(q => q.subject))];
        } 
        else if(step === 'lesson') {
            title.innerText = "3. Ø§Ù„Ø¯Ø±Ø³ (Lesson)";
            isMulti = true;
            toggleBtn.classList.remove('hidden');
            items = [...new Set(getSubset().map(q => q.lesson))];
            nextBtn.onclick = () => finishSelectionStep('lesson');
        } 
        else if(step === 'chapter') {
            title.innerText = "4. Ø§Ù„Ø´Ø§Ø¨ØªØ± (Chapter)";
            isMulti = true;
            toggleBtn.classList.remove('hidden');
            items = [...new Set(getSubset().map(q => q.chapter))];
            nextBtn.onclick = () => finishSelectionStep('chapter');
        }

        // Render Items
        items.sort().forEach(item => {
            const count = getSubset().filter(q => q[step === 'term' ? 'term' : step === 'subj' ? 'subject' : step === 'lesson' ? 'lesson' : 'chapter'] === item).length;
            
            const btn = document.createElement('div');
            btn.className = 'select-btn';
            btn.innerHTML = `<span>${item}</span><span class="badge">${count}</span>`;
            btn.dataset.val = item;
            
            btn.onclick = () => {
                if(isMulti) {
                    btn.classList.toggle('selected');
                } else {
                    // Single Select logic
                    if(step === 'term') { sel.term = item; goToStep('subj'); }
                    if(step === 'subj') { sel.subj = item; goToStep('lesson'); }
                }
            };
            grid.appendChild(btn);
        });
    }

    function toggleAll() {
        const btns = document.querySelectorAll('#select-grid .select-btn');
        const all = Array.from(btns).every(b => b.classList.contains('selected'));
        btns.forEach(b => all ? b.classList.remove('selected') : b.classList.add('selected'));
    }

    function finishSelectionStep(step) {
        const selected = Array.from(document.querySelectorAll('#select-grid .select-btn.selected')).map(b => b.dataset.val);
        if(selected.length === 0) return alert("Ø§Ø®ØªØ± ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

        if(step === 'lesson') { sel.lessons = selected; goToStep('chapter'); }
        else if(step === 'chapter') { 
            sel.chapters = selected; 
            // Finalize
            let finalPool = activePool.filter(q => 
                q.term === sel.term && 
                q.subject === sel.subj && 
                sel.lessons.includes(q.lesson) && 
                sel.chapters.includes(q.chapter)
            );
            
            if(flowMode === 'survival') initQuiz(finalPool, 'All');
            else if(flowMode === 'timeAttack') initQuiz(finalPool, 'All'); // Time limit handled in quiz
            else initQuiz(finalPool, 'All'); // Normal / Mistakes
        }
    }

    function startMode(mode) {
        if(mode === 'fav') {
            const pool = allData.filter(q => favs.includes(q.id));
            if(!pool.length) return alert("Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙØ§Ø±ØºØ©");
            flowMode = 'normal';
            initQuiz(pool, 'All');
        }
    }

    // ===========================================
    // 4. QUIZ ENGINE
    // ===========================================
    let timerInterval;
    let timeRemaining = 60;

    function initQuiz(pool, limit) {
        // Shuffle
        pool = pool.sort(() => 0.5 - Math.random());
        
        if(limit !== 'All') pool = pool.slice(0, parseInt(limit));
        
        quizQueue = pool;
        qIndex = 0;

        document.getElementById('view-select').classList.add('hidden');
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-quiz').style.display = 'flex';
        
        // Reset Timer
        document.getElementById('timer-bar').style.display = 'none';
        if(flowMode === 'timeAttack') startTimeAttack();

        renderQ();
    }

    function startTimeAttack() {
        timeRemaining = 60;
        const bar = document.getElementById('timer-bar');
        bar.style.display = 'block';
        bar.style.width = '100%';
        
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeRemaining--;
            bar.style.width = `${(timeRemaining/60)*100}%`;
            if(timeRemaining <= 0) {
                clearInterval(timerInterval);
                alert(`Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ù†ØªÙŠØ¬ØªÙƒ: ${qIndex} Ø£Ø³Ø¦Ù„Ø©.`);
                goHome();
            }
        }, 1000);
    }

    let isAnswered = false;

    function renderQ() {
        isAnswered = false;
        const q = quizQueue[qIndex];
        
        document.getElementById('q-id').innerText = q.id;
        document.getElementById('q-loc').innerText = `${q.lesson} > ${q.chapter}`;
        document.getElementById('q-counter').innerText = `${qIndex+1} / ${quizQueue.length}`;
        document.getElementById('q-text').innerText = q.question;
        
        // Fav Icon
        const favEl = document.getElementById('fav-btn');
        favEl.innerText = favs.includes(q.id) ? "â˜…" : "â˜†";
        favEl.style.color = favs.includes(q.id) ? "orange" : "inherit";

        // Options
        const optsDiv = document.getElementById('q-options');
        optsDiv.innerHTML = '';
        document.getElementById('q-exp').style.display = 'none';
        document.getElementById('next-btn').classList.add('hidden');

        const keys = ['A','B','C','D','E'];
        q.options.forEach((opt, i) => {
            const div = document.createElement('div');
            div.className = 'option';
            div.innerHTML = `${opt} <span class="key-hint">${keys[i]}</span>`;
            div.onclick = () => handleAns(i);
            optsDiv.appendChild(div);
        });
    }

    function handleAns(idx) {
        if(isAnswered) return;
        isAnswered = true;

        const q = quizQueue[qIndex];
        const divs = document.querySelectorAll('.option');
        
        // Show Right/Wrong
        divs[q.correct_option_id].classList.add('correct');
        
        if(idx === q.correct_option_id) {
            // Correct
            divs[idx].querySelector('.key-hint').innerText = "âœ“";
            removeMistake(q.id);
            incrementXP();
        } else {
            // Wrong
            divs[idx].classList.add('wrong');
            divs[idx].querySelector('.key-hint').innerText = "âœ—";
            saveMistake(q.id);
            
            if(flowMode === 'survival') {
                clearInterval(timerInterval);
                setTimeout(() => { alert("ğŸ’¥ Ø®Ø³Ø±Øª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ù‚Ø§Ø¡!"); goHome(); }, 500);
                return;
            }
        }

        // Show Explanation
        const exp = document.getElementById('q-exp');
        exp.innerHTML = `<b>Explanation:</b> ${q.explanation || 'None'}`;
        exp.style.display = 'block';
        document.getElementById('next-btn').classList.remove('hidden');
    }

    function nextQ() {
        if(qIndex < quizQueue.length - 1) {
            qIndex++;
            renderQ();
        } else {
            clearInterval(timerInterval);
            alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!");
            goHome();
        }
    }

    function goHome() {
        clearInterval(timerInterval);
        document.getElementById('view-quiz').style.display = 'none';
        document.getElementById('view-select').classList.add('hidden');
        document.getElementById('view-home').classList.remove('hidden');
    }

    // ===========================================
    // 5. DATA & LEADERBOARD UTILS
    // ===========================================
    function saveMistake(id) {
        if(!mistakes.includes(id)) { mistakes.push(id); localStorage.setItem('mistakes', JSON.stringify(mistakes)); }
    }
    function removeMistake(id) {
        mistakes = mistakes.filter(x => x!==id); localStorage.setItem('mistakes', JSON.stringify(mistakes));
    }
    function toggleFav() {
        const id = quizQueue[qIndex].id;
        if(favs.includes(id)) favs = favs.filter(x => x!==id);
        else favs.push(id);
        localStorage.setItem('favs', JSON.stringify(favs));
        renderQ(); // refresh icon
    }
    function incrementXP() {
        userXP++;
        localStorage.setItem('userXP', userXP);
    }

    // --- Firebase Leaderboard ---
    function openLeaderboard() {
        document.getElementById('modal-leaderboard').style.display = 'flex';
        document.getElementById('my-xp').innerText = userXP;
        fetchLeaderboard();
        const savedName = localStorage.getItem('userName');
        if(savedName) document.getElementById('player-name').value = savedName;
    }

    function saveMyScore() {
        const name = document.getElementById('player-name').value.trim();
        if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ");
        localStorage.setItem('userName', name);
        
        // Write to Firebase
        // Since we don't have auth, we use name as key (simple version)
        // Or push a new entry. Let's use name as ID for simplicity in update.
        const safeName = name.replace(/[.#$/\[\]]/g, "_"); // sanitize for firebase path
        
        db.ref('leaderboard/' + safeName).set({
            name: name,
            score: userXP,
            lastUpdate: Date.now()
        }).then(() => {
            alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ù‚Ø§Ø·!");
            fetchLeaderboard();
        }).catch(err => alert("Error: " + err.message));
    }

    function fetchLeaderboard() {
        const body = document.getElementById('lb-body');
        body.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
        
        db.ref('leaderboard').orderByChild('score').limitToLast(10).once('value', snap => {
            const data = [];
            snap.forEach(child => data.push(child.val()));
            data.reverse(); // Highest first
            
            body.innerHTML = '';
            data.forEach((p, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i+1}</td><td>${p.name}</td><td>${p.score}</td>`;
                body.appendChild(tr);
            });
        });
    }

    // ===========================================
    // 6. UI & SHORTCUTS
    // ===========================================
    function openSettings() { document.getElementById('modal-settings').style.display = 'flex'; }
    function openSearch() { document.getElementById('modal-search').style.display = 'flex'; }
    function doSearch() {
        const id = parseInt(document.getElementById('search-inp').value);
        const q = allData.find(x => x.id === id);
        if(q) { 
            flowMode = 'normal';
            initQuiz([q], 'All'); 
            document.getElementById('modal-search').style.display='none';
        } else alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    }
    function setTheme(t) { document.body.className = t === 'light' ? '' : 'dark-mode'; }
    function setFont(s) { document.documentElement.style.setProperty('--font-size', s+'px'); }

    // Shortcuts
    document.addEventListener('keydown', (e) => {
        if(document.querySelector('.modal').style.display === 'flex') return;
        if(document.getElementById('view-quiz').style.display === 'flex') {
            const k = e.key.toLowerCase();
            const map = {'a':0,'b':1,'c':2,'d':3,'e':4};
            if(map[k] !== undefined) handleAns(map[k]);
            if(k === 's') toggleFav();
            if((k === ' ' || k === 'enter') && isAnswered) { e.preventDefault(); nextQ(); }
        }
    });

</script>
</body>
</html>
