<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            color: #2c3e50;
            user-select: none; /* Ù„Ù…Ù†Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª */
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Header & Loader --- */
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .file-upload-wrapper {
            border: 2px dashed var(--secondary);
            padding: 30px;
            text-align: center;
            border-radius: 12px;
            background: #eef7fc;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 20px;
        }

        .file-upload-wrapper:hover {
            background: #e3f2fd;
        }

        /* --- Main Grid Menu --- */
        .grid-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            display: none; /* Hidden until loaded */
        }

        .menu-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: 0.2s;
        }

        .menu-card:hover { transform: translateY(-3px); }
        .card-start { border-color: var(--secondary); }
        .card-mistakes { border-color: var(--accent); }
        .card-fav { border-color: var(--warning); }
        .card-search { border-color: var(--primary); }

        /* --- Selection Screen --- */
        .selection-panel {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: none;
        }

        .step-title {
            color: var(--secondary);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .select-btn {
            background: #fff;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .select-btn:hover { background: #f1f1f1; }
        
        .select-btn.selected {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .badge {
            background: #eee;
            color: #333;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .select-btn.selected .badge {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        /* --- Quiz Screen --- */
        .quiz-container {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: none;
            position: relative;
        }

        .q-header {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            color: #555;
            border: 1px solid #eee;
        }

        .q-header span strong { color: var(--secondary); }

        .question-text {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 25px;
            line-height: 1.6;
            direction: ltr;
            text-align: left;
        }

        .quiz-option {
            padding: 15px 20px;
            margin-bottom: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.2s;
            direction: ltr;
            text-align: left;
            position: relative;
            display: flex;
            align-items: center;
        }

        .quiz-option:hover { background: #f9f9f9; border-color: #ddd; }
        
        .quiz-option .key-hint {
            position: absolute;
            right: 15px;
            background: #eee;
            color: #777;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .quiz-option.correct { background: #d4edda; border-color: var(--success); color: #155724; }
        .quiz-option.wrong { background: #f8d7da; border-color: var(--accent); color: #721c24; }

        .explanation {
            background: #e8f4fd;
            border-left: 5px solid var(--secondary);
            padding: 15px;
            margin-top: 20px;
            display: none;
            direction: ltr;
        }

        /* --- Utilities --- */
        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: 0.2s;
        }
        .btn-primary { background: var(--secondary); }
        .btn-success { background: var(--success); }
        .btn-gray { background: #95a5a6; }
        
        .hidden { display: none !important; }

        /* Search Modal */
        #search-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ©º Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p id="status-text" style="color: #7f8c8d;">ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ø¨Ø¯Ø¡</p>
    </header>

    <!-- 1. File Loader -->
    <div id="loader-section" class="file-upload-wrapper" onclick="document.getElementById('folderInput').click()">
        <span style="font-size: 3rem;">ğŸ“‚</span>
        <h3>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ "Questions"</h3>
        <p>Ø³ÙŠØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª JSON ÙˆØ¯Ù…Ø¬Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
        <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;">
    </div>

    <!-- 2. Main Menu -->
    <div id="main-menu" class="grid-menu">
        <div class="menu-card card-start" onclick="startSelectionProcess()">
            <div style="font-size: 2.5rem;">ğŸš€</div>
            <h3>Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
            <p>ØªØ­Ø¯ÙŠØ¯ Ù…ØªØ¹Ø¯Ø¯ Ù„Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø´Ø¨Ø§ØªØ±</p>
        </div>
        <div class="menu-card card-mistakes" onclick="startSpecialMode('mistakes')">
            <div style="font-size: 2.5rem;">âš ï¸</div>
            <h3>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h3>
            <p>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©</p>
        </div>
        <div class="menu-card card-fav" onclick="startSpecialMode('bookmarks')">
            <div style="font-size: 2.5rem;">â­</div>
            <h3>Ø§Ù„Ù…ÙØ¶Ù„Ø©</h3>
            <p>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Shortcut: S)</p>
        </div>
        <div class="menu-card card-search" onclick="document.getElementById('search-modal').style.display='flex'">
            <div style="font-size: 2.5rem;">ğŸ”</div>
            <h3>Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ ID</h3>
            <p>Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ø³Ø¤Ø§Ù„</p>
        </div>
    </div>

    <!-- 3. Selection Steps -->
    <div id="selection-panel" class="selection-panel">
        <div id="step-term" class="step-content">
            <div class="step-title">1. Ø§Ø®ØªØ± Ø§Ù„ØªØ±Ù… (Term)</div>
            <div class="options-grid" id="grid-term"></div>
        </div>
        
        <div id="step-subject" class="step-content hidden">
            <div class="step-title">
                2. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© (Subject)
                <button class="btn btn-gray" onclick="resetStep('term')">Ø¹ÙˆØ¯Ø©</button>
            </div>
            <div class="options-grid" id="grid-subject"></div>
        </div>

        <div id="step-lesson" class="step-content hidden">
            <div class="step-title">
                3. Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±ÙˆØ³ (ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø£ÙƒØ«Ø± Ù…Ù† Ø¯Ø±Ø³)
                <div>
                    <button class="btn btn-success" onclick="toggleAll('lesson')">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
                    <button class="btn btn-primary" onclick="confirmLessons()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                </div>
            </div>
            <div class="options-grid" id="grid-lesson"></div>
        </div>

        <div id="step-chapter" class="step-content hidden">
            <div class="step-title">
                4. Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¨Ø§ØªØ± (Chapters)
                <div>
                    <button class="btn btn-success" onclick="toggleAll('chapter')">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
                    <button class="btn btn-primary" onclick="confirmChapters()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                </div>
            </div>
            <div class="options-grid" id="grid-chapter"></div>
        </div>

        <div id="step-limit" class="step-content hidden">
            <div class="step-title">5. Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
            <div class="options-grid">
                <div class="select-btn" onclick="startQuizWithLimit(10)">10 Ø£Ø³Ø¦Ù„Ø©</div>
                <div class="select-btn" onclick="startQuizWithLimit(20)">20 Ø³Ø¤Ø§Ù„</div>
                <div class="select-btn" onclick="startQuizWithLimit(50)">50 Ø³Ø¤Ø§Ù„</div>
                <div class="select-btn" onclick="startQuizWithLimit('all')">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
            </div>
        </div>
    </div>

    <!-- 4. Quiz Interface -->
    <div id="quiz-view" class="quiz-container">
        <div class="q-header">
            <span>ID: <strong id="q-id">---</strong></span>
            <span>Lesson: <strong id="q-lesson">---</strong></span>
            <span>Chapter: <strong id="q-chapter">---</strong></span>
            <span id="fav-indicator" style="cursor: pointer;" onclick="toggleBookmark()">â˜† Ø­ÙØ¸ (S)</span>
        </div>

        <div class="question-text" id="q-text">Loading...</div>
        <div id="q-options"></div>
        
        <div id="q-explanation" class="explanation"></div>

        <div class="action-bar">
            <button class="btn btn-gray" onclick="exitQuiz()">Ø®Ø±ÙˆØ¬ ğŸ </button>
            <div id="q-progress" style="align-self: center; font-weight: bold;">1 / 20</div>
            <button class="btn btn-primary hidden" id="btn-next" onclick="nextQuestion()">Ø§Ù„ØªØ§Ù„ÙŠ (Enter) â¡</button>
        </div>
    </div>

</div>

<!-- Search Modal -->
<div id="search-modal" onclick="if(event.target==this) this.style.display='none'">
    <div style="background:white; padding:30px; border-radius:10px; text-align:center; min-width: 300px;">
        <h3>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„ (ID)</h3>
        <input type="number" id="search-input" style="padding:10px; width:80%; font-size:1.2rem; margin:15px 0;" placeholder="Ù…Ø«Ø§Ù„: 7650">
        <br>
        <button class="btn btn-primary" onclick="executeSearch()">Ø¨Ø­Ø«</button>
    </div>
</div>

<script>
    // ==========================================
    // 1. DATA HANDLING
    // ==========================================
    let allQuestions = [];
    let filteredQuestions = [];
    let currentQuiz = [];
    let currentIndex = 0;
    
    // User Selections
    let selection = {
        term: null,
        subject: null,
        lessons: [],
        chapters: []
    };

    // Load from LocalStorage
    let mistakes = JSON.parse(localStorage.getItem('medQuizMistakes')) || [];
    let bookmarks = JSON.parse(localStorage.getItem('medQuizBookmarks')) || [];

    // File Loader
    document.getElementById('folderInput').addEventListener('change', async function(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        allQuestions = [];
        let loadedCount = 0;

        document.getElementById('status-text').innerText = 'Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª...';

        for (let file of files) {
            if (file.name.endsWith('.json')) {
                try {
                    const text = await file.text();
                    const json = JSON.parse(text);
                    if (json.questions && Array.isArray(json.questions)) {
                        // Enhance questions with meta info if missing in question object
                        const enhancedQs = json.questions.map(q => ({
                            ...q,
                            term: q.term || json.meta?.source || "Unknown Term",
                            subject: q.subject || json.meta?.subject || "Unknown Subject",
                            lesson: q.lesson || json.meta?.lesson || "Unknown Lesson",
                            // Chapter is usually inside the question object
                        }));
                        allQuestions.push(...enhancedQs);
                        loadedCount++;
                    }
                } catch (err) {
                    console.error("Error parsing file:", file.name, err);
                }
            }
        }

        if (allQuestions.length > 0) {
            document.getElementById('status-text').innerText = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allQuestions.length} Ø³Ø¤Ø§Ù„ Ù…Ù† ${loadedCount} Ù…Ù„Ù.`;
            document.getElementById('loader-section').classList.add('hidden');
            document.getElementById('main-menu').style.display = 'grid';
        } else {
            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©.');
        }
    });

    // ==========================================
    // 2. SELECTION LOGIC
    // ==========================================

    function startSelectionProcess() {
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('selection-panel').style.display = 'block';
        renderTerms();
    }

    function renderTerms() {
        resetStepsFrom('term');
        const terms = [...new Set(allQuestions.map(q => q.term))].sort();
        const container = document.getElementById('grid-term');
        container.innerHTML = '';
        
        terms.forEach(term => {
            const count = allQuestions.filter(q => q.term === term).length;
            container.innerHTML += createSelectBtn(term, count, () => selectTerm(term));
        });
    }

    function selectTerm(term) {
        selection.term = term;
        document.getElementById('step-term').classList.add('hidden');
        document.getElementById('step-subject').classList.remove('hidden');
        renderSubjects();
    }

    function renderSubjects() {
        const subjects = [...new Set(allQuestions.filter(q => q.term === selection.term).map(q => q.subject))].sort();
        const container = document.getElementById('grid-subject');
        container.innerHTML = '';

        subjects.forEach(sub => {
            const count = allQuestions.filter(q => q.term === selection.term && q.subject === sub).length;
            container.innerHTML += createSelectBtn(sub, count, () => selectSubject(sub));
        });
    }

    function selectSubject(sub) {
        selection.subject = sub;
        document.getElementById('step-subject').classList.add('hidden');
        document.getElementById('step-lesson').classList.remove('hidden');
        renderLessons();
    }

    // Multi-Select Logic for Lessons
    function renderLessons() {
        const subset = allQuestions.filter(q => q.term === selection.term && q.subject === selection.subject);
        const lessons = [...new Set(subset.map(q => q.lesson))].sort();
        const container = document.getElementById('grid-lesson');
        container.innerHTML = '';
        selection.lessons = []; // reset

        lessons.forEach(lesson => {
            const count = subset.filter(q => q.lesson === lesson).length;
            const btn = document.createElement('div');
            btn.className = 'select-btn';
            btn.innerHTML = `<span>${lesson}</span> <span class="badge">${count}</span>`;
            btn.dataset.value = lesson;
            btn.onclick = () => {
                btn.classList.toggle('selected');
                updateLessonSelection();
            };
            container.appendChild(btn);
        });
    }

    function updateLessonSelection() {
        const btns = document.querySelectorAll('#grid-lesson .select-btn.selected');
        selection.lessons = Array.from(btns).map(b => b.dataset.value);
    }

    function confirmLessons() {
        if (selection.lessons.length === 0) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¯Ø±Ø³ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
        document.getElementById('step-lesson').classList.add('hidden');
        document.getElementById('step-chapter').classList.remove('hidden');
        renderChapters();
    }

    // Multi-Select Logic for Chapters
    function renderChapters() {
        const subset = allQuestions.filter(q => 
            q.term === selection.term && 
            q.subject === selection.subject && 
            selection.lessons.includes(q.lesson)
        );
        const chapters = [...new Set(subset.map(q => q.chapter))].sort();
        const container = document.getElementById('grid-chapter');
        container.innerHTML = '';
        selection.chapters = [];

        chapters.forEach(chap => {
            const count = subset.filter(q => q.chapter === chap).length;
            const btn = document.createElement('div');
            btn.className = 'select-btn';
            btn.innerHTML = `<span>${chap || 'No Chapter'}</span> <span class="badge">${count}</span>`;
            btn.dataset.value = chap;
            btn.onclick = () => {
                btn.classList.toggle('selected');
                updateChapterSelection();
            };
            container.appendChild(btn);
        });
    }

    function updateChapterSelection() {
        const btns = document.querySelectorAll('#grid-chapter .select-btn.selected');
        selection.chapters = Array.from(btns).map(b => b.dataset.value);
    }

    function confirmChapters() {
        if (selection.chapters.length === 0) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø§Ø¨ØªØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
        
        // Final Filter
        filteredQuestions = allQuestions.filter(q => 
            q.term === selection.term && 
            q.subject === selection.subject && 
            selection.lessons.includes(q.lesson) &&
            selection.chapters.includes(q.chapter)
        );

        document.getElementById('step-chapter').classList.add('hidden');
        document.getElementById('step-limit').classList.remove('hidden');
    }

    function createSelectBtn(text, count, onClick) {
        return `<div class="select-btn" onclick="(${onClick})()">
                    <span>${text}</span>
                    <span class="badge">${count}</span>
                </div>`;
    }

    function toggleAll(type) {
        const container = document.getElementById(`grid-${type}`);
        const btns = container.querySelectorAll('.select-btn');
        const allSelected = Array.from(btns).every(b => b.classList.contains('selected'));
        
        btns.forEach(b => {
            if (allSelected) b.classList.remove('selected');
            else b.classList.add('selected');
        });

        if(type === 'lesson') updateLessonSelection();
        if(type === 'chapter') updateChapterSelection();
    }

    // ==========================================
    // 3. QUIZ LOGIC
    // ==========================================

    function startQuizWithLimit(limit) {
        // Shuffle
        let finalSet = [...filteredQuestions].sort(() => 0.5 - Math.random());
        
        if (limit !== 'all') {
            finalSet = finalSet.slice(0, limit);
        }

        startQuiz(finalSet);
    }

    function startSpecialMode(mode) {
        let qs = [];
        if(mode === 'mistakes') qs = allQuestions.filter(q => mistakes.includes(q.id));
        if(mode === 'bookmarks') qs = allQuestions.filter(q => bookmarks.includes(q.id));
        
        if(qs.length === 0) { alert('Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©!'); return; }
        
        // Shuffle special modes too
        startQuiz(qs.sort(() => 0.5 - Math.random()));
    }

    function startQuiz(questions) {
        currentQuiz = questions;
        currentIndex = 0;
        
        document.getElementById('selection-panel').style.display = 'none';
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('search-modal').style.display = 'none';
        document.getElementById('quiz-view').style.display = 'block';
        
        renderQuestion();
    }

    function renderQuestion() {
        const q = currentQuiz[currentIndex];
        
        // Headers
        document.getElementById('q-id').innerText = q.id;
        document.getElementById('q-lesson').innerText = q.lesson;
        document.getElementById('q-chapter').innerText = q.chapter || 'General';
        document.getElementById('q-progress').innerText = `${currentIndex + 1} / ${currentQuiz.length}`;
        updateFavIcon(q.id);

        // Body
        document.getElementById('q-text').innerText = q.question;
        const optsContainer = document.getElementById('q-options');
        optsContainer.innerHTML = '';
        
        // Reset UI
        document.getElementById('q-explanation').style.display = 'none';
        document.getElementById('btn-next').classList.add('hidden');
        quizState.answered = false;

        // Render Options with Shortcuts
        const keys = ['A', 'B', 'C', 'D', 'E'];
        q.options.forEach((opt, idx) => {
            const div = document.createElement('div');
            div.className = 'quiz-option';
            div.id = `opt-${idx}`;
            div.innerHTML = `<span>${opt}</span> <div class="key-hint">${keys[idx] || ''}</div>`;
            div.onclick = () => handleAnswer(idx);
            optsContainer.appendChild(div);
        });
    }

    let quizState = { answered: false };

    function handleAnswer(selectedIdx) {
        if (quizState.answered) return;
        quizState.answered = true;

        const q = currentQuiz[currentIndex];
        const correctIdx = q.correct_option_id; // Assuming 0-based index from JSON

        const opts = document.querySelectorAll('.quiz-option');
        
        // Style Correct
        opts[correctIdx].classList.add('correct');
        opts[correctIdx].querySelector('.key-hint').innerText = 'âœ“';

        // Style Wrong (if applicable)
        if (selectedIdx !== correctIdx) {
            opts[selectedIdx].classList.add('wrong');
            opts[selectedIdx].querySelector('.key-hint').innerText = 'âœ—';
            saveMistake(q.id);
        } else {
            removeMistake(q.id);
        }

        // Show Explanation
        const expDiv = document.getElementById('q-explanation');
        expDiv.innerHTML = `<strong>Explanation:</strong> ${q.explanation || 'No explanation available.'}`;
        expDiv.style.display = 'block';

        // Show Next Button
        document.getElementById('btn-next').classList.remove('hidden');
    }

    function nextQuestion() {
        if (currentIndex < currentQuiz.length - 1) {
            currentIndex++;
            renderQuestion();
        } else {
            alert('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!');
            exitQuiz();
        }
    }

    function exitQuiz() {
        document.getElementById('quiz-view').style.display = 'none';
        document.getElementById('main-menu').style.display = 'grid';
        // Reset Selection view to start
        resetStepsFrom('term');
    }

    function resetStepsFrom(step) {
        if(step === 'term') {
            document.getElementById('step-term').classList.remove('hidden');
            document.getElementById('step-subject').classList.add('hidden');
            document.getElementById('step-lesson').classList.add('hidden');
            document.getElementById('step-chapter').classList.add('hidden');
            document.getElementById('step-limit').classList.add('hidden');
        }
    }

    // ==========================================
    // 4. SHORTCUTS & UTILS
    // ==========================================

    document.addEventListener('keydown', (e) => {
        // Disable shortcuts if search modal is open
        if(document.getElementById('search-modal').style.display === 'flex') return;
        if(document.getElementById('quiz-view').style.display === 'none') return;

        const key = e.key.toLowerCase();
        
        // Options A-E / 1-5
        const map = { 'a':0, 'b':1, 'c':2, 'd':3, 'e':4, '1':0, '2':1, '3':2, '4':3, '5':4 };
        
        if (map.hasOwnProperty(key) && !quizState.answered) {
            const idx = map[key];
            const optionsCount = currentQuiz[currentIndex].options.length;
            if(idx < optionsCount) handleAnswer(idx);
        }

        // Save (S)
        if (key === 's') {
            toggleBookmark();
        }

        // Next (Enter/Space)
        if ((key === 'enter' || key === ' ') && quizState.answered) {
            e.preventDefault();
            nextQuestion();
        }
    });

    // Storage Functions
    function saveMistake(id) {
        if(!mistakes.includes(id)) {
            mistakes.push(id);
            localStorage.setItem('medQuizMistakes', JSON.stringify(mistakes));
        }
    }
    function removeMistake(id) {
        const idx = mistakes.indexOf(id);
        if(idx > -1) {
            mistakes.splice(idx, 1);
            localStorage.setItem('medQuizMistakes', JSON.stringify(mistakes));
        }
    }
    function toggleBookmark() {
        const id = currentQuiz[currentIndex].id;
        const idx = bookmarks.indexOf(id);
        if(idx > -1) bookmarks.splice(idx, 1);
        else bookmarks.push(id);
        
        localStorage.setItem('medQuizBookmarks', JSON.stringify(bookmarks));
        updateFavIcon(id);
    }
    function updateFavIcon(id) {
        const el = document.getElementById('fav-indicator');
        if(bookmarks.includes(id)) {
            el.innerHTML = 'â˜… Ù…Ø­ÙÙˆØ¸ (S)';
            el.style.color = '#f39c12';
        } else {
            el.innerHTML = 'â˜† Ø­ÙØ¸ (S)';
            el.style.color = '#555';
        }
    }

    // Search
    function executeSearch() {
        const id = parseInt(document.getElementById('search-input').value);
        const q = allQuestions.find(i => i.id === id);
        if(q) {
            startQuiz([q]);
        } else {
            alert('Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©.');
        }
    }
</script>

</body>
</html>
