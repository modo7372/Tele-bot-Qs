<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Bot Online</title>
    
    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #111;
            --text-secondary: #555;
            --primary: #0088cc; /* Telegram Blue */
            --danger: #e53935;
            --success: #43a047;
            --radius: 12px;
            --shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        body.dark-mode {
            --bg-color: #1e1e1e;
            --card-bg: #2b2b2b;
            --text-primary: #fff;
            --text-secondary: #aaa;
            --shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: var(--bg-color); color: var(--text-primary);
            margin: 0; padding-bottom: 70px;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* --- Header --- */
        header {
            background: var(--card-bg); padding: 15px; position: sticky; top: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow);
        }
        .header-title { font-weight: bold; font-size: 1.1em; }
        .score-display { font-size: 0.9em; font-weight: 500; background: rgba(0,0,0,0.05); padding: 5px 10px; border-radius: 20px; }

        /* --- Loader --- */
        .loader-overlay {
            position: fixed; inset: 0; background: var(--bg-color); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- Components --- */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .hidden { display: none !important; }

        .btn-card {
            background: var(--card-bg); border-radius: var(--radius);
            padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow);
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: transform 0.1s;
        }
        .btn-card:active { transform: scale(0.98); }
        .btn-card h3 { margin: 0; font-size: 1.1em; }
        .btn-card p { margin: 5px 0 0; font-size: 0.8em; color: var(--text-secondary); }

        /* --- Leaderboard Styles --- */
        .rank-card {
            background: linear-gradient(135deg, var(--primary), #005f8d); color: white;
            border-radius: var(--radius); padding: 20px; text-align: center; margin-bottom: 20px;
        }
        .rank-big { font-size: 2.5em; font-weight: bold; }
        .leader-row {
            display: flex; justify-content: space-between; padding: 12px;
            border-bottom: 1px solid rgba(128,128,128,0.1); align-items: center;
        }
        .medal { width: 25px; display: inline-block; text-align: center; }

        /* --- Quiz Styles --- */
        .q-meta-bar {
            display: flex; justify-content: space-between; font-size: 0.85em;
            color: var(--text-secondary); margin-bottom: 15px;
        }
        .q-id-badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-weight: bold; color: #555; }
        .q-text { font-size: 1.15em; font-weight: 600; line-height: 1.5; margin-bottom: 20px; }
        
        .opt-btn {
            background: var(--card-bg); border: 1px solid rgba(0,0,0,0.1);
            padding: 15px; border-radius: 10px; width: 100%; text-align: right;
            margin-bottom: 10px; font-size: 1em; cursor: pointer; color: var(--text-primary);
        }
        .opt-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
        .opt-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .opt-btn.locked { pointer-events: none; opacity: 0.8; }

        /* --- Bottom Nav --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card-bg); height: 60px; display: flex;
            border-top: 1px solid rgba(0,0,0,0.1);
            z-index: 100;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.75em; color: var(--text-secondary); background: none; border: none;
        }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.5em; margin-bottom: 3px; }

    </style>
</head>
<body>

    <!-- 1. Loader (Internet Required) -->
    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <p style="margin-top:15px" id="loadMsg">Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</p>
    </div>

    <!-- 2. Main Views -->
    <div id="app" class="hidden">
        
        <header>
            <div class="header-title">ğŸ“ Exam Bot</div>
            <div class="score-display">ğŸ† <span id="headerScore">0</span></div>
        </header>

        <!-- VIEW: Home (Two Buttons) -->
        <div id="v-home" class="container">
            <div class="btn-card" onclick="startNavigation()">
                <div>
                    <h3>ğŸ“‚ ØªØµÙØ­ Ø§Ù„Ù…Ù†Ù‡Ø¬</h3>
                    <p>Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ­Ù„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>
                </div>
                <div style="font-size:2em">ğŸ“š</div>
            </div>

            <div class="btn-card" style="border-right: 4px solid var(--danger)" onclick="openMistakeList()">
                <div>
                    <h3>ğŸš§ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h3>
                    <p>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ Ø£Ø®Ø·Ø£Øª ÙÙŠÙ‡Ø§ (Ù…Ù‚Ø³Ù‘Ù…Ø© Ø¨Ø§Ù„Ø¯Ø±Ø³)</p>
                </div>
                <div style="font-size:2em">ğŸ–</div>
            </div>
            
            <hr style="border:0; border-top:1px solid #ddd; margin: 20px 0;">

            <div style="text-align: center; color: var(--text-secondary); font-size:0.9em;">
                <p>ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙÙ‚Ø· Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«</p>
                <button onclick="fetchData()" style="padding:10px 20px; border-radius:20px; border:none; background:var(--bg-color); color:var(--primary); cursor:pointer;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>

        <!-- VIEW: Tree Navigation (Browse) -->
        <div id="v-nav" class="container hidden">
            <button onclick="showHome()" style="border:none; background:none; color:var(--primary); margin-bottom:10px; cursor:pointer;">â¬…ï¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <h3 id="navTitle" style="margin-top:0">Ø§Ù„Ù…Ù†Ù‡Ø¬:</h3>
            <div id="navContainer"></div>
        </div>

        <!-- VIEW: Leaderboard -->
        <div id="v-leader" class="container hidden">
            <div class="rank-card">
                <div>ØªØ±ØªÙŠØ¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                <div class="rank-big" id="myRank">#--</div>
                <div style="font-size:0.9em">Ø¨ÙŠÙ† <span id="totalPlayers">--</span> Ø·Ø§Ù„Ø¨</div>
                <div style="margin-top:10px; font-weight:bold">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="myScoreDetails">0</span></div>
            </div>

            <h3 style="border-bottom: 2px solid var(--primary); display:inline-block">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</h3>
            <div style="background:var(--card-bg); border-radius:10px; margin-top:15px; box-shadow:var(--shadow)" id="leaderboardList">
                <div style="padding:20px; text-align:center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</div>
            </div>
        </div>

        <!-- VIEW: Quiz -->
        <div id="v-quiz" class="container hidden">
            <div class="q-meta-bar">
                <span id="quizCounter">1 / 5</span>
                <span class="q-id-badge" id="quizIdDisplay">ID: 0000</span>
                <span onclick="safeExit()" style="color:var(--danger); cursor:pointer">Ø®Ø±ÙˆØ¬ âœ–</span>
            </div>
            
            <div id="qContent">
                <!-- Question Loaded Here -->
            </div>
        </div>

        <!-- VIEW: Mistakes Menu (Lessons) -->
        <div id="v-mistakes-menu" class="container hidden">
             <button onclick="showHome()" style="border:none; background:none; color:var(--primary); margin-bottom:10px;">â¬…ï¸ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
             <h3>ğŸ”» Ø¯Ø±ÙˆØ³ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø®Ø·Ø§Ø¡:</h3>
             <div id="mistakesContainer"></div>
        </div>

    </div>

    <!-- 3. Bottom Navigation -->
    <div class="nav-bar" id="bottomBar">
        <button class="nav-item active" onclick="showHome()">
            <span class="nav-icon">ğŸ </span>
            <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </button>
        <button class="nav-item" onclick="showLeaderboard()">
            <span class="nav-icon">ğŸ“Š</span>
            <span>Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</span>
        </button>
    </div>

<script>
    /**
     * === CONFIG ===
     */
    const CONFIG = {
        firebase: {
            apiKey: "AIzaSyDEZFJmcXK2LxYAZ-Yjv_M1HbC6zi_qilg",
            authDomain: "exambotdb.firebaseapp.com",
            databaseURL: "https://exambotdb-default-rtdb.firebaseio.com",
            projectId: "exambotdb",
            storageBucket: "exambotdb.firebasestorage.app",
            messagingSenderId: "950600562980",
            appId: "1:950600562980:web:f993c22d45e5cfdd3d9bb1"
        }
    };

    /**
     * === SYSTEM ===
     */
    const TG = window.Telegram.WebApp;
    let DB = null;
    let UserID = "guest";
    let AppData = {
        questions: [],
        progress: {}, // { id: 'correct'|'wrong' }
        quizQueue: [],
        currIdx: 0
    };

    function init() {
        TG.ready(); TG.expand();
        if(TG.initDataUnsafe?.user?.id) UserID = TG.initDataUnsafe.user.id;

        // Theme
        if (TG.colorScheme === 'dark') document.body.classList.add('dark-mode');

        // Check Network
        if (!navigator.onLine) {
            document.getElementById('loadMsg').innerHTML = "<span style='color:red'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø§Ù†ØªØ±Ù†Øª!<br>Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØªØ·Ù„Ø¨ Ø§Ù†ØªØ±Ù†Øª Ù„Ù„Ø¹Ù…Ù„</span>";
            return;
        }

        // Init Firebase
        if (window.firebase && !firebase.apps.length) {
            firebase.initializeApp(CONFIG.firebase);
            DB = firebase.database();
        }

        fetchData();
    }

    // --- Data Engine (Network Only) ---
    async function fetchData() {
        try {
            document.getElementById('loadMsg').innerText = "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...";
            // 1. Fetch JSON List
            const lReq = await fetch('questions_list.json?t='+Date.now());
            const files = await lReq.json();

            // 2. Fetch Files Parallel
            const jobs = files.map(f => fetch('Questions/'+f).then(r=>r.json()));
            const results = await Promise.all(jobs);

            // 3. Process
            let allQ = [];
            results.forEach(res => {
                let meta = res.meta || {};
                let term = meta.source || "General";
                let lesson = meta.lesson || "Misc";
                
                res.questions.forEach(q => {
                    allQ.push({
                        ...q,
                        h: { term, lesson, chapter: q.chapter || "ÙØµÙ„ 1" }
                    });
                });
            });
            AppData.questions = allQ;

            // 4. Fetch Progress (Firebase)
            document.getElementById('loadMsg').innerText = "Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø­Ø³Ø§Ø¨Ùƒ...";
            if (UserID !== 'guest' && DB) {
                const snap = await DB.ref('users/'+UserID).once('value');
                const uData = snap.val() || {};
                AppData.progress = uData.progress || {};
            }

            // Ready
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            updateScoreHeader();

        } catch (e) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + e.message);
            document.getElementById('loadMsg').innerHTML = `<button onclick="location.reload()">Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>`;
        }
    }

    /**
     * === UI & LOGIC ===
     */
    
    // --- Helper for safe alerts in Old Telegram ---
    function safeConfirm(msg, callback) {
        // Fallback for version 6.0 which doesn't support showConfirm
        if(TG.showConfirm && TG.isVersionAtLeast && TG.isVersionAtLeast('6.2')) {
            TG.showConfirm(msg, (ok) => callback(ok));
        } else {
            let res = confirm(msg);
            callback(res);
        }
    }
    
    function safeHaptic(type) {
        if(TG.HapticFeedback && TG.isVersionAtLeast && TG.isVersionAtLeast('6.1')) {
            TG.HapticFeedback.notificationOccurred(type);
        }
    }

    function switchView(id) {
        ['v-home','v-nav','v-leader','v-quiz','v-mistakes-menu'].forEach(v => {
            document.getElementById(v).classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
        
        // Update Bottom Nav Active State
        document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
        if(id === 'v-leader') document.querySelectorAll('.nav-item')[1].classList.add('active');
        else document.querySelectorAll('.nav-item')[0].classList.add('active');
    }

    function showHome() { switchView('v-home'); updateScoreHeader(); }

    function updateScoreHeader() {
        // Calculate Logic
        let score = 0;
        Object.values(AppData.progress).forEach(s => { if(s==='correct') score++; });
        document.getElementById('headerScore').innerText = score;
    }

    // --- 1. Browse & Nav Logic ---
    let NavStack = []; // stores keys

    function startNavigation() {
        NavStack = [];
        renderNavTree(AppData.questions, 0); // Level 0: Terms (or flat list depending on data)
        switchView('v-nav');
    }

    function renderNavTree(dataSource) {
        // Group By Hierarchy based on depth
        // Assumption: JSON structure is simple, lets group by Meta.Lesson for simplicity or Term -> Lesson
        
        // For this Demo, we just List all Lessons found in questions
        const container = document.getElementById('navContainer');
        container.innerHTML = '';
        
        // Extract Unique Lessons
        let lessons = [...new Set(AppData.questions.map(q => q.h.lesson))];
        
        if (lessons.length === 0) container.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.";

        lessons.forEach(lsn => {
            const count = AppData.questions.filter(q => q.h.lesson === lsn).length;
            const card = document.createElement('div');
            card.className = 'btn-card';
            card.innerHTML = `<div><h3>${lsn}</h3><p>${count} Ø³Ø¤Ø§Ù„</p></div><div>â¡ï¸</div>`;
            card.onclick = () => startQuizContext(lsn);
            container.appendChild(card);
        });
    }

    function startQuizContext(lessonName) {
        // Filter by Lesson + New Questions (Default logic)
        let qList = AppData.questions.filter(q => q.h.lesson === lessonName);
        
        // Exclude solved Correctly
        qList = qList.filter(q => AppData.progress[q.id] !== 'correct');

        if(qList.length === 0) {
            alert("Ù„Ù‚Ø¯ Ø£ØªÙ…Ù…Øª Ø­Ù„ Ø¬Ù…ÙŠØ¹ Ø£Ø³Ø¦Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‘");
            return;
        }

        launchQuiz(qList);
    }

    // --- 2. Mistakes Logic ---
    function openMistakeList() {
        // Get all Wrong IDs
        const wrongIds = Object.keys(AppData.progress).filter(k => AppData.progress[k] === 'wrong');
        
        if(wrongIds.length === 0) {
            alert("Ø³Ø¬Ù„Ùƒ Ù†Ø¸ÙŠÙ! Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ù…Ø³Ø¬Ù„Ø© âœ…");
            return;
        }

        const container = document.getElementById('mistakesContainer');
        container.innerHTML = '';

        // Group IDs by Lesson
        let groups = {};
        wrongIds.forEach(id => {
            const q = AppData.questions.find(x => x.id == id);
            if(q) {
                let l = q.h.lesson;
                if(!groups[l]) groups[l] = [];
                groups[l].push(q);
            }
        });

        Object.keys(groups).forEach(lesson => {
            const card = document.createElement('div');
            card.className = 'btn-card';
            card.style.borderLeft = "4px solid var(--danger)";
            card.innerHTML = `<div><h3>${lesson}</h3><p>${groups[lesson].length} Ø£Ø®Ø·Ø§Ø¡</p></div><div>ğŸ–</div>`;
            card.onclick = () => launchQuiz(groups[lesson]);
            container.appendChild(card);
        });

        switchView('v-mistakes-menu');
    }

    // --- 3. QUIZ RUNTIME ---
    function launchQuiz(queue) {
        // Shuffle and limit
        queue.sort(() => Math.random() - 0.5);
        if(queue.length > 20) queue = queue.slice(0, 20); // Max 20 per session

        AppData.quizQueue = queue;
        AppData.currIdx = 0;
        
        switchView('v-quiz');
        renderCurrentQuestion();
    }

    function renderCurrentQuestion() {
        if(AppData.currIdx >= AppData.quizQueue.length) {
            safeConfirm("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±! Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø©ØŸ", (ok)=> showHome());
            return;
        }

        const Q = AppData.quizQueue[AppData.currIdx];
        
        // 1. Header Info
        document.getElementById('quizCounter').innerText = `${AppData.currIdx+1} / ${AppData.quizQueue.length}`;
        // >>> New: Show ID <<<
        document.getElementById('quizIdDisplay').innerText = `ID: ${Q.id}`;

        // 2. Content
        const contentDiv = document.getElementById('qContent');
        let imgHtml = Q.image ? `<img src="${Q.image}" style="max-width:100%; border-radius:10px; margin-bottom:15px">` : '';
        
        let html = `
            ${imgHtml}
            <div class="q-text">${Q.question}</div>
            <div id="optsBlock"></div>
            <div id="explBlock" class="hidden" style="margin-top:20px; padding:15px; background:#fff3cd; border-radius:8px; line-height:1.5;"></div>
            <button id="nextBtn" class="hidden" onclick="goNext()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; margin-top:20px; font-size:1.1em">Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸</button>
        `;
        contentDiv.innerHTML = html;

        // Render Options
        const optsBlock = document.getElementById('optsBlock');
        
        if (Q.type === 'matching') {
            optsBlock.innerHTML = "<div style='text-align:center; padding:20px; color:#777'>Ø³Ø¤Ø§Ù„ ØªÙˆØµÙŠÙ„ (ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ø®ÙÙŠÙØ©)ØŒ ØªØ®Ø·ÙŠ.</div>";
            document.getElementById('nextBtn').classList.remove('hidden');
            return;
        }

        Q.options.forEach((txt, i) => {
            const btn = document.createElement('div');
            btn.className = 'opt-btn';
            btn.innerText = txt;
            btn.onclick = () => handleAnswer(i, Q, btn);
            optsBlock.appendChild(btn);
        });
        
        window.scrollTo(0,0);
    }

    function handleAnswer(selIdx, Q, btnEl) {
        if(btnEl.parentElement.classList.contains('disabled')) return;
        btnEl.parentElement.classList.add('disabled');
        // Visually lock all
        Array.from(btnEl.parentElement.children).forEach(b => b.classList.add('locked'));

        const isCorrect = (selIdx === Q.correct_option_id);
        const status = isCorrect ? 'correct' : 'wrong';

        if(isCorrect) {
            btnEl.classList.add('correct');
            safeHaptic('success');
        } else {
            btnEl.classList.add('wrong');
            // Show real answer
            btnEl.parentElement.children[Q.correct_option_id]?.classList.add('correct');
            safeHaptic('error');
        }

        // Show Explanation
        if(Q.explanation) {
            const expl = document.getElementById('explBlock');
            expl.innerHTML = `<b>ğŸ’¡ Ø§Ù„Ø´Ø±Ø­:</b><br>${Q.explanation}`;
            expl.classList.remove('hidden');
        }

        // Save to Firebase & Local
        saveProgress(Q.id, status);

        // Show Next Button
        document.getElementById('nextBtn').classList.remove('hidden');
    }

    function saveProgress(qid, status) {
        AppData.progress[qid] = status;
        if(UserID !== 'guest' && DB) {
            DB.ref('users/'+UserID+'/progress/'+qid).set(status);
            // Increment simple score counter for leaderboard sorting
            if(status === 'correct') {
                 // Transaction to atomically increase score
                 DB.ref('users/'+UserID+'/score').transaction((curr) => (curr || 0) + 1);
            }
        }
    }

    function goNext() {
        AppData.currIdx++;
        renderCurrentQuestion();
    }

    function safeExit() {
        safeConfirm("Ù‡Ù„ ØªÙˆØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ", (ok)=>{
             if(ok) showHome();
        });
    }

    // --- 4. LEADERBOARD ---
    async function showLeaderboard() {
        switchView('v-leader');
        const listEl = document.getElementById('leaderboardList');
        
        // 1. My Stats
        let myScore = Object.values(AppData.progress).filter(s=>s==='correct').length;
        document.getElementById('myScoreDetails').innerText = myScore;

        if(!DB) { listEl.innerHTML = "<p>ØºÙŠØ± Ù…ØªØµÙ„ Ø¨ÙØ§ÙŠØ±Ø¨ÙŠØ³.</p>"; return; }

        try {
            // Fetch All Users Score (Simplified Approach: Assuming we stored 'score' property)
            // Ideally use Cloud Functions or limitToLast query
            const snap = await DB.ref('users').orderByChild('score').limitToLast(20).once('value');
            
            let players = [];
            snap.forEach(child => {
                let val = child.val();
                // Simple Guest or ID display. If user info like Name saved, display it.
                // Assuming TG passed first_name to FB earlier, else use "Student"
                players.push({
                    uid: child.key,
                    score: val.score || 0,
                    name: (child.key === UserID) ? "Ø£Ù†Øª" : "Ø·Ø§Ù„Ø¨" 
                });
            });

            // Sort Descending
            players.reverse(); 

            let myRank = players.findIndex(p => p.uid === UserID);
            
            // UI
            document.getElementById('totalPlayers').innerText = players.length + "+"; // Simulation
            document.getElementById('myRank').innerText = myRank !== -1 ? `#${myRank+1}` : "#--";

            let html = "";
            players.forEach((p, idx) => {
                let badge = "";
                if(idx===0) badge="ğŸ¥‡";
                if(idx===1) badge="ğŸ¥ˆ";
                if(idx===2) badge="ğŸ¥‰";

                html += `
                    <div class="leader-row" style="${p.uid === UserID ? 'background:#e3f2fd' : ''}">
                        <div><span class="medal">${badge || idx+1}</span> ${p.name}</div>
                        <div style="font-weight:bold">${p.score}</div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;

        } catch(e) {
            listEl.innerHTML = `<p style="padding:15px; color:red">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©<br>${e.message}</p>`;
        }
    }

    // --- Init ---
    window.addEventListener('load', init);

</script>
</body>
</html>
