<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Bot</title>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDKs (v9 Compat for simplicity via CDN) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --primary: #2196F3;
            --correct: #4CAF50;
            --wrong: #f44336;
            --radius: 12px;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* Dark Mode Integration */
        body.dark-mode {
            --bg-color: #1e1e1e;
            --card-bg: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding-bottom: 70px; /* Space for Bottom Nav */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.3s;
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 15px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .h-title { font-weight: bold; font-size: 1.1em; }
        .h-stats { font-size: 0.9em; color: var(--text-secondary); }

        /* Navigation List (Menu) */
        .menu-list { padding: 10px; }
        
        .menu-item {
            background: var(--card-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .menu-item:active { transform: scale(0.98); }
        .menu-count { background: #eee; padding: 4px 8px; border-radius: 8px; font-size: 0.8em; color: #555; }
        .menu-icon { margin-left: 10px; font-size: 1.2em; }

        /* Breadcrumb Navigation */
        .breadcrumb {
            padding: 10px 15px;
            font-size: 0.9em;
            color: var(--primary);
            background: rgba(33, 150, 243, 0.1);
            margin-bottom: 10px;
            cursor: pointer;
        }

        /* Filter Chips (Quiz Setup) */
        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; }
        .chip {
            padding: 8px 16px;
            background: var(--card-bg);
            border: 1px solid #ccc;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
        }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Question Card */
        .q-container { padding: 15px; max-width: 800px; margin: 0 auto; display: none; }
        .q-img { width: 100%; max-height: 250px; object-fit: contain; margin-bottom: 15px; border-radius: 8px; display: none; }
        .q-text { font-size: 1.2em; font-weight: 600; line-height: 1.5; margin-bottom: 20px; }

        .options-grid { display: flex; flex-direction: column; gap: 10px; }
        .opt-btn {
            padding: 15px;
            background: var(--card-bg);
            border: 2px solid transparent;
            border-radius: var(--radius);
            color: var(--text-primary);
            text-align: right;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            position: relative;
        }
        
        .opt-btn.correct { background: #E8F5E9; border-color: var(--correct); color: #2E7D32; }
        .opt-btn.wrong { background: #FFEBEE; border-color: var(--wrong); color: #C62828; }
        
        /* Matching Style overrides (Simulated) */
        .matching-area { display: flex; gap:10px; }
        
        /* Explanation Box */
        .explanation {
            margin-top: 20px;
            padding: 15px;
            background: #FFF8E1;
            border-right: 4px solid #FFC107;
            border-radius: 4px;
            color: #5d4037;
            display: none;
            animation: slideUp 0.3s ease;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--card-bg);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px;
            z-index: 200;
        }
        .nav-btn {
            border: none; background: none;
            color: var(--text-secondary);
            font-size: 0.8em;
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer;
        }
        .nav-btn.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.4em; margin-bottom: 4px; }

        /* States */
        .hidden { display: none !important; }
        .loading-screen { 
            position: fixed; inset: 0; background: var(--bg-color); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
    </style>
</head>
<body>

    <!-- 1. Loading Screen -->
    <div id="loader" class="loading-screen">
        <h3>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</h3>
        <p id="loaderMsg" style="font-size: 0.8em; color: #666">Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
    </div>

    <!-- 2. Main Interface (Hidden initially) -->
    <div id="mainApp" class="hidden">
        
        <header>
            <div>
                <div class="h-title" id="pageTitle">Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
                <div class="h-stats" id="userSyncStat">Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: Ø§Ù„Ø¢Ù†</div>
            </div>
            <div id="topStats" style="font-size:0.8em; text-align: left;">
                âœ… <span id="totalCorrect">0</span> | âŒ <span id="totalMistakes">0</span>
            </div>
        </header>

        <!-- A. Navigation Screen (Hierarchy) -->
        <div id="navScreen">
            <div id="breadcrumbBar" class="breadcrumb hidden" onclick="navigateBack()">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
            <div id="menuContainer" class="menu-list">
                <!-- Content injected via JS -->
            </div>
        </div>

        <!-- B. Quiz Setup Screen -->
        <div id="setupScreen" class="hidden">
            <div style="padding: 20px;">
                <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
                <p class="h-stats" id="setupSubtitle">Ø§Ù„ÙØµÙ„: Ù…Ù‚Ø¯Ù…Ø©</p>
                
                <h4>ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</h4>
                <div class="chips-container" id="modeChips">
                    <div class="chip active" onclick="setMode('new', this)">Ø£Ø³Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
                    <div class="chip" onclick="setMode('mistake', this)">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div>
                    <div class="chip" onclick="setMode('mixed', this)">Ù…Ø®ØªÙ„Ø· (Ø¹Ø´ÙˆØ§Ø¦ÙŠ)</div>
                </div>

                <h4>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</h4>
                <div class="chips-container" id="qtyChips">
                    <div class="chip active" onclick="setQty(5, this)">5</div>
                    <div class="chip" onclick="setQty(10, this)">10</div>
                    <div class="chip" onclick="setQty(20, this)">20</div>
                    <div class="chip" onclick="setQty(50, this)">50</div>
                    <div class="chip" onclick="setQty(9999, this)">Ø§Ù„ÙƒÙ„</div>
                </div>

                <div style="margin-top: 30px; text-align: center; color: red; font-size: 0.9em; display: none" id="noQuestionsMsg">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (Ù…Ø«Ù„Ø§Ù‹ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø£Ø®Ø·Ø§Ø¡ Ù…Ø³Ø¬Ù„Ø©).
                </div>

                <button onclick="startQuizEngine()" class="opt-btn" style="width: 100%; background: var(--primary); color: white; text-align: center; margin-top: 20px; font-weight: bold;">
                    Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ğŸš€
                </button>
            </div>
        </div>

        <!-- C. Active Quiz Screen -->
        <div id="quizScreen" class="q-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span id="quizCounter">1 / 10</span>
                <span onclick="exitQuiz()" style="color:red; cursor:pointer;">Ø®Ø±ÙˆØ¬</span>
            </div>
            
            <div id="quizCard">
                <!-- Image area -->
                <img id="qImage" class="q-img" alt="Question Image" />
                <!-- Text -->
                <div id="qText" class="q-text"></div>
                <!-- Options -->
                <div id="qOptions" class="options-grid"></div>
                <!-- Explanation -->
                <div id="qExplanation" class="explanation"></div>
                
                <button id="nextQBtn" onclick="nextQuestion()" class="opt-btn hidden" style="width:100%; background:var(--primary); color:white; text-align:center; margin-top:15px">Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸</button>
            </div>
        </div>
        
        <!-- Bottom Nav -->
        <div class="bottom-nav" id="bottomNav">
            <button class="nav-btn active" onclick="goToHome()">
                <span class="nav-icon">ğŸ </span>
                Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </button>
            <button class="nav-btn" onclick="goToStats()">
                <span class="nav-icon">ğŸ“Š</span>
                Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ
            </button>
        </div>

    </div>

<script>
    /**
     * ==========================================
     * CONFIGURATION (ØªØ¹Ø¯ÙŠÙ„: Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù‡Ù†Ø§)
     * ==========================================
     */
    const firebaseConfig = {
        apiKey: "AIzaVyDxxxxxxxxxxxxxxxxxxxxxxxxx",
        authDomain: "your-project.firebaseapp.com",
        databaseURL: "https://your-project-default-rtdb.firebaseio.com",
        projectId: "your-project",
        storageBucket: "your-project.appspot.com",
        messagingSenderId: "123456789",
        appId: "1:123456789:web:abcdef"
    };

    /** INITIALIZATION */
    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    
    // Telegram App
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    // Set Theme
    if (tg.colorScheme === 'dark') document.body.classList.add('dark-mode');

    // Current User (From Telegram or Guest)
    const userId = tg.initDataUnsafe?.user?.id || 'guest_user';
    console.log("Current User:", userId);

    /** STATE MANAGEMENT */
    let appData = {
        rawQuestions: [],
        hierarchy: {}, // Tree structure
        userProgress: {}, // Synced from DB
        currentPath: [], // Navigation stack [Term, Subject, Lesson]
        quizQueue: [],
        currentQIndex: 0,
        settings: { mode: 'new', qty: 5 },
        selectedNodeName: null // Used for quiz filtering
    };

    /** --- 1. DATA SYNC & LOADING --- */

    async function initApp() {
        try {
            document.getElementById('loaderMsg').innerText = "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...";
            // 1. Fetch JSON Lists
            const listReq = await fetch('questions_list.json?t=' + Date.now());
            const fileList = await listReq.json();
            
            // 2. Load Content
            const promises = fileList.map(f => fetch('Questions/' + f).then(r => r.json()));
            const filesData = await Promise.all(promises);
            
            // 3. Process & Build Hierarchy
            filesData.forEach(file => {
                const meta = file.meta || {}; // Expects {term, subject, lesson} in json
                // Default meta if missing
                const term = meta.source || "General"; 
                const lesson = meta.lesson || "Misc";
                const subject = meta.subject || "All";

                file.questions.forEach(q => {
                    const enhancedQ = {
                        ...q,
                        meta: { term, subject, lesson, chapter: q.chapter || "Uncategorized" }
                    };
                    appData.rawQuestions.push(enhancedQ);
                });
            });

            // 4. Build Tree
            buildHierarchy();

            document.getElementById('loaderMsg').innerText = "Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ‚Ø¯Ù…...";
            // 5. Sync User Data from Firebase
            await syncUserFromFirebase();

            // Ready
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            renderMenu();
            updateTopStats();

        } catch (e) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: " + e.message);
        }
    }

    function buildHierarchy() {
        // Levels: Term -> Subject -> Lesson -> Chapter
        appData.hierarchy = {};

        appData.rawQuestions.forEach(q => {
            const m = q.meta;
            if (!appData.hierarchy[m.term]) appData.hierarchy[m.term] = {};
            if (!appData.hierarchy[m.term][m.subject]) appData.hierarchy[m.term][m.subject] = {};
            if (!appData.hierarchy[m.term][m.subject][m.lesson]) appData.hierarchy[m.term][m.subject][m.lesson] = {};
            if (!appData.hierarchy[m.term][m.subject][m.lesson][m.chapter]) appData.hierarchy[m.term][m.subject][m.lesson][m.chapter] = 0; // count

            appData.hierarchy[m.term][m.subject][m.lesson][m.chapter]++;
        });
    }

    async function syncUserFromFirebase() {
        if(userId === 'guest_user') return;
        const snapshot = await db.ref('users/' + userId).once('value');
        const data = snapshot.val();
        if (data) {
            appData.userProgress = data.progress || {}; // Key: Question ID, Value: 'correct' | 'wrong'
        }
    }

    /** --- 2. NAVIGATION LOGIC --- */

    function renderMenu() {
        const container = document.getElementById('menuContainer');
        container.innerHTML = '';
        
        // Determine what level to show based on currentPath
        let currentPointer = appData.hierarchy;
        let levelName = "Ø§Ù„ØªØ±Ù…";
        
        // Traverse down
        appData.currentPath.forEach(key => {
            currentPointer = currentPointer[key];
        });

        const depth = appData.currentPath.length; // 0=Terms, 1=Subject, 2=Lessons, 3=Chapters
        
        // Breadcrumb
        const bread = document.getElementById('breadcrumbBar');
        if (depth > 0) {
            bread.classList.remove('hidden');
            bread.innerText = `ğŸ”™ Ø±Ø¬ÙˆØ¹ | ${appData.currentPath.join(' > ')}`;
        } else {
            bread.classList.add('hidden');
        }

        // Check if we are at Chapter Level (The Leaves)
        // If currentPointer contains Numbers, it means keys are chapters
        const isChapterLevel = depth === 3; 

        // Generate Buttons
        const keys = Object.keys(currentPointer);

        if (depth === 2) {
            // At Lesson level, user selects a specific Lesson -> show Chapters
            // Also option to test WHOLE Lesson (All Chapters)
             /* Logic handled next step */
        }

        if (isChapterLevel) {
            // Display "Test All Chapters" Option
            const allBtn = document.createElement('div');
            allBtn.className = 'menu-item';
            allBtn.style.background = '#E3F2FD';
            allBtn.innerHTML = `<div><span style="font-weight:bold">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±Ø³ ÙƒØ§Ù…Ù„Ø§Ù‹</span> <br><small>ÙƒÙ„ Ø§Ù„ÙØµÙˆÙ„</small></div> <span class="menu-count">Ø´Ø§Ù…Ù„</span>`;
            allBtn.onclick = () => openSetup('all_chapters');
            container.appendChild(allBtn);
        }

        keys.forEach(key => {
            // Count logic
            let count = 0;
            if (isChapterLevel) {
                count = currentPointer[key]; // direct count
            } else {
                // Recursive count for nodes
                count = getRecursiveCount(currentPointer[key]);
            }

            const el = document.createElement('div');
            el.className = 'menu-item';
            
            // Icon
            let icon = 'ğŸ“‚';
            if (depth === 0) icon = 'ğŸ“…';
            if (depth === 1) icon = 'ğŸ“˜';
            if (depth === 2) icon = 'ğŸ“';
            if (depth === 3) icon = 'ğŸ”–';

            el.innerHTML = `
                <div style="display:flex; align-items:center">
                    <span class="menu-icon">${icon}</span>
                    <span style="margin-right:10px; font-weight:500">${key}</span>
                </div>
                <span class="menu-count">${count}</span>
            `;

            el.onclick = () => {
                if (isChapterLevel) {
                    openSetup(key); // Selected specific chapter
                } else {
                    appData.currentPath.push(key);
                    renderMenu();
                }
            };
            container.appendChild(el);
        });
    }

    function getRecursiveCount(node) {
        if (typeof node === 'number') return node;
        let sum = 0;
        for (let k in node) sum += getRecursiveCount(node[k]);
        return sum;
    }

    function navigateBack() {
        if (appData.currentPath.length > 0) {
            appData.currentPath.pop();
            renderMenu();
        }
    }

    function goToHome() {
        document.getElementById('navScreen').classList.remove('hidden');
        document.getElementById('setupScreen').classList.add('hidden');
        document.getElementById('quizScreen').classList.add('hidden');
        document.querySelector('.bottom-nav').classList.remove('hidden');
        
        // Reset path
        appData.currentPath = [];
        renderMenu();
    }
    
    function goToStats() {
       alert("ØµÙØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±) - Ø³ØªØ¹Ø±Ø¶ Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ ØªÙ… Ø­Ù„Ù‡Ø§.");
    }

    /** --- 3. QUIZ SETUP & FILTERING --- */

    function openSetup(selectionName) {
        appData.selectedNodeName = selectionName;
        document.getElementById('navScreen').classList.add('hidden');
        document.getElementById('setupScreen').classList.remove('hidden');
        
        document.getElementById('setupSubtitle').innerText = 
            `Ø§Ù„Ù…Ø³Ø§Ø±: ${appData.currentPath[2]} > ${selectionName === 'all_chapters' ? 'Ø§Ù„ÙƒÙ„' : selectionName}`;
        
        document.getElementById('noQuestionsMsg').style.display = 'none';
    }

    function setMode(mode, el) {
        appData.settings.mode = mode;
        document.querySelectorAll('#modeChips .chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }
    
    function setQty(qty, el) {
        appData.settings.qty = qty;
        document.querySelectorAll('#qtyChips .chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }

    function startQuizEngine() {
        const mode = appData.settings.mode; // new, mistake, mixed
        const currentMeta = {
            term: appData.currentPath[0],
            subject: appData.currentPath[1],
            lesson: appData.currentPath[2],
            chapter: appData.selectedNodeName
        };

        // 1. Filter Questions based on Path
        let candidates = appData.rawQuestions.filter(q => {
            const m = q.meta;
            let match = m.term == currentMeta.term && m.subject == currentMeta.subject && m.lesson == currentMeta.lesson;
            if (currentMeta.chapter !== 'all_chapters') {
                match = match && (m.chapter == currentMeta.chapter);
            }
            return match;
        });

        // 2. Filter based on MODE
        if (mode === 'new') {
            // Keep if user hasn't answered correctly yet
            candidates = candidates.filter(q => {
                const status = appData.userProgress[q.id];
                return status !== 'correct'; 
            });
        } else if (mode === 'mistake') {
            // Keep only wrongs
            candidates = candidates.filter(q => {
                return appData.userProgress[q.id] === 'wrong';
            });
        }
        // 'mixed' = no extra filtering needed initially, just shuffle

        if (candidates.length === 0) {
            document.getElementById('noQuestionsMsg').style.display = 'block';
            return;
        }

        // 3. Shuffle & Slice Quantity
        candidates.sort(() => Math.random() - 0.5);
        appData.quizQueue = candidates.slice(0, appData.settings.qty);
        
        // Launch Quiz UI
        appData.currentQIndex = 0;
        document.getElementById('setupScreen').classList.add('hidden');
        document.querySelector('.bottom-nav').classList.add('hidden'); // Immersive
        document.getElementById('quizScreen').classList.remove('hidden');
        document.getElementById('quizScreen').style.display = 'block';
        
        renderQuestionCard();
    }


    /** --- 4. QUIZ RUNTIME & SYNC --- */

    function renderQuestionCard() {
        const q = appData.quizQueue[appData.currentQIndex];
        const container = document.getElementById('quizCard');
        
        // Reset State
        document.getElementById('nextQBtn').classList.add('hidden');
        document.getElementById('qExplanation').style.display = 'none';
        
        // Update Counter
        document.getElementById('quizCounter').innerText = `${appData.currentQIndex + 1} / ${appData.quizQueue.length}`;

        // Image Handling
        const img = document.getElementById('qImage');
        if (q.image_url) { // Assumed JSON key for image
            img.src = q.image_url;
            img.style.display = 'block';
        } else {
            img.style.display = 'none';
        }

        // Text
        document.getElementById('qText').innerHTML = q.question; // Support HTML text

        // Options (Handle MCQ)
        const optDiv = document.getElementById('qOptions');
        optDiv.innerHTML = '';
        
        if (q.type === 'mcq' || !q.type) { // Default to mcq
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = 'opt-btn';
                btn.innerText = opt;
                btn.onclick = () => submitAnswer(idx, q);
                optDiv.appendChild(btn);
            });
        } else if (q.type === 'matching') {
            optDiv.innerHTML = `<div style="text-align:center; padding:20px; color:#666">Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙƒØªØ¨ÙŠ. (ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ)</div>`;
            document.getElementById('nextQBtn').classList.remove('hidden');
        }
    }

    function submitAnswer(selectedIdx, questionData) {
        // 1. Visual Feedback
        const btns = document.querySelectorAll('.opt-btn');
        btns.forEach(b => b.style.pointerEvents = 'none'); // Lock
        
        const isCorrect = selectedIdx === questionData.correct_option_id; // Check field name from JSON
        
        if (isCorrect) {
            btns[selectedIdx].classList.add('correct');
        } else {
            btns[selectedIdx].classList.add('wrong');
            // Show correct
            btns[questionData.correct_option_id]?.classList.add('correct');
        }

        // 2. Show Explanation
        if (questionData.explanation) {
            const expBox = document.getElementById('qExplanation');
            expBox.innerHTML = `<strong>ğŸ’¡ Ø§Ù„Ø´Ø±Ø­:</strong><br>${questionData.explanation}`;
            expBox.style.display = 'block';
        }

        // 3. SYNC TO FIREBASE
        saveResultToCloud(questionData.id, isCorrect ? 'correct' : 'wrong');

        // 4. Show Next
        document.getElementById('nextQBtn').classList.remove('hidden');
        document.getElementById('nextQBtn').scrollIntoView({behavior: 'smooth'});
    }

    function saveResultToCloud(qId, status) {
        if (!qId || userId === 'guest_user') return;
        
        // Local update
        appData.userProgress[qId] = status;
        
        // Cloud update
        // We use .update to avoid overwriting other keys
        db.ref('users/' + userId + '/progress').update({
            [qId]: status
        }).then(() => {
             updateTopStats();
        });
    }

    function nextQuestion() {
        if (appData.currentQIndex < appData.quizQueue.length - 1) {
            appData.currentQIndex++;
            renderQuestionCard();
            window.scrollTo(0,0);
        } else {
            // End of Quiz
            alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±! ğŸ‰");
            goToHome();
        }
    }

    function exitQuiz() {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ù…Ø§ Ø£Ø¬Ø¨ØªÙ‡ ÙÙ‚Ø·.")) {
            goToHome();
        }
    }

    function updateTopStats() {
        // Calculate form appData.userProgress
        let correct = 0, wrong = 0;
        Object.values(appData.userProgress).forEach(status => {
            if (status === 'correct') correct++;
            if (status === 'wrong') wrong++;
        });
        document.getElementById('totalCorrect').innerText = correct;
        document.getElementById('totalMistakes').innerText = wrong;
    }

    // Start App on Load
    window.addEventListener('load', initApp);

</script>
</body>
</html>
