<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedQuiz Ultimate</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <style>
        :root {
            /* Default Theme (Light) */
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-main: #2d3436;
            --text-sec: #636e72;
            --primary: #6c5ce7;
            --secondary: #00cec9;
            --accent: #ff7675;
            --success: #00b894;
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Themes */
        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #2d3436 0%, #000000 100%);
            --card-bg: rgba(45, 52, 54, 0.85);
            --text-main: #dfe6e9;
            --text-sec: #b2bec3;
            --primary: #a29bfe;
            --secondary: #81ecec;
        }
        [data-theme="midnight"] {
            --bg-gradient: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            --card-bg: rgba(16, 33, 41, 0.8);
            --text-main: #ecf0f1;
            --primary: #f1c40f;
            --secondary: #e67e22;
        }
        [data-theme="cyberpunk"] {
            --bg-gradient: linear-gradient(45deg, #110022, #330033);
            --card-bg: rgba(20, 10, 30, 0.9);
            --text-main: #0ff;
            --text-sec: #f0f;
            --primary: #f0f;
            --secondary: #0ff;
            --glass-border: 1px solid #0ff;
        }
        [data-theme="ocean"] {
            --bg-gradient: linear-gradient(to top, #1cb5e0 0%, #000851 100%);
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-main: #004e92;
            --primary: #004e92;
        }

        * { box-sizing: border-box; transition: background 0.3s, color 0.3s; }
        
        body {
            margin: 0; padding: 0;
            font-family: var(--font-family);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            background: var(--bg-gradient);
            user-select: none;
        }

        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
        }

        .container {
            position: relative; z-index: 1;
            width: 100%; height: 100%; max-width: 900px; margin: 0 auto;
            display: flex; flex-direction: column; padding: 10px;
        }

        /* --- Glassmorphism UI Components --- */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 16px;
            border: var(--glass-border);
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 10px;
        }

        /* Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px;
        }
        
        .logo h1 { margin: 0; font-size: 1.4rem; background: -webkit-linear-gradient(45deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .top-btns button {
            background: none; border: none; font-size: 1.3rem; cursor: pointer;
            margin-left: 8px; transition: transform 0.2s; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        .top-btns button:hover { transform: scale(1.1); }

        /* Main Menu Grid */
        .grid-menu {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px; padding: 10px; flex-grow: 1; overflow-y: auto;
        }

        .menu-card {
            background: var(--card-bg);
            border-radius: 16px; padding: 20px; text-align: center;
            border: var(--glass-border); box-shadow: var(--shadow);
            cursor: pointer; position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 120px;
        }
        
        .menu-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            transform: rotate(45deg); opacity: 0; transition: opacity 0.3s;
        }
        .menu-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.2); }
        .menu-card:hover::before { opacity: 1; }

        .menu-card .icon { font-size: 2.5rem; margin-bottom: 10px; }
        .menu-card h3 { margin: 0; font-size: 1rem; color: var(--text-main); }
        .menu-card small { font-size: 0.75rem; color: var(--text-sec); margin-top: 5px; }

        /* Selection Screen */
        .selection-area { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        
        .section-header {
            width: 100%; padding: 10px; margin: 15px 0 5px 0;
            background: linear-gradient(90deg, var(--primary), transparent);
            color: #fff; border-radius: 8px; font-weight: bold; font-size: 0.9rem;
        }

        .options-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .select-btn {
            background: rgba(255,255,255,0.5); border: 1px solid var(--primary);
            color: var(--text-main); padding: 8px 15px; border-radius: 20px;
            cursor: pointer; flex: 1 1 auto; text-align: center; font-size: 0.9rem;
            display: flex; justify-content: center; align-items: center; gap: 5px;
            min-width: 100px;
        }
        .select-btn:hover { background: var(--primary); color: #fff; }
        .select-btn.selected { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* Quiz UI */
        .quiz-view { display: none; flex-direction: column; height: 100%; }
        
        .q-card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            box-shadow: var(--shadow); margin-bottom: 15px; border: var(--glass-border);
            font-size: 1.1rem; line-height: 1.6; direction: ltr; text-align: left;
            position: relative;
        }

        .option-row {
            background: rgba(255,255,255,0.4); border: 1px solid rgba(0,0,0,0.1);
            padding: 12px 15px; margin-bottom: 8px; border-radius: 12px;
            cursor: pointer; direction: ltr; text-align: left; display: flex; justify-content: space-between;
        }
        .option-row:hover { background: rgba(255,255,255,0.8); transform: translateX(5px); }
        .option-row.correct { background: var(--success); color: white; border-color: var(--success); }
        .option-row.wrong { background: var(--accent); color: white; border-color: var(--accent); }

        .key-hint { 
            background: rgba(0,0,0,0.1); width: 24px; height: 24px; 
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 0.75rem; font-weight: bold;
        }

        /* Bottom Bar */
        .bottom-nav {
            margin-top: auto; padding-top: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .btn-modern {
            background: var(--primary); color: white; border: none;
            padding: 10px 20px; border-radius: 30px; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 5px;
        }
        .btn-modern:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-sec { background: var(--text-sec); }
        .btn-success { background: var(--success); }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
        }
        .modal-box {
            background: var(--card-bg); width: 90%; max-width: 400px;
            border-radius: 20px; padding: 25px; border: var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .mirror-mode { transform: scaleX(-1); }

    </style>
</head>
<body data-theme="light" id="body-el">

<canvas id="bg-canvas"></canvas>

<div class="container" id="main-container">
    <header class="glass-panel">
        <div class="logo">
            <h1>MedQuiz Ultimate</h1>
            <small id="status-txt" style="color:var(--text-sec)">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©...</small>
        </div>
        <div class="top-btns">
            <button onclick="shareBot()" title="Ø¯Ø¹ÙˆØ© ØµØ¯ÙŠÙ‚">ğŸ”—</button>
            <button onclick="openLeaderboard()" title="Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†">ğŸ†</button>
            <button onclick="openSettings()" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™ï¸</button>
        </div>
    </header>

    <div class="content-wrapper" style="flex-grow:1; display:flex; flex-direction:column; overflow:hidden;">
        
        <!-- === HOME MENU === -->
        <div id="view-home" class="grid-menu">
            <div class="menu-card" onclick="startSelection('normal')">
                <div class="icon">ğŸš€</div>
                <h3>Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
                <small>Ø§Ø®ØªØ± Ø¯Ø±ÙˆØ³Ùƒ Ø¨Ù†ÙØ³Ùƒ</small>
            </div>
            <div class="menu-card" onclick="startSelection('mistakes')">
                <div class="icon">âš ï¸</div>
                <h3>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h3>
                <small>Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„ØªÙŠ Ø£Ø®Ø·Ø£Øª Ø¨Ù‡Ø§</small>
            </div>
            <div class="menu-card" style="border-color:var(--accent)" onclick="luckyShot()">
                <div class="icon">ğŸ</div>
                <h3>Ø¶Ø±Ø¨Ø© Ø­Ø¸</h3>
                <small>Ø³Ø¤Ø§Ù„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙÙˆØ±Ø§Ù‹!</small>
            </div>
            <div class="menu-card" style="border-color:var(--primary)" onclick="toggleMirrorMode()">
                <div class="icon">ğŸ”®</div>
                <h3>ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø¢Ø©</h3>
                <small>Ø§Ù‚Ù„Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„ØªØ­Ø¯ÙŠ</small>
            </div>
            <div class="menu-card" onclick="startMode('fav')">
                <div class="icon">â­</div>
                <h3>Ø§Ù„Ù…ÙØ¶Ù„Ø©</h3>
                <small>Ø§Ù„Ø§Ø®ØªØµØ§Ø±: S</small>
            </div>
            <div class="menu-card" onclick="document.getElementById('modal-search').style.display='flex'">
                <div class="icon">ğŸ”</div>
                <h3>Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</h3>
                <small>Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù€ ID</small>
            </div>
        </div>

        <!-- === SELECTION PANEL === -->
        <div id="view-select" class="glass-panel hidden" style="height:100%; display:none; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:10px;">
                <h3 id="step-title" style="margin:0; color:var(--primary)">Ø§Ø®ØªØ±...</h3>
                <button class="btn-modern btn-sec" style="padding:5px 15px; font-size:0.8rem;" onclick="goHome()">Ø¹ÙˆØ¯Ø© ğŸ </button>
            </div>

            <div id="selection-content" class="selection-area"></div>

            <div class="bottom-nav">
                <button id="btn-all" class="btn-modern btn-sec hidden" onclick="toggleSelectAll()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
                <button class="btn-modern" onclick="nextStep()">Ø§Ù„ØªØ§Ù„ÙŠ â¡</button>
            </div>
        </div>

        <!-- === QUIZ VIEW === -->
        <div id="view-quiz" class="quiz-view">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.85rem; color:var(--text-sec);">
                <span>ID: <b id="q-id">---</b></span>
                <span id="q-counter">1 / 10</span>
                <span id="fav-trigger" style="cursor:pointer" onclick="toggleFav()">â˜† Ø­ÙØ¸</span>
            </div>

            <div class="q-card">
                <div style="font-size:0.8rem; color:var(--primary); margin-bottom:5px;" id="q-crumb">Path</div>
                <div id="q-text">Loading...</div>
            </div>

            <div id="q-options" style="flex-grow:1; overflow-y:auto;"></div>

            <div id="q-exp" class="glass-panel" style="display:none; margin-top:10px; background:#e3f2fd; color:#333; direction:ltr;"></div>

            <div class="bottom-nav">
                <button class="btn-modern btn-sec" onclick="goHome()">Ø®Ø±ÙˆØ¬</button>
                <button id="btn-next" class="btn-modern hidden" onclick="nextQ()">Ø§Ù„ØªØ§Ù„ÙŠ (Space)</button>
            </div>
        </div>

    </div>
</div>

<!-- === MODALS === -->
<!-- Settings -->
<div id="modal-settings" class="modal-overlay" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-box">
        <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <p>ğŸ¨ Ø§Ø®ØªØ± Ø§Ù„Ø«ÙŠÙ…:</p>
        <div class="options-grid" style="justify-content:center; margin-bottom:15px;">
            <button class="select-btn" onclick="setAppTheme('light')">â˜€ï¸ Light</button>
            <button class="select-btn" onclick="setAppTheme('dark')">ğŸŒ‘ Dark</button>
            <button class="select-btn" onclick="setAppTheme('midnight')">ğŸŒŒ Midnight</button>
            <button class="select-btn" onclick="setAppTheme('cyberpunk')">ğŸ¤– Cyber</button>
            <button class="select-btn" onclick="setAppTheme('ocean')">ğŸŒŠ Ocean</button>
        </div>
        <p>âœ¨ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©:</p>
        <div class="options-grid" style="justify-content:center;">
            <button class="select-btn" onclick="setAnim('bubbles')">ğŸ«§ Bubbles</button>
            <button class="select-btn" onclick="setAnim('particles')">âœ¨ Particles</button>
            <button class="select-btn" onclick="setAnim('none')">ğŸš« None</button>
        </div>
        <br>
        <button class="btn-modern" style="width:100%" onclick="document.getElementById('modal-settings').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<!-- Leaderboard -->
<div id="modal-lb" class="modal-overlay" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-box">
        <h3 style="color:#f1c40f">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</h3>
        <input type="text" id="p-name" placeholder="Ø§Ø³Ù…Ùƒ" style="padding:10px; width:100%; border-radius:10px; border:1px solid #ccc; margin-bottom:10px;">
        <button class="btn-modern" style="width:100%" onclick="submitScore()">ØªØ³Ø¬ÙŠÙ„ Ù†Ù‚Ø§Ø·ÙŠ (<span id="my-xp">0</span>)</button>
        <div id="lb-list" style="margin-top:15px; text-align:left; max-height:200px; overflow-y:auto; font-size:0.9rem;"></div>
    </div>
</div>

<!-- Search -->
<div id="modal-search" class="modal-overlay" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-box">
        <h3>Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„</h3>
        <input type="number" id="s-inp" style="padding:10px; width:100%; border-radius:10px; margin:15px 0;" placeholder="ID...">
        <button class="btn-modern" onclick="doSearch()">Ø¨Ø­Ø«</button>
    </div>
</div>

<script>
    // --- Config & State ---
    const CONFIG = {
        files: 'questions_list.json',
        firebase: {
            apiKey: "AIzaSyDEZFJmcXK2LxYAZ-Yjv_M1HbC6zi_qilg",
            authDomain: "exambotdb.firebaseapp.com",
            databaseURL: "https://exambotdb-default-rtdb.firebaseio.com",
            projectId: "exambotdb",
            storageBucket: "exambotdb.firebasestorage.app",
            messagingSenderId: "950600562980",
            appId: "1:950600562980:web:f993c22d45e5cfdd3d9bb1"
        }
    };

    firebase.initializeApp(CONFIG.firebase);
    const db = firebase.database();

    let allQs = [], activePool = [], quizQ = [], qIdx = 0;
    let user = { xp: parseInt(localStorage.getItem('xp')||0), mistakes: JSON.parse(localStorage.getItem('mis')||'[]'), fav: JSON.parse(localStorage.getItem('fav')||'[]') };
    let sel = { term:null, subj:null, lessons:[], chapters:[] };
    let currStep = '';
    let animationType = localStorage.getItem('anim') || 'bubbles';
    let currentTheme = localStorage.getItem('theme') || 'light';

    // --- Init ---
    window.onload = async () => {
        setAppTheme(currentTheme);
        initCanvas();
        try {
            const list = await (await fetch(CONFIG.files)).json();
            for(let f of list) {
                try {
                    let d = await (await fetch(`Questions/${f}`)).json();
                    allQs.push(...d.questions.map(q => ({
                        ...q,
                        term: q.term || d.meta.source,
                        subject: q.subject || d.meta.subject,
                        lesson: q.lesson || d.meta.lesson,
                        chapter: q.chapter || "General"
                    })));
                } catch(e){}
            }
            document.getElementById('status-txt').innerText = `${allQs.length} Ø³Ø¤Ø§Ù„ Ù…ØªØ§Ø­`;
        } catch(e) { document.getElementById('status-txt').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„"; }
    };

    // --- Navigation & Selection ---
    function switchView(id) {
        ['view-home','view-select','view-quiz'].forEach(v => document.getElementById(v).classList.add('hidden')); // fix: add hidden class instead of display:none directly to toggle flex
        document.getElementById(id).classList.remove('hidden');
        if(id === 'view-select' || id === 'view-quiz') document.getElementById(id).style.display = 'flex';
        else document.getElementById(id).style.display = 'grid'; // Home is grid
    }

    function startSelection(mode) {
        activePool = mode === 'mistakes' ? allQs.filter(q => user.mistakes.includes(q.id)) : allQs;
        if(!activePool.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹");
        sel = {term:null, subj:null, lessons:[], chapters:[]};
        renderStep('term');
    }

    function renderStep(step) {
        currStep = step;
        switchView('view-select');
        const cont = document.getElementById('selection-content');
        cont.innerHTML = '';
        const title = document.getElementById('step-title');
        const btnAll = document.getElementById('btn-all');
        btnAll.classList.add('hidden');

        // Logic
        let items = [], isMulti = false;
        const sub = activePool.filter(q => 
            (!sel.term || q.term === sel.term) && 
            (!sel.subj || q.subject === sel.subj)
        );

        if(step === 'term') { title.innerText = "1. Ø§Ø®ØªØ± Ø§Ù„ØªØ±Ù…"; items = [...new Set(sub.map(q=>q.term))]; }
        else if(step === 'subj') { title.innerText = "2. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©"; items = [...new Set(sub.map(q=>q.subject))]; }
        else if(step === 'lesson') { 
            title.innerText = "3. Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±ÙˆØ³"; isMulti = true; btnAll.classList.remove('hidden');
            items = [...new Set(sub.map(q=>q.lesson))]; 
        }
        else if(step === 'chapter') {
            title.innerText = "4. Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¨Ø§ØªØ±"; isMulti = true; btnAll.classList.remove('hidden');
            // Grouping Logic requested
            sel.lessons.forEach(l => {
                const header = document.createElement('div');
                header.className = 'section-header';
                header.innerText = `ğŸ“‚ ${l}`;
                cont.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'options-grid';
                
                const chapters = [...new Set(sub.filter(q => q.lesson === l).map(q => q.chapter))];
                chapters.forEach(ch => {
                    const btn = createSelBtn(ch, sub.filter(q=>q.lesson===l && q.chapter===ch).length, true);
                    grid.appendChild(btn);
                });
                cont.appendChild(grid);
            });
            return; // Custom rendering done
        }

        // Render standard grid
        const grid = document.createElement('div');
        grid.className = 'options-grid';
        items.sort().forEach(i => grid.appendChild(createSelBtn(i, 0, isMulti))); // Count logic simplified
        cont.appendChild(grid);
    }

    function createSelBtn(val, count, isMulti) {
        const btn = document.createElement('div');
        btn.className = 'select-btn';
        btn.innerHTML = `<span>${val}</span>`;
        btn.dataset.val = val;
        btn.onclick = () => {
            if(isMulti) btn.classList.toggle('selected');
            else {
                if(currStep === 'term') { sel.term = val; renderStep('subj'); }
                else if(currStep === 'subj') { sel.subj = val; renderStep('lesson'); }
            }
        };
        return btn;
    }

    function nextStep() {
        const allSel = Array.from(document.querySelectorAll('.select-btn.selected'));
        if(currStep === 'lesson') {
            if(!allSel.length) return alert('Ø§Ø®ØªØ± Ø¯Ø±Ø³Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
            sel.lessons = allSel.map(b=>b.dataset.val);
            renderStep('chapter');
        } else if(currStep === 'chapter') {
            if(!allSel.length) return alert('Ø§Ø®ØªØ± Ø´Ø§Ø¨ØªØ± ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
            sel.chapters = allSel.map(b=>b.dataset.val);
            const final = activePool.filter(q => sel.term === q.term && sel.subj === q.subject && sel.lessons.includes(q.lesson) && sel.chapters.includes(q.chapter));
            startQuiz(final);
        }
    }

    function toggleSelectAll() {
        const btns = document.querySelectorAll('.select-btn');
        const allSel = Array.from(btns).every(b => b.classList.contains('selected'));
        btns.forEach(b => allSel ? b.classList.remove('selected') : b.classList.add('selected'));
    }

    // --- Quiz Logic ---
    function startQuiz(arr) {
        if(!arr.length) return alert("Ù„Ø§ Ø£Ø³Ø¦Ù„Ø©");
        quizQ = arr.sort(()=>0.5-Math.random());
        qIdx = 0;
        switchView('view-quiz');
        renderQ();
    }

    let answered = false;
    function renderQ() {
        answered = false;
        const q = quizQ[qIdx];
        document.getElementById('q-id').innerText = q.id;
        document.getElementById('q-counter').innerText = `${qIdx+1} / ${quizQ.length}`;
        document.getElementById('q-crumb').innerText = `${q.lesson} > ${q.chapter}`;
        document.getElementById('q-text').innerText = q.question;
        updateFavIcon();

        const opts = document.getElementById('q-options');
        opts.innerHTML = '';
        document.getElementById('q-exp').style.display='none';
        document.getElementById('btn-next').classList.add('hidden');

        const keys = ['A','B','C','D','E'];
        q.options.forEach((opt, i) => {
            const d = document.createElement('div');
            d.className = 'option-row';
            d.innerHTML = `<span>${opt}</span><span class="key-hint">${keys[i]}</span>`;
            d.onclick = () => solve(i);
            opts.appendChild(d);
        });
    }

    function solve(idx) {
        if(answered) return;
        answered = true;
        const q = quizQ[qIdx];
        const divs = document.querySelectorAll('.option-row');
        
        divs[q.correct_option_id].classList.add('correct');
        divs[q.correct_option_id].querySelector('.key-hint').innerText = 'âœ“';

        if(idx !== q.correct_option_id) {
            divs[idx].classList.add('wrong');
            divs[idx].querySelector('.key-hint').innerText = 'âœ—';
            if(!user.mistakes.includes(q.id)) { user.mistakes.push(q.id); localStorage.setItem('mis', JSON.stringify(user.mistakes)); }
        } else {
            user.xp += 10; localStorage.setItem('xp', user.xp);
            user.mistakes = user.mistakes.filter(x=>x!==q.id); localStorage.setItem('mis', JSON.stringify(user.mistakes));
        }

        const exp = document.getElementById('q-exp');
        exp.style.display = 'block';
        exp.innerHTML = `<b>ØªÙˆØ¶ÙŠØ­:</b> ${q.explanation || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±Ø­ Ù…ØªØ§Ø­.'}`;
        document.getElementById('btn-next').classList.remove('hidden');
    }

    function nextQ() {
        if(qIdx < quizQ.length-1) { qIdx++; renderQ(); }
        else { alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!"); goHome(); }
    }

    // --- Features ---
    function luckyShot() {
        if(!allQs.length) return;
        const rand = allQs[Math.floor(Math.random() * allQs.length)];
        quizQ = [rand]; qIdx=0; switchView('view-quiz'); renderQ();
    }

    function toggleMirrorMode() {
        document.getElementById('main-container').classList.toggle('mirror-mode');
    }

    function shareBot() {
        const url = "https://t.me/share/url?url=" + encodeURIComponent("Ø¬Ø±Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø±Ø§Ø¦Ø¹! ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ø´Ø§Ù…Ù„ ÙˆÙ†Ø¸Ø§Ù… Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠ. @Heailloo_bot");
        window.open(url, '_blank');
    }

    function toggleFav() {
        const id = quizQ[qIdx].id;
        if(user.fav.includes(id)) user.fav = user.fav.filter(x=>x!==id);
        else user.fav.push(id);
        localStorage.setItem('fav', JSON.stringify(user.fav));
        updateFavIcon();
    }

    function updateFavIcon() {
        const el = document.getElementById('fav-trigger');
        const isFav = user.fav.includes(quizQ[qIdx].id);
        el.innerText = isFav ? "â˜… Ù…Ø­ÙÙˆØ¸" : "â˜† Ø­ÙØ¸";
        el.style.color = isFav ? "#f1c40f" : "var(--text-sec)";
    }

    // --- Search & Settings ---
    function doSearch() {
        const id = parseInt(document.getElementById('s-inp').value);
        const q = allQs.find(x=>x.id===id);
        if(q) { quizQ=[q]; qIdx=0; switchView('view-quiz'); renderQ(); document.getElementById('modal-search').style.display='none'; }
        else alert("ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    }

    function setAppTheme(t) {
        document.body.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
    }
    
    function setAnim(type) {
        animationType = type;
        localStorage.setItem('anim', type);
        initCanvas(); // restart
    }

    // --- Leaderboard ---
    function openLeaderboard() {
        document.getElementById('modal-lb').style.display = 'flex';
        document.getElementById('my-xp').innerText = user.xp;
        const list = document.getElementById('lb-list');
        list.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        db.ref('scores').orderByChild('xp').limitToLast(10).once('value', snap => {
            let d = []; snap.forEach(c => d.push(c.val()));
            d.reverse();
            list.innerHTML = d.map((p,i) => `<div style="padding:5px; border-bottom:1px solid #eee;"><b>#${i+1} ${p.name}</b>: ${p.xp} XP</div>`).join('');
        });
    }

    function submitScore() {
        const name = document.getElementById('p-name').value;
        if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ");
        db.ref('scores/'+name.replace(/\./g,'_')).set({name, xp: user.xp, time: Date.now()});
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
        openLeaderboard();
    }

    function goHome() { switchView('view-home'); }
    function openSettings() { document.getElementById('modal-settings').style.display='flex'; }

    // --- Shortcuts ---
    document.addEventListener('keydown', e => {
        if(document.getElementById('view-quiz').classList.contains('hidden')) return;
        const k = e.key.toLowerCase();
        const map = {'a':0,'b':1,'c':2,'d':3,'e':4};
        if(map[k]!==undefined) solve(map[k]);
        if(k==='s') toggleFav();
        if((k===' '||k==='enter') && answered) { e.preventDefault(); nextQ(); }
    });

    // --- Canvas Animation System (The "Wow" Factor) ---
    function initCanvas() {
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let w, h, particles = [];
        
        const resize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
        window.onresize = resize; resize();

        class Particle {
            constructor() {
                this.reset();
            }
            reset() {
                this.x = Math.random() * w;
                this.y = Math.random() * h;
                this.size = Math.random() * 5 + 1;
                this.speedX = Math.random() * 1 - 0.5;
                this.speedY = Math.random() * 1 - 0.5;
                this.alpha = Math.random() * 0.5 + 0.1;
            }
            update() {
                this.x += this.speedX; this.y += this.speedY;
                if(animationType === 'bubbles') this.y -= 0.5; // Bubble up
                if(this.x < 0 || this.x > w || this.y < 0 || this.y > h) this.reset();
            }
            draw() {
                ctx.fillStyle = `rgba(100, 100, 255, ${this.alpha})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
                ctx.fill();
            }
        }

        if(animationType === 'none') { ctx.clearRect(0,0,w,h); return; }

        particles = Array(50).fill().map(() => new Particle());

        function animate() {
            if(animationType === 'none') return;
            ctx.clearRect(0, 0, w, h);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
        animate();
    }

</script>
</body>
</html>
