<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedQuiz Ultimate</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <style>
        :root {
            /* --- Default Theme (Light Modern) --- */
            --bg-grad: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(0, 0, 0, 0.05);
            --txt-main: #2d3436;
            --txt-sec: #636e72;
            --primary: #6c5ce7;
            --secondary: #00cec9;
            --accent: #ff7675;
            --success: #00b894;
            
            /* --- Sizing & Shape --- */
            --radius: 8px; /* Slightly squared for compact look */
            --btn-pad: 5px 12px; /* Small & Compact */
            --font-size: 14px;
            --font-fam: 'Segoe UI', Tahoma, sans-serif;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        /* --- Themes --- */
        [data-theme="dark"] {
            --bg-grad: linear-gradient(135deg, #232526 0%, #414345 100%);
            --glass-bg: rgba(40, 40, 40, 0.9);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --txt-main: #dfe6e9; --txt-sec: #b2bec3;
            --primary: #a29bfe; --secondary: #81ecec;
        }
        [data-theme="neon"] {
            --bg-grad: linear-gradient(45deg, #000000, #1a0b2e);
            --glass-bg: rgba(10, 10, 20, 0.9);
            --glass-border: 1px solid #0ff;
            --txt-main: #fff; --txt-sec: #0ff;
            --primary: #f0f; --secondary: #0ff; --accent: #ff0;
            --radius: 0px; /* Sharp edges */
        }
        [data-theme="forest"] {
            --bg-grad: linear-gradient(to bottom, #134e5e, #71b280);
            --glass-bg: rgba(230, 245, 230, 0.9);
            --txt-main: #1b5e20; --txt-sec: #388e3c;
            --primary: #2e7d32; --secondary: #ffa000;
        }
        [data-theme="coffee"] {
            --bg-grad: linear-gradient(to right, #3e2b26, #6d4c41);
            --glass-bg: rgba(255, 248, 240, 0.9);
            --txt-main: #3e2723; --txt-sec: #5d4037;
            --primary: #795548; --secondary: #d7ccc8;
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }

        body {
            margin: 0; padding: 0;
            font-family: var(--font-fam);
            font-size: var(--font-size);
            color: var(--txt-main);
            background: var(--bg-grad);
            height: 100vh; overflow: hidden;
            user-select: none;
        }

        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        .container {
            position: relative; z-index: 1;
            width: 100%; height: 100%; max-width: 850px; margin: 0 auto;
            display: flex; flex-direction: column; padding: 10px;
        }

        /* --- UI Components --- */
        .glass-box {
            background: var(--glass-bg);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: var(--glass-border); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 12px; margin-bottom: 8px;
        }

        .btn {
            border: none; outline: none; cursor: pointer;
            padding: var(--btn-pad); border-radius: var(--radius);
            font-size: 0.9em; font-weight: 600;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn:active { transform: scale(0.95); }

        .btn-primary { background: var(--primary); color: #fff; }
        .btn-sec { background: transparent; border: 1px solid var(--txt-sec); color: var(--txt-sec); }
        .btn-ghost { background: rgba(0,0,0,0.05); color: var(--txt-main); }
        .btn-icon { padding: 6px; border-radius: 50%; aspect-ratio: 1; }

        /* --- Header --- */
        header { display: flex; justify-content: space-between; align-items: center; }
        .logo h1 { margin: 0; font-size: 1.1rem; background: -webkit-linear-gradient(0deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo small { font-size: 0.7em; opacity: 0.7; }

        /* --- Menu Grid --- */
        .grid-menu {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px; padding: 5px; flex-grow: 1; overflow-y: auto;
        }

        .menu-card {
            background: var(--glass-bg); border-radius: var(--radius);
            border: var(--glass-border); box-shadow: var(--shadow);
            padding: 15px; text-align: center; cursor: pointer;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 100px;
        }
        .menu-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .menu-card .icon { font-size: 1.8rem; margin-bottom: 5px; }
        .menu-card h3 { margin: 0; font-size: 0.9rem; color: var(--txt-main); }
        .menu-card small { font-size: 0.7rem; color: var(--txt-sec); margin-top: 2px; }

        /* --- Selection --- */
        .selection-list { flex-grow: 1; overflow-y: auto; padding: 5px; }
        .section-header {
            font-size: 0.8em; font-weight: bold; color: var(--primary);
            margin: 10px 0 5px; padding: 4px 8px; background: rgba(0,0,0,0.03); border-radius: 4px;
        }
        .select-grid { display: flex; flex-wrap: wrap; gap: 6px; }
        
        .chip {
            background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.1);
            color: var(--txt-main); padding: 5px 10px; border-radius: 20px;
            cursor: pointer; font-size: 0.85em; user-select: none; flex: 1 1 auto;
            text-align: center; max-width: 100%; transition: 0.2s;
        }
        .chip:hover { border-color: var(--secondary); }
        .chip.selected { background: var(--primary); color: #fff; border-color: var(--primary); }

        /* --- Quiz View --- */
        .quiz-view { display: none; flex-direction: column; height: 100%; }
        
        #timer-bar { 
            height: 4px; background: var(--accent); width: 100%; 
            margin-bottom: 8px; border-radius: 2px; display: none; 
            transition: width 1s linear; 
        }

        .q-text { font-size: 1.1em; line-height: 1.5; direction: ltr; text-align: left; }
        
        .option {
            background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.1);
            padding: 10px; margin-bottom: 6px; border-radius: var(--radius);
            cursor: pointer; direction: ltr; text-align: left; font-size: 0.95em;
            display: flex; justify-content: space-between; align-items: center;
        }
        .option:hover { background: rgba(255,255,255,0.8); border-color: var(--primary); }
        .option.correct { background: rgba(46, 204, 113, 0.25); border-color: #2ecc71; }
        .option.wrong { background: rgba(231, 76, 60, 0.25); border-color: #e74c3c; }
        
        .key-hint { 
            font-size: 0.7em; color: var(--txt-sec); border: 1px solid rgba(0,0,0,0.1);
            padding: 1px 5px; border-radius: 4px; min-width: 20px; text-align: center;
        }

        /* --- Modals --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 999;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--glass-bg); padding: 20px; border-radius: var(--radius);
            width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .hidden { display: none !important; }

    </style>
</head>
<body data-theme="light">
<canvas id="bg-canvas"></canvas>

<div class="container">
    
    <!-- HEADER -->
    <header class="glass-box">
        <div class="logo">
            <h1>MedQuiz Ultimate</h1>
            <small id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</small>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="btn btn-icon btn-ghost" onclick="chaosMode()" title="ØªÙˆÙ„ÙŠØ¯ Ø«ÙŠÙ… Ø¹Ø´ÙˆØ§Ø¦ÙŠ (Chaos)">ğŸ²</button>
            <button class="btn btn-icon btn-ghost" onclick="shareBot()" title="Ù…Ø´Ø§Ø±ÙƒØ©">ğŸ“¤</button>
            <button class="btn btn-icon btn-ghost" onclick="openSettings()" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™ï¸</button>
        </div>
    </header>

    <div style="flex-grow:1; display:flex; flex-direction:column; overflow:hidden;">
        
        <!-- === HOME MENU === -->
        <div id="view-home" class="grid-menu">
            <div class="menu-card" onclick="startFlow('normal')">
                <div class="icon">ğŸš€</div>
                <h3>Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø§Ø¯ÙŠ</h3>
            </div>
            
            <div class="menu-card" style="border-color:var(--accent)" onclick="startFlow('survival')">
                <div class="icon">ğŸ”¥</div>
                <h3>ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ù‚Ø§Ø¡</h3>
                <small>Ø®Ø·Ø£ ÙˆØ§Ø­Ø¯ = Ø®Ø³Ø§Ø±Ø©</small>
            </div>
            
            <div class="menu-card" style="border-color:var(--secondary)" onclick="startFlow('timeAttack')">
                <div class="icon">âš¡</div>
                <h3>Ù‡Ø¬ÙˆÙ… Ø§Ù„ÙˆÙ‚Øª</h3>
                <small>60 Ø«Ø§Ù†ÙŠØ©</small>
            </div>

            <div class="menu-card" style="border-color:#f1c40f" onclick="luckyShot()">
                <div class="icon">ğŸ</div>
                <h3>Ø¶Ø±Ø¨Ø© Ø­Ø¸</h3>
                <small>Ø³Ø¤Ø§Ù„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙÙˆØ±Ø§Ù‹</small>
            </div>

            <div class="menu-card" onclick="startFlow('mistakes')">
                <div class="icon">âš ï¸</div>
                <h3>Ø£Ø®Ø·Ø§Ø¦ÙŠ</h3>
                <small>Ø±Ø§Ø¬Ø¹ Ù†Ù‚Ø§Ø· Ø¶Ø¹ÙÙƒ</small>
            </div>

            <div class="menu-card" onclick="startFavMode()">
                <div class="icon">â­</div>
                <h3>Ø§Ù„Ù…ÙØ¶Ù„Ø©</h3>
            </div>

            <div class="menu-card" onclick="document.getElementById('modal-search').style.display='flex'">
                <div class="icon">ğŸ”</div>
                <h3>Ø¨Ø­Ø« ID</h3>
            </div>
        </div>

        <!-- === SELECTION PANEL === -->
        <div id="view-select" class="glass-box hidden" style="height:100%; display:none; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:5px;">
                <h3 id="sel-title" style="margin:0; font-size:1em; color:var(--primary);">Ø§Ø®ØªØ±...</h3>
                <button class="btn btn-sec" style="font-size:0.75em;" onclick="goHome()">Ø¹ÙˆØ¯Ø© ğŸ </button>
            </div>
            
            <div id="sel-content" class="selection-list"></div>
            
            <div style="margin-top:auto; padding-top:8px; display:flex; justify-content:space-between; border-top:1px solid rgba(0,0,0,0.05);">
                <button id="btn-all" class="btn btn-ghost hidden" onclick="toggleAll()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
                <button class="btn btn-primary" onclick="nextStep()">Ø§Ù„ØªØ§Ù„ÙŠ â¡</button>
            </div>
        </div>

        <!-- === QUIZ VIEW === -->
        <div id="view-quiz" class="quiz-view">
            <div id="timer-bar"></div>
            
            <div style="display:flex; justify-content:space-between; font-size:0.75em; color:var(--txt-sec); margin-bottom:5px; padding:0 5px;">
                <span>ID: <b id="q-id">---</b> | <span id="q-counter">1/10</span></span>
                <span id="fav-btn" style="cursor:pointer; font-size:1.2em;" onclick="toggleFav()">â˜†</span>
            </div>

            <div class="glass-box">
                <div id="q-crumb" style="font-size:0.75em; color:var(--primary); margin-bottom:5px;">Path > Path</div>
                <div id="q-txt" class="q-text">Loading...</div>
            </div>

            <div id="q-opts" style="overflow-y:auto; flex-grow:1; padding-right:2px;"></div>

            <div id="q-exp" class="glass-box" style="display:none; margin-top:5px; background:rgba(255,255,255,0.9); color:#000; direction:ltr; font-size:0.9em;"></div>

            <div style="margin-top:8px; display:flex; justify-content:space-between;">
                <button class="btn btn-sec" onclick="goHome()">Ø®Ø±ÙˆØ¬</button>
                <button id="btn-next" class="btn btn-primary hidden" onclick="nextQ()">Ø§Ù„ØªØ§Ù„ÙŠ (Space)</button>
            </div>
        </div>

    </div>
</div>

<!-- === MODALS === -->
<!-- Settings -->
<div id="modal-settings" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content">
        <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <p style="font-size:0.9em; margin-bottom:5px;">Ø§Ø®ØªØ± Ø§Ù„Ø«ÙŠÙ…:</p>
        <div class="select-grid" style="justify-content:center; margin-bottom:15px;">
            <button class="chip" onclick="setTheme('light')">Light</button>
            <button class="chip" onclick="setTheme('dark')">Dark</button>
            <button class="chip" onclick="setTheme('neon')">Neon</button>
            <button class="chip" onclick="setTheme('forest')">Forest</button>
            <button class="chip" onclick="setTheme('coffee')">Coffee</button>
        </div>
        
        <p style="font-size:0.9em; margin-bottom:5px;">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</p>
        <input type="range" min="12" max="22" value="14" style="width:100%" oninput="document.documentElement.style.setProperty('--font-size', this.value+'px')">
        
        <br><br>
        <button class="btn btn-primary" style="width:100%" onclick="document.getElementById('modal-settings').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<!-- Search -->
<div id="modal-search" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content">
        <h3>ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</h3>
        <input type="number" id="search-inp" style="width:100%; padding:10px; margin:15px 0; border:1px solid #ccc; border-radius:5px;" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„ (ID)">
        <button class="btn btn-primary" onclick="doSearch()">Ø¨Ø­Ø«</button>
    </div>
</div>

<script>
    // --- Config & Firebase ---
    const CONFIG = {
        firebase: { apiKey: "AIzaSyDEZFJmcXK2LxYAZ-Yjv_M1HbC6zi_qilg", authDomain: "exambotdb.firebaseapp.com", databaseURL: "https://exambotdb-default-rtdb.firebaseio.com", projectId: "exambotdb", storageBucket: "exambotdb.firebasestorage.app", messagingSenderId: "950600562980", appId: "1:950600562980:web:f993c22d45e5cfdd3d9bb1" }
    };
    firebase.initializeApp(CONFIG.firebase);

    // --- State ---
    let allQs=[], activePool=[], quiz=[], qIdx=0, flowMode='normal';
    let user = { 
        mistakes: JSON.parse(localStorage.getItem('mistakes')||'[]'), 
        fav: JSON.parse(localStorage.getItem('fav')||'[]') 
    };
    let sel = { term:null, subj:null, lessons:[], chapters:[] };
    let currStep = '', timerInt;

    // --- Init ---
    window.onload = async () => {
        initCanvas();
        try {
            // Load List
            const list = await (await fetch('questions_list.json')).json();
            for(let f of list) {
                try {
                    // Load Files
                    let d = await (await fetch(`Questions/${f}`)).json();
                    allQs.push(...d.questions.map(q => ({
                        ...q, 
                        term: q.term || d.meta.source, 
                        subject: q.subject || d.meta.subject, 
                        lesson: q.lesson || d.meta.lesson, 
                        chapter: q.chapter || "General"
                    })));
                } catch(e){ console.warn("Failed to load", f); }
            }
            document.getElementById('status').innerText = `${allQs.length} Ø³Ø¤Ø§Ù„ Ù…ØªØ§Ø­`;
        } catch(e) { document.getElementById('status').innerText = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª"; }
    };

    // --- Flow Logic ---
    function startFlow(mode) {
        flowMode = mode;
        activePool = (mode === 'mistakes') ? allQs.filter(q => user.mistakes.includes(q.id)) : allQs;
        
        if(!activePool.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹.');
        
        sel = { term:null, subj:null, lessons:[], chapters:[] };
        renderStep('term');
    }

    function renderStep(step) {
        currStep = step;
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-select').style.display = 'flex';
        document.getElementById('view-select').classList.remove('hidden');

        const cont = document.getElementById('sel-content'); cont.innerHTML='';
        const title = document.getElementById('sel-title');
        const btnAll = document.getElementById('btn-all'); btnAll.classList.add('hidden');

        // Filter Data
        const subset = activePool.filter(q => 
            (!sel.term || q.term === sel.term) && 
            (!sel.subj || q.subject === sel.subj)
        );

        let items=[], isMulti=false;

        if(step === 'term') { title.innerText='1. Ø§Ø®ØªØ± Ø§Ù„ØªØ±Ù…'; items=[...new Set(subset.map(q=>q.term))]; }
        else if(step === 'subj') { title.innerText='2. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©'; items=[...new Set(subset.map(q=>q.subject))]; }
        else if(step === 'lesson') { title.innerText='3. Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³'; items=[...new Set(subset.map(q=>q.lesson))]; isMulti=true; }
        else if(step === 'chapter') {
            title.innerText='4. Ø§Ø®ØªØ± Ø§Ù„Ø´Ø§Ø¨ØªØ±'; isMulti=true;
            // Grouped Rendering
            sel.lessons.forEach(l => {
                const head = document.createElement('div'); head.className='section-header'; head.innerText = `ğŸ“‚ ${l}`;
                cont.appendChild(head);
                const grid = document.createElement('div'); grid.className='select-grid';
                const chaps = [...new Set(subset.filter(q=>q.lesson===l).map(q=>q.chapter))];
                chaps.forEach(ch => grid.appendChild(createChip(ch, true)));
                cont.appendChild(grid);
            });
            btnAll.classList.remove('hidden');
            return;
        }

        const grid = document.createElement('div'); grid.className='select-grid';
        items.sort().forEach(i => grid.appendChild(createChip(i, isMulti)));
        cont.appendChild(grid);
        if(isMulti) btnAll.classList.remove('hidden');
    }

    function createChip(val, isMulti) {
        const c = document.createElement('div'); c.className='chip'; c.innerText=val; c.dataset.val=val;
        c.onclick = () => {
            if(isMulti) c.classList.toggle('selected');
            else {
                if(currStep==='term') { sel.term=val; renderStep('subj'); }
                else if(currStep==='subj') { sel.subj=val; renderStep('lesson'); }
            }
        };
        return c;
    }

    function nextStep() {
        const selChips = Array.from(document.querySelectorAll('.chip.selected'));
        if(currStep === 'lesson') {
            if(!selChips.length) return alert('Ø§Ø®ØªØ± Ø¯Ø±Ø³Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
            sel.lessons = selChips.map(c=>c.dataset.val);
            renderStep('chapter');
        } else if(currStep === 'chapter') {
            if(!selChips.length) return alert('Ø§Ø®ØªØ± Ø´Ø§Ø¨ØªØ± ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
            sel.chapters = selChips.map(c=>c.dataset.val);
            const final = activePool.filter(q => sel.term===q.term && sel.subj===q.subject && sel.lessons.includes(q.lesson) && sel.chapters.includes(q.chapter));
            startQuiz(final);
        }
    }

    function toggleAll() {
        const chips = document.querySelectorAll('.chip');
        const all = Array.from(chips).every(c=>c.classList.contains('selected'));
        chips.forEach(c => all ? c.classList.remove('selected') : c.classList.add('selected'));
    }

    // --- Quiz Engine ---
    function startQuiz(arr) {
        if(!arr.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ØªØ·Ø§Ø¨Ù‚ Ø§Ø®ØªÙŠØ§Ø±Ùƒ.');
        quiz = arr.sort(()=>0.5-Math.random());
        qIdx = 0;

        document.getElementById('view-select').classList.add('hidden');
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-quiz').style.display = 'flex';

        if(flowMode === 'timeAttack') startTimer();
        else document.getElementById('timer-bar').style.display='none';

        renderQ();
    }

    function luckyShot() {
        if(!allQs.length) return;
        flowMode = 'normal';
        const randQ = allQs[Math.floor(Math.random()*allQs.length)];
        quiz = [randQ]; qIdx=0;
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-quiz').style.display = 'flex';
        document.getElementById('timer-bar').style.display='none';
        renderQ();
    }

    function startFavMode() {
        const pool = allQs.filter(q => user.fav.includes(q.id));
        if(!pool.length) return alert('Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙØ§Ø±ØºØ©.');
        flowMode = 'normal'; startQuiz(pool);
    }

    let timeRem = 60;
    function startTimer() {
        timeRem = 60;
        const bar = document.getElementById('timer-bar');
        bar.style.display='block'; bar.style.width='100%';
        clearInterval(timerInt);
        timerInt = setInterval(() => {
            timeRem--;
            bar.style.width = (timeRem/60*100) + '%';
            if(timeRem<=0) { clearInterval(timerInt); alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!"); goHome(); }
        }, 1000);
    }

    let answered = false;
    function renderQ() {
        answered = false;
        const q = quiz[qIdx];
        document.getElementById('q-id').innerText = q.id;
        document.getElementById('q-counter').innerText = `${qIdx+1}/${quiz.length}`;
        document.getElementById('q-crumb').innerText = `${q.lesson} > ${q.chapter}`;
        document.getElementById('q-txt').innerText = q.question;
        updateFavIcon();

        const opts = document.getElementById('q-opts'); opts.innerHTML='';
        document.getElementById('q-exp').style.display='none';
        document.getElementById('btn-next').classList.add('hidden');

        const keys = ['A','B','C','D','E'];
        q.options.forEach((o, i) => {
            const d = document.createElement('div'); d.className='option';
            d.innerHTML = `<span>${o}</span><span class="key-hint">${keys[i]}</span>`;
            d.onclick = () => check(i);
            opts.appendChild(d);
        });
    }

    function check(idx) {
        if(answered) return;
        answered = true;
        const q = quiz[qIdx];
        const divs = document.querySelectorAll('.option');
        
        divs[q.correct_option_id].classList.add('correct');
        divs[q.correct_option_id].querySelector('.key-hint').innerText = 'âœ“';

        if(idx !== q.correct_option_id) {
            divs[idx].classList.add('wrong');
            divs[idx].querySelector('.key-hint').innerText = 'âœ—';
            
            if(!user.mistakes.includes(q.id)) { user.mistakes.push(q.id); localStorage.setItem('mistakes', JSON.stringify(user.mistakes)); }

            if(flowMode === 'survival') {
                clearInterval(timerInt);
                setTimeout(() => { alert("ğŸ’¥ Ø®Ø³Ø±Øª! ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ù„Ø§ ÙŠØ±Ø­Ù…."); goHome(); }, 500);
                return;
            }
        } else {
            user.mistakes = user.mistakes.filter(x=>x!==q.id); 
            localStorage.setItem('mistakes', JSON.stringify(user.mistakes));
        }

        const exp = document.getElementById('q-exp');
        exp.style.display='block';
        exp.innerHTML = `<b>Explanation:</b> ${q.explanation || 'No explanation.'}`;
        document.getElementById('btn-next').classList.remove('hidden');
    }

    function nextQ() {
        if(qIdx < quiz.length-1) { qIdx++; renderQ(); }
        else { alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!"); goHome(); }
    }

    // --- Features ---
    function chaosMode() {
        const rc = () => `hsl(${Math.random()*360}, ${40+Math.random()*60}%, ${20+Math.random()*60}%)`;
        const root = document.documentElement;
        
        root.style.setProperty('--bg-grad', `linear-gradient(${Math.random()*360}deg, ${rc()}, ${rc()})`);
        root.style.setProperty('--glass-bg', `rgba(${Math.random()*255},${Math.random()*255},${Math.random()*255}, 0.8)`);
        root.style.setProperty('--primary', rc());
        root.style.setProperty('--secondary', rc());
        root.style.setProperty('--radius', `${Math.random()*25}px`);
        root.style.setProperty('--btn-pad', `${5+Math.random()*10}px ${10+Math.random()*10}px`);
        
        // Random Fonts
        const f = ['cursive', 'monospace', 'serif', 'sans-serif', 'fantasy'];
        root.style.setProperty('--font-fam', f[Math.floor(Math.random()*f.length)]);
    }

    function toggleFav() {
        const id = quiz[qIdx].id;
        if(user.fav.includes(id)) user.fav = user.fav.filter(x=>x!==id);
        else user.fav.push(id);
        localStorage.setItem('fav', JSON.stringify(user.fav));
        updateFavIcon();
    }
    function updateFavIcon() {
        const el = document.getElementById('fav-btn');
        el.innerText = user.fav.includes(quiz[qIdx].id) ? "â˜…" : "â˜†";
        el.style.color = user.fav.includes(quiz[qIdx].id) ? "orange" : "var(--txt-sec)";
    }

    function doSearch() {
        const id = parseInt(document.getElementById('search-inp').value);
        const q = allQs.find(x=>x.id===id);
        if(q) {
            quiz=[q]; qIdx=0; flowMode='normal';
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-quiz').style.display='flex';
            document.getElementById('modal-search').style.display='none';
            document.getElementById('timer-bar').style.display='none';
            renderQ();
        } else alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    }

    function goHome() {
        clearInterval(timerInt);
        document.getElementById('view-quiz').style.display='none';
        document.getElementById('view-select').classList.add('hidden');
        document.getElementById('view-home').classList.remove('hidden');
    }

    function setTheme(t) { document.body.setAttribute('data-theme', t); }
    function openSettings() { document.getElementById('modal-settings').style.display='flex'; }
    function shareBot() { window.open('https://t.me/share/url?url='+encodeURIComponent('Ø¬Ø±Ø¨ @Heailloo_bot'), '_blank'); }

    // --- Shortcuts ---
    document.addEventListener('keydown', e => {
        if(document.getElementById('view-quiz').style.display === 'none') return;
        const k = e.key.toLowerCase();
        const map = {'a':0,'b':1,'c':2,'d':3,'e':4};
        if(map[k]!==undefined) check(map[k]);
        if(k==='s') toggleFav();
        if((k===' '||k==='enter') && answered) { e.preventDefault(); nextQ(); }
    });

    // --- Background Animation ---
    function initCanvas() {
        const c = document.getElementById('bg-canvas'), x = c.getContext('2d');
        let w, h, p=[];
        const r = () => { w=c.width=window.innerWidth; h=c.height=window.innerHeight; };
        window.onresize=r; r();
        
        class P {
            constructor(){this.init();}
            init(){this.x=Math.random()*w; this.y=Math.random()*h; this.r=Math.random()*4; this.vx=(Math.random()-.5); this.vy=(Math.random()-.5);}
            up(){this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>w||this.y<0||this.y>h)this.init();}
            dr(){x.beginPath(); x.arc(this.x,this.y,this.r,0,7); x.fillStyle='rgba(100,100,200,0.2)'; x.fill();}
        }
        p = Array(60).fill().map(()=>new P());
        function anim(){ x.clearRect(0,0,w,h); p.forEach(i=>{i.up();i.dr()}); requestAnimationFrame(anim); }
        anim();
    }
</script>
</body>
</html>
