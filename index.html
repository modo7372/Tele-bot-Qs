<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Bot Elite Pro</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f4f6f8; --card: #ffffff; --text: #1f2937; --hint: #6b7280;
            --primary: #3b82f6; --primary-dark: #2563eb; --accent: #10b981; 
            --danger: #ef4444; --warning: #f59e0b;
            --radius: 16px; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        body.dark-mode {
            --bg: #111827; --card: #1f2937; --text: #f3f4f6; --hint: #9ca3af;
            --primary: #60a5fa; --primary-dark: #3b82f6;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.5);
        }

        body { font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; user-select: none; -webkit-tap-highlight-color: transparent; transition: background 0.3s ease; }
        
        /* HEADER */
        header { background: var(--card); padding: 16px; position: sticky; top:0; z-index:50; display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .score-badge { background:rgba(0,0,0,0.05); padding:6px 14px; border-radius:30px; font-weight:700; font-size:0.9em; color:var(--primary); display: flex; align-items: center; gap: 5px; }

        /* VIEWS TRANSITIONS */
        .view { display: none; padding: 20px; max-width:640px; margin:0 auto; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .view.active { display: block; }
        @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

        /* HOME CARDS */
        .card-btn {
            background: var(--card); border-radius: var(--radius); padding: 24px; margin-bottom: 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow); cursor: pointer; border: 1px solid transparent; transition: all 0.2s;
        }
        .card-btn:active { transform: scale(0.97); }
        .card-icon { font-size: 2rem; background: rgba(59, 130, 246, 0.1); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }

        /* LIST ITEMS (Browser) */
        .list-row {
            background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 12px;
            border: 1px solid rgba(0,0,0,0.05); transition: 0.2s; cursor: pointer;
        }
        .list-row.active-row { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        .chk-wrap { display: flex; align-items: center; width: 100%; gap: 12px; }
        .chk-input { width: 22px; height: 22px; accent-color: var(--primary); cursor: pointer; }
        
        /* CONTROLS */
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-text { background: none; border: none; color: var(--primary); font-weight: 600; cursor: pointer; font-size: 0.95em; }
        
        /* CHIPS */
        .chips-grid { display: flex; gap: 10px; flex-wrap: wrap; margin: 15px 0 25px 0; }
        .chip {
            background: var(--card); border: 1px solid rgba(128,128,128,0.2); padding: 10px 20px;
            border-radius: 30px; cursor: pointer; font-size: 0.95em; font-weight: 500; transition: 0.2s; flex: 1; text-align: center; white-space: nowrap;
        }
        .chip.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }

        /* MAIN BUTTON */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; border: none; padding: 18px; width: 100%;
            border-radius: var(--radius); font-size: 1.1em; font-weight: bold; cursor: pointer;
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3); transition: transform 0.2s;
        }
        .btn-primary:active { transform: translateY(2px); }

        /* QUIZ UI */
        .q-header { display:flex; justify-content:space-between; margin-bottom:20px; color:var(--hint); font-size:0.9em; font-weight:500; }
        .q-id { background:rgba(0,0,0,0.08); padding:4px 8px; border-radius:6px; font-family:monospace; }
        .q-body { font-size: 1.25em; font-weight: 600; line-height: 1.6; margin-bottom: 30px; }
        .opt {
            background: var(--card); padding: 18px; border-radius: 12px; width: 100%; text-align: right;
            border: 2px solid transparent; margin-bottom: 12px; color: var(--text); font-size: 1rem;
            box-shadow: var(--shadow); cursor: pointer; transition: 0.1s;
        }
        .opt.correct { background: #ecfdf5; border-color: var(--accent); color: #065f46; }
        .opt.wrong { background: #fef2f2; border-color: var(--danger); color: #991b1b; }
        
        /* LEADERBOARD */
        .leader-box { background: var(--card); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
        .leader-row { display: flex; justify-content: space-between; padding: 16px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .leader-row:last-child { border-bottom: none; }
        .medal { display: inline-flex; width: 30px; justify-content: center; font-weight: bold; }

        /* FAB & BOTTOM NAV */
        .fab {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: white; padding: 14px 28px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); font-weight: bold; cursor: pointer; z-index: 100;
            display: none; animation: popIn 0.3s;
        }
        @keyframes popIn { from{transform:translate(-50%, 20px);opacity:0} to{transform:translate(-50%,0);opacity:1} }

        .btm-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--card);
            border-top: 1px solid rgba(0,0,0,0.05); display: flex; z-index: 50; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--hint); background:none; border:none; gap: 4px; }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 1.5rem; }

        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <!-- 1. LOADING SCREEN -->
    <div id="loader">
        <div class="spinner" style="font-size:3rem;margin-bottom:1rem">â³</div>
        <h3 id="loaderTxt">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</h3>
        <small style="color:var(--hint)">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</small>
    </div>

    <!-- 2. MAIN HEADER -->
    <header>
        <div>
            <div style="font-weight:800; font-size:1.1rem">ExaM Bot Elite</div>
            <div style="font-size:0.75rem; color:var(--hint)">Online System V3.0</div>
        </div>
        <div class="score-badge">
            ğŸ† <span id="uScore">--</span>
        </div>
    </header>

    <!-- VIEW A: HOME DASHBOARD -->
    <div id="v-home" class="view active">
        <div style="margin-bottom:20px; font-weight:bold; color:var(--hint)">ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„!</div>

        <div class="card-btn" onclick="browseContent()">
            <div>
                <div style="font-weight:700; font-size:1.1rem">ØªØµÙØ­ Ø§Ù„Ù…Ù†Ù‡Ø¬</div>
                <div style="color:var(--hint); font-size:0.9rem; margin-top:4px">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙˆÙ„ ÙˆØ­Ù„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø¬Ù…Ø¹Ø©</div>
            </div>
            <div class="card-icon">ğŸ“š</div>
        </div>

        <div class="card-btn" onclick="openMistakesMode()">
            <div>
                <div style="font-weight:700; font-size:1.1rem; color:var(--danger)">Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div>
                <div style="color:var(--hint); font-size:0.9rem; margin-top:4px">Ø£Ø¹Ø¯ Ø­Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ Ø£Ø®Ø·Ø£Øª ÙÙŠÙ‡Ø§</div>
            </div>
            <div class="card-icon" style="background: rgba(239, 68, 68, 0.1)">ğŸš¨</div>
        </div>

        <div style="margin-top:30px; text-align:center">
             <button class="btn-text" onclick="location.reload()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
    </div>

    <!-- VIEW B: BROWSER (The Selector) -->
    <div id="v-browser" class="view">
        <div class="action-bar">
            <button class="btn-text" onclick="goHome()">âœ– Ø¥ØºÙ„Ø§Ù‚</button>
            <h3 style="margin:0" id="browserTitle">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3>
        </div>
        
        <!-- Controls -->
        <div style="background:var(--card); padding:12px; border-radius:12px; margin-bottom:15px; display:flex; align-items:center; gap:10px; border:1px solid rgba(0,0,0,0.05)">
            <input type="checkbox" id="chkAll" class="chk-input" onchange="toggleAll(this)">
            <label for="chkAll" style="font-weight:600; cursor:pointer">ØªØ­Ø¯ÙŠØ¯ / Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</label>
        </div>

        <div id="browserList"></div>
        <div style="height:60px"></div>
    </div>

    <!-- VIEW C: SETUP (Config) -->
    <div id="v-setup" class="view">
        <button class="btn-text" onclick="backToBrowser()">â¬…ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
        
        <div style="text-align:center; margin: 20px 0;">
            <div style="font-size:3rem">âš™ï¸</div>
            <h2>ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
            <p style="color:var(--hint)" id="setupSubtitle">...</p>
        </div>

        <label style="font-weight:600">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
        <div class="chips-grid" id="modeChips">
            <div class="chip active" onclick="setMode('new', this)">ğŸŒŸ Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·</div>
            <div class="chip" onclick="setMode('mistake', this)">ğŸ– Ø£Ø®Ø·Ø§Ø¦ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
            <div class="chip" onclick="setMode('mixed', this)">ğŸ”€ ØªØ´ÙƒÙŠÙ„Ø©</div>
        </div>

        <label style="font-weight:600">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
        <div class="chips-grid" id="qtyChips">
            <div class="chip active" onclick="setQty(5, this)">5</div>
            <div class="chip" onclick="setQty(10, this)">10</div>
            <div class="chip" onclick="setQty(25, this)">25</div>
            <div class="chip" onclick="setQty(999, this)">Ø§Ù„ÙƒÙ„</div>
        </div>
        
        <div id="filterError" style="background:#fef2f2; color:#b91c1c; padding:15px; border-radius:12px; margin-bottom:15px; display:none; text-align:center">
            âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ØªØ·Ø§Ø¨Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙˆØ· ÙÙŠ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.
        </div>

        <button class="btn-primary" onclick="startFinalQuiz()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ ğŸ”¥</button>
    </div>

    <!-- VIEW D: ACTIVE QUIZ -->
    <div id="v-quiz" class="view">
        <div class="q-header">
            <span id="qCount">Q: 1/10</span>
            <span class="q-id" id="qID">#1234</span>
            <span style="color:var(--danger); cursor:pointer" onclick="confirmExit()">Ø¥Ù†Ù‡Ø§Ø¡ âœ–</span>
        </div>
        
        <div id="quizContent"></div>
    </div>

    <!-- VIEW E: LEADERBOARD -->
    <div id="v-leader" class="view">
        <h2 style="text-align:center; margin-bottom:20px"> Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ğŸ‘‘</h2>
        <div class="leader-box" id="leaderList">
            <div style="padding:20px; text-align:center; color:var(--hint)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
        <div style="text-align:center; margin-top:15px; font-size:0.85em; color:var(--hint)">
            Ø§Ù„ØªØ±ØªÙŠØ¨ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø§Ù„ÙƒÙ„ÙŠ
        </div>
    </div>

    <!-- FAB: Confirmation Button -->
    <div id="fabBtn" class="fab" onclick="goToSetup()">
        âœ… ØªØ£ÙƒÙŠØ¯ (<span id="selCount">0</span>)
    </div>

    <!-- BOTTOM NAV -->
    <div class="btm-nav">
        <button class="nav-btn active" onclick="goHome()">
            <div class="nav-icon">ğŸ </div> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>
        <button class="nav-btn" onclick="loadLeaderboard()">
            <div class="nav-icon">ğŸ“Š</div> Ø§Ù„Ø£ÙˆØ§Ø¦Ù„
        </button>
    </div>

<script>
    /** ============================
     *  CONFIG & INIT
     *  ============================ */
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyDEZFJmcXK2LxYAZ-Yjv_M1HbC6zi_qilg",
        authDomain: "exambotdb.firebaseapp.com",
        databaseURL: "https://exambotdb-default-rtdb.firebaseio.com",
        projectId: "exambotdb",
        storageBucket: "exambotdb.firebasestorage.app",
        messagingSenderId: "950600562980",
        appId: "1:950600562980:web:f993c22d45e5cfdd3d9bb1"
    };

    const TG = window.Telegram.WebApp;
    let DB = null, UserID = "guest";
    
    // THE GLOBAL STATE
    const AppState = {
        allData: [],         // Array of ALL Question objects
        folders: {},         // { FolderName: { LessonName: [Qs] } }
        progress: {},        // { QID: 'correct'|'wrong' }
        
        // Navigation Pointers
        currentFolder: null, // Used if we dive deeper (future proofing)
        
        // SELECTION STATE (Crucial for Checkbox Sync)
        selectedKeys: [],    // Array of 'LessonName' strings currently selected
        
        // Quiz Context
        quizQueue: [],
        currentIdx: 0,
        tempModeQueue: null, // Short cut queue for mistakes
        config: { mode: 'new', qty: 5 }
    };

    function init() {
        TG.ready(); TG.expand();
        if(TG.initDataUnsafe?.user?.id) UserID = TG.initDataUnsafe.user.id.toString();
        if(TG.colorScheme === 'dark') document.body.classList.add('dark-mode');

        if(window.firebase && !firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
            DB = firebase.database();
        }

        loadData();
    }

    async function loadData() {
        if(!navigator.onLine) {
             document.getElementById('loaderTxt').innerText = "Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ù†ØªØ±Ù†Øª!";
             return;
        }

        try {
            const listRes = await fetch('questions_list.json?t=' + Date.now());
            const fileList = await listRes.json();
            
            const fetches = fileList.map(f => fetch('Questions/'+f).then(r=>r.json()));
            const responses = await Promise.all(fetches);

            let flatList = [];
            let struct = {};

            responses.forEach(data => {
                // Determine Folder & Lesson
                const meta = data.meta || {};
                // If Term/Source exists use it as top folder, else General
                const folderName = meta.source || meta.term || "Ø§Ù„Ù…Ù†Ù‡Ø¬"; 
                // Lesson name inside the file
                const lessonName = meta.lesson || "Ø¯Ø±ÙˆØ³ Ø¹Ø§Ù…Ø©";

                if(!struct[folderName]) struct[folderName] = {};
                if(!struct[folderName][lessonName]) struct[folderName][lessonName] = [];

                data.questions.forEach(q => {
                    const enhancedQ = { 
                        ...q, 
                        _meta: { folder: folderName, lesson: lessonName } 
                    };
                    flatList.push(enhancedQ);
                    struct[folderName][lessonName].push(enhancedQ);
                });
            });

            AppState.allData = flatList;
            AppState.folders = struct;

            // Load User Progress
            if(DB && UserID !== 'guest') {
                const snap = await DB.ref(`users/${UserID}/progress`).once('value');
                AppState.progress = snap.val() || {};
            }

            updateScoreUI();
            document.getElementById('loader').style.display = 'none';

        } catch (e) {
            console.error(e);
            document.getElementById('loaderTxt').innerHTML = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª.<br><button onclick='location.reload()'>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>";
        }
    }

    /** ============================
     *  NAVIGATION & SELECTION (FIXED)
     *  ============================ */
    
    function switchView(id) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        // Hide FAB everywhere except browser, unless specific logic calls it
        document.getElementById('fabBtn').style.display = 'none';
    }

    function goHome() { 
        switchView('v-home'); 
        AppState.navStack = []; 
    }

    function browseContent() {
        AppState.selectedKeys = []; // Reset on new session
        renderBrowser();
    }

    function renderBrowser() {
        switchView('v-browser');
        const listEl = document.getElementById('browserList');
        listEl.innerHTML = '';
        
        // FLATTEN hierarchy for display in a simple 2-level or 1-level list?
        // Let's list ALL Lessons Grouped by Folder visually
        
        let allLessons = [];
        // Flatten logic
        Object.keys(AppState.folders).forEach(fKey => {
            const lessons = AppState.folders[fKey];
            Object.keys(lessons).forEach(lKey => {
                allLessons.push({ folder: fKey, name: lKey, count: lessons[lKey].length });
            });
        });

        if(allLessons.length === 0) { listEl.innerHTML = "<p>ÙØ§Ø±Øº</p>"; return; }

        allLessons.forEach(l => {
            const row = document.createElement('label');
            // Check State Sync
            const isChecked = AppState.selectedKeys.includes(l.name);
            
            row.className = `list-row ${isChecked ? 'active-row' : ''}`;
            row.innerHTML = `
                <div class="chk-wrap">
                    <input type="checkbox" class="chk-input" value="${l.name}" 
                        ${isChecked ? 'checked' : ''} 
                        onchange="handleToggle('${l.name}', this)">
                    <div>
                        <div style="font-weight:600">${l.name}</div>
                        <div style="font-size:0.85rem; color:var(--hint)">${l.folder} â€¢ ${l.count} Ø³Ø¤Ø§Ù„</div>
                    </div>
                </div>
            `;
            listEl.appendChild(row);
        });

        syncSelectAllState(allLessons.map(l=>l.name));
        updateFab();
    }

    // -- SELECTION LOGIC --
    window.handleToggle = function(name, el) {
        if(el.checked) {
            if(!AppState.selectedKeys.includes(name)) AppState.selectedKeys.push(name);
            el.closest('.list-row').classList.add('active-row');
        } else {
            AppState.selectedKeys = AppState.selectedKeys.filter(x => x !== name);
            el.closest('.list-row').classList.remove('active-row');
        }
        
        // Check "Select All" logic
        const allVisible = Array.from(document.querySelectorAll('#browserList .chk-input')).map(i=>i.value);
        syncSelectAllState(allVisible);
        updateFab();
    }

    window.toggleAll = function(el) {
        const checkboxes = document.querySelectorAll('#browserList .chk-input');
        checkboxes.forEach(chk => {
            chk.checked = el.checked;
            // Visual Update
            if(el.checked) {
                 chk.closest('.list-row').classList.add('active-row');
                 // Data Update
                 if(!AppState.selectedKeys.includes(chk.value)) AppState.selectedKeys.push(chk.value);
            } else {
                 chk.closest('.list-row').classList.remove('active-row');
                 // Data Update
                 AppState.selectedKeys = AppState.selectedKeys.filter(x => x !== chk.value);
            }
        });
        updateFab();
    }

    function syncSelectAllState(allNames) {
        const allChecked = allNames.length > 0 && allNames.every(n => AppState.selectedKeys.includes(n));
        document.getElementById('chkAll').checked = allChecked;
    }

    function updateFab() {
        const count = AppState.selectedKeys.length;
        const fab = document.getElementById('fabBtn');
        document.getElementById('selCount').innerText = count;
        if(count > 0) {
            fab.style.display = 'block';
        } else {
            fab.style.display = 'none';
        }
    }

    /* ============================
     *  SETUP & LOGIC
     *  ============================ */
    function goToSetup() {
        switchView('v-setup');
        document.getElementById('setupSubtitle').innerText = `${AppState.selectedKeys.length} Ø¯Ø±ÙˆØ³ Ù…Ø­Ø¯Ø¯Ø©`;
        document.getElementById('filterError').style.display='none';
    }

    function backToBrowser() {
        if(AppState.tempModeQueue) { // If user came from mistakes shortcut
             goHome();
        } else {
             renderBrowser();
        }
    }

    window.setMode = (m, el) => {
        AppState.config.mode = m;
        document.querySelector('#modeChips').querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }
    window.setQty = (q, el) => {
        AppState.config.qty = q;
        document.querySelector('#qtyChips').querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }

    function startFinalQuiz() {
        let pool = [];

        if(AppState.tempModeQueue) {
            // Priority: Mistakes Mode Short Circuit
            pool = AppState.tempModeQueue;
        } else {
            // Standard: Filter All Data based on selected Lesson Keys
            pool = AppState.allData.filter(q => AppState.selectedKeys.includes(q._meta.lesson));
        }

        // Apply Mode Filters
        const m = AppState.config.mode;
        if(m === 'new') pool = pool.filter(q => AppState.progress[q.id] !== 'correct');
        else if (m === 'mistake') pool = pool.filter(q => AppState.progress[q.id] === 'wrong');

        if(pool.length === 0) {
            document.getElementById('filterError').style.display='block';
            return;
        }

        // Shuffle & Slice
        pool.sort(()=>Math.random()-0.5);
        AppState.quizQueue = pool.slice(0, AppState.config.qty);
        AppState.currentIdx = 0;
        
        AppState.tempModeQueue = null; // Clean up
        renderQuiz();
    }

    /* ============================
     *  QUIZ EXECUTION
     *  ============================ */
    function renderQuiz() {
        switchView('v-quiz');
        const Q = AppState.quizQueue[AppState.currentIdx];
        const QTotal = AppState.quizQueue.length;

        document.getElementById('qCount').innerText = `Q: ${AppState.currentIdx+1} / ${QTotal}`;
        document.getElementById('qID').innerText = `#${Q.id}`;

        const c = document.getElementById('quizContent');
        
        // HTML construction
        let html = "";
        if(Q.image) html += `<img src="${Q.image}" style="max-width:100%; border-radius:12px; margin-bottom:15px; display:block">`;
        html += `<div class="q-body">${Q.question}</div>`;
        html += `<div id="opts"></div>`;
        
        // Explanation block hidden by default
        html += `<div id="expl" style="display:none; background:#ecfdf5; padding:15px; border-radius:12px; margin-top:20px; line-height:1.6; color:#064e3b;"></div>`;
        html += `<button id="btnNext" onclick="nextQ()" class="btn-primary" style="margin-top:20px; display:none">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸</button>`;

        c.innerHTML = html;

        if(Q.type==='matching') {
             c.innerHTML += `<p style='text-align:center; color:var(--danger)'>Ø³Ø¤Ø§Ù„ ØªÙˆØµÙŠÙ„ - ØªØ®Ø·ÙŠ ÙÙŠ Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</p>`;
             document.getElementById('btnNext').style.display='block';
             return;
        }

        // Render Options
        const optsDiv = document.getElementById('opts');
        Q.options.forEach((txt, i) => {
            const btn = document.createElement('div');
            btn.className = 'opt';
            btn.innerText = txt;
            btn.onclick = () => solve(i, Q, btn);
            optsDiv.appendChild(btn);
        });
        window.scrollTo(0,0);
    }

    function solve(idx, Q, el) {
        if(el.parentElement.classList.contains('locked')) return;
        el.parentElement.classList.add('locked');

        const isCorrect = (idx === Q.correct_option_id);
        
        if(isCorrect) {
            el.classList.add('correct');
        } else {
            el.classList.add('wrong');
            // Show right one
            el.parentElement.children[Q.correct_option_id].classList.add('correct');
        }

        // Show Explanation
        if(Q.explanation) {
             const expBox = document.getElementById('expl');
             expBox.style.display='block';
             expBox.innerHTML = `<b>ğŸ’¡ ØªÙˆØ¶ÙŠØ­:</b><br>${Q.explanation}`;
        }

        // SAVE
        const stat = isCorrect ? 'correct' : 'wrong';
        AppState.progress[Q.id] = stat;
        
        if(DB && UserID!=='guest') {
            DB.ref(`users/${UserID}/progress/${Q.id}`).set(stat);
            if(isCorrect) {
                 DB.ref(`users/${UserID}/totalScore`).transaction(s => (s||0)+1);
                 // Save name lazily
                 if(TG.initDataUnsafe?.user?.first_name) {
                     DB.ref(`users/${UserID}/name`).set(TG.initDataUnsafe.user.first_name);
                 }
            }
        }

        updateScoreUI();
        document.getElementById('btnNext').style.display='block';
    }

    window.nextQ = function() {
        if(AppState.currentIdx < AppState.quizQueue.length - 1) {
            AppState.currentIdx++;
            renderQuiz();
        } else {
            alert("âœ¨ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!");
            goHome();
        }
    }

    window.confirmExit = function() {
        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ØŸ")) goHome();
    }

    function updateScoreUI() {
        const s = Object.values(AppState.progress).filter(x=>x==='correct').length;
        document.getElementById('uScore').innerText = s;
    }

    /* ========== EXTRAS ========== */
    
    window.openMistakesMode = function() {
        // Collect Wrong Questions
        const wrongs = AppState.allData.filter(q => AppState.progress[q.id] === 'wrong');
        
        if(wrongs.length === 0) { alert("Ù…Ù…ØªØ§Ø²! Ø³Ø¬Ù„Ùƒ Ø®Ø§Ù„Ù Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ âœ…"); return; }
        
        AppState.tempModeQueue = wrongs;
        goToSetup();
        // Override setup title and chip
        document.getElementById('setupSubtitle').innerText = "ÙˆØ¶Ø¹ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡";
        window.setMode('mistake', document.querySelectorAll('#modeChips .chip')[1]);
    }

    window.loadLeaderboard = function() {
        switchView('v-leader');
        const box = document.getElementById('leaderList');
        box.innerHTML = `<div style="padding:20px;text-align:center">ØªØ­Ù…ÙŠÙ„...</div>`;
        
        if(!DB) { box.innerHTML = "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ÙØ§ÙŠØ±Ø¨ÙŠØ³"; return; }

        DB.ref('users').orderByChild('totalScore').limitToLast(20).once('value', snap => {
            let arr = [];
            snap.forEach(c => arr.push({ id: c.key, name: c.val().name||'Student', score: c.val().totalScore||0 }));
            arr.sort((a,b)=> b.score - a.score); // DESC

            let html = "";
            if(arr.length === 0) html = "<div style='padding:15px;text-align:center'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø§ÙØ³ÙŠÙ† Ø¨Ø¹Ø¯</div>";

            arr.forEach((u, i) => {
                let badge = "";
                if(i===0) badge="ğŸ¥‡"; else if(i===1) badge="ğŸ¥ˆ"; else if(i===2) badge="ğŸ¥‰"; else badge = `#${i+1}`;
                const isMe = (u.id === UserID) ? "background:rgba(59,130,246,0.1);font-weight:bold" : "";

                html += `
                <div class="leader-row" style="${isMe}">
                    <div><span class="medal">${badge}</span> ${u.name}</div>
                    <div style="font-weight:700">${u.score}</div>
                </div>`;
            });
            box.innerHTML = html;
        });
    }

    // START
    window.addEventListener('load', init);

</script>
</body>
</html>
