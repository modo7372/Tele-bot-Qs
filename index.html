<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Bot Pro</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDKs (Compat version for simplicity) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --primary: #3b82f6; /* Modern Blue */
            --correct: #10b981;
            --correct-bg: #d1fae5;
            --wrong: #ef4444;
            --wrong-bg: #fee2e2;
            --border: #e9ecef;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        body.dark-mode {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding-bottom: 80px; /* For Bottom Nav */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.3s ease;
        }

        /* --- Header --- */
        header {
            background: var(--card-bg);
            padding: 12px 16px;
            box-shadow: var(--shadow);
            position: sticky; top: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
        }
        .app-title { font-weight: 700; font-size: 1.1rem; }
        .sync-badge {
            font-size: 0.7rem; padding: 4px 8px; border-radius: 20px;
            background: #e5e7eb; color: #4b5563; font-weight: 600;
        }
        body.dark-mode .sync-badge { background: #374151; color: #d1d5db; }

        .score-box { font-size: 0.85rem; font-weight: 500; }
        
        /* --- Loader --- */
        #loader {
            position: fixed; inset: 0; background: var(--bg-color); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Toast Notification --- */
        #toast {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.95); color: white; padding: 10px 20px;
            border-radius: 30px; font-size: 0.85rem; z-index: 1000;
            display: none; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        /* --- Menus & Lists --- */
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }

        .menu-card {
            background: var(--card-bg); border-radius: var(--radius);
            padding: 16px; margin-bottom: 12px;
            box-shadow: var(--shadow);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: transform 0.1s; border: 1px solid var(--border);
        }
        .menu-card:active { transform: scale(0.98); }
        .menu-title { font-weight: 600; font-size: 1rem; }
        .menu-meta { font-size: 0.8rem; color: var(--text-secondary); }
        .count-pill {
            background: var(--bg-color); color: var(--text-secondary);
            padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700;
        }

        /* --- Breadcrumb --- */
        .breadcrumb {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 16px; font-size: 0.9rem; font-weight: 500;
            color: var(--primary); cursor: pointer;
        }

        /* --- Chips --- */
        .chips-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .chip {
            padding: 8px 16px; border-radius: 20px;
            background: var(--card-bg); border: 1px solid var(--border);
            font-size: 0.9rem; font-weight: 500; cursor: pointer;
            transition: all 0.2s;
        }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- Quiz Interface --- */
        .q-img-wrap { width: 100%; border-radius: var(--radius); overflow: hidden; margin-bottom: 16px; display: none; }
        .q-img-wrap img { width: 100%; height: auto; object-fit: contain; }
        
        .question-text {
            font-size: 1.15rem; font-weight: 600; line-height: 1.6; margin-bottom: 24px;
        }

        .options-list { display: flex; flex-direction: column; gap: 12px; }
        .opt-btn {
            background: var(--card-bg); padding: 16px; border-radius: var(--radius);
            border: 2px solid var(--border); cursor: pointer; text-align: right;
            font-size: 1rem; transition: all 0.2s; position: relative; color: var(--text-primary);
        }
        
        /* Feedback States */
        .opt-btn.correct { background: var(--correct-bg); border-color: var(--correct); color: #064e3b; }
        .opt-btn.wrong { background: var(--wrong-bg); border-color: var(--wrong); color: #7f1d1d; }

        /* Explanation Box */
        .explanation {
            margin-top: 24px; background: #fffbeb; padding: 16px;
            border-right: 4px solid #f59e0b; border-radius: 8px;
            font-size: 0.95rem; line-height: 1.5; color: #78350f;
            display: none; animation: fadeIn 0.4s ease;
        }
        body.dark-mode .explanation { background: #451a03; color: #fbbf24; border-color: #fbbf24; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Primary Action Button --- */
        .primary-btn {
            width: 100%; padding: 16px; border-radius: var(--radius);
            background: var(--primary); color: white; font-weight: bold; font-size: 1rem;
            border: none; cursor: pointer; margin-top: 20px;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.4);
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }

        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--card-bg); height: 60px;
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            font-size: 0.75rem; color: var(--text-secondary); background: none; border: none;
            gap: 4px; padding: 8px 16px; width: 50%;
        }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.2rem; }

        /* Helpers */
        .hidden { display: none !important; }
        .center-msg { text-align: center; color: var(--text-secondary); margin-top: 40px; }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 16px; font-weight: 500; color: var(--text-secondary)" id="loaderMsg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

    <!-- Notification Toast -->
    <div id="toast"></div>

    <!-- Main Application -->
    <div id="app" class="hidden">
        
        <header>
            <div>
                <div class="app-title">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ ğŸ“</div>
                <div class="sync-badge" id="syncStatus">Wait...</div>
            </div>
            <div class="score-box">
                <span style="color: var(--correct)">âœ… <span id="lblCorrect">0</span></span>
                <span style="margin: 0 8px; color: var(--border)">|</span>
                <span style="color: var(--wrong)">âŒ <span id="lblWrong">0</span></span>
            </div>
        </header>

        <!-- View 1: Home / Menu -->
        <div id="view-home" class="container">
            <div id="breadcrumbs" class="breadcrumb hidden" onclick="goBack()">
                <span>â¬…ï¸</span> <span id="crumbText">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </div>
            
            <div id="menu-list">
                <!-- Javascript will inject items here -->
            </div>
        </div>

        <!-- View 2: Quiz Setup -->
        <div id="view-setup" class="container hidden">
            <h2 id="setup-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
            
            <p style="margin-top: 24px; margin-bottom: 8px; font-weight:600">Ù†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</p>
            <div class="chips-grid" id="chip-mode">
                <div class="chip active" onclick="selectMode('new', this)">Ø£Ø³Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
                <div class="chip" onclick="selectMode('mistake', this)">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ø®Ø·Ø§Ø¦ÙŠ</div>
                <div class="chip" onclick="selectMode('mixed', this)">Ù…Ø®ØªÙ„Ø·</div>
            </div>

            <p style="margin-bottom: 8px; font-weight:600">Ø§Ù„Ø¹Ø¯Ø¯:</p>
            <div class="chips-grid" id="chip-qty">
                <div class="chip active" onclick="selectQty(5, this)">5</div>
                <div class="chip" onclick="selectQty(10, this)">10</div>
                <div class="chip" onclick="selectQty(25, this)">25</div>
                <div class="chip" onclick="selectQty(999, this)">Ø§Ù„ÙƒÙ„</div>
            </div>

            <p id="error-msg" class="hidden" style="color: var(--wrong); text-align: center;">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ØªØ·Ø§Ø¨Ù‚ Ø§Ø®ØªÙŠØ§Ø±Ø§ØªÙƒ.</p>

            <button class="primary-btn" onclick="startQuiz()">
                Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ğŸš€
            </button>
        </div>

        <!-- View 3: Active Quiz -->
        <div id="view-quiz" class="container hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom: 12px; font-size: 0.9rem; color: var(--text-secondary)">
                <span id="q-counter">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 / 5</span>
                <span onclick="confirmExit()" style="cursor:pointer; color: var(--wrong)">Ø®Ø±ÙˆØ¬</span>
            </div>

            <div class="q-img-wrap" id="q-image">
                <img src="" alt="QImage">
            </div>

            <div class="question-text" id="q-text">Loading...</div>
            
            <div class="options-list" id="opt-container">
                <!-- Options injected here -->
            </div>

            <div class="explanation" id="q-expl"></div>

            <button id="btn-next" class="primary-btn hidden" onclick="nextQuestion()">
                Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸
            </button>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showHome()">
                <span class="nav-icon">ğŸ </span>
                <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </button>
            <button class="nav-item" onclick="forceSync()">
                <span class="nav-icon">ğŸ”„</span>
                <span>ØªØ­Ø¯ÙŠØ«</span>
            </button>
        </div>
    </div>

<script>
    /** =============================================
     *  CONFIG (UPDATE THIS!)
     *  ============================================= */
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyDEZFJmcXK2LxYAZ-Yjv_M1HbC6zi_qilg", 
        authDomain: "exambotdb.firebaseapp.com",
        databaseURL: "https://exambotdb-default-rtdb.firebaseio.com",
        projectId: "exambotdb",
        storageBucket: "exambotdb.firebasestorage.app",
        messagingSenderId: "950600562980",
        appId: "1:950600562980:web:f993c22d45e5cfdd3d9bb1"
    };

    /** =============================================
     *  APP LOGIC
     *  ============================================= */
    
    // --- State Variables ---
    const State = {
        questions: [],   // Flat list of all Qs
        hierarchy: {},   // Tree: Term -> Subj -> Lesson
        path: [],        // Navigation Stack
        progress: {},    // { qId: 'correct' | 'wrong' }
        quizQueue: [],   // Active questions
        currQIndex: 0,
        settings: { mode: 'new', qty: 5 },
        selectedContext: null // { type: 'chapter'|'lesson', name: ... }
    };
    
    const STORAGE_KEYS = {
        DATA: 'EXAMBOT_DATA_V1',
        PROGRESS: 'EXAMBOT_PROGRESS'
    };

    // --- Services ---
    const TG = window.Telegram.WebApp;
    let DB = null; // Firebase DB Instance
    let USER_ID = 'guest';

    async function init() {
        TG.ready(); TG.expand();
        if(TG.initDataUnsafe?.user?.id) USER_ID = TG.initDataUnsafe.user.id;
        
        // Theme
        if (TG.colorScheme === 'dark') document.body.classList.add('dark-mode');
        
        // Firebase Setup
        try {
            if (window.firebase && !firebase.apps.length) {
                firebase.initializeApp(FIREBASE_CONFIG);
                DB = firebase.database();
            }
        } catch(e) { console.error("Firebase Init Error:", e); }

        // Load Cache first (Offline)
        loadFromCache();

        // If data loaded from cache, hide loader immediately
        if (State.questions.length > 0) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            renderMenu();
            renderStats();
            setSyncStatus('Offline âš¡');
        }

        // Try Network Sync
        if (navigator.onLine) {
            await syncData();
        } else {
            showToast('Ø£Ù†Øª ÙÙŠ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„');
        }

        window.addEventListener('online', () => { 
            showToast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„'); 
            syncData(); 
        });
        window.addEventListener('offline', () => setSyncStatus('Offline âš¡'));
    }

    /** =============================================
     *  DATA SYNC ENGINE
     *  ============================================= */
    
    function loadFromCache() {
        try {
            const cachedData = localStorage.getItem(STORAGE_KEYS.DATA);
            if(cachedData) State.questions = JSON.parse(cachedData);
            
            const cachedProg = localStorage.getItem(STORAGE_KEYS.PROGRESS + '_' + USER_ID);
            if(cachedProg) State.progress = JSON.parse(cachedProg);
            
            if(State.questions.length > 0) buildHierarchy();
        } catch(e) { console.error("Cache load error", e); }
    }

    async function syncData() {
        setSyncStatus('Connecting...');
        try {
            // 1. Sync Content
            const manifestReq = await fetch('questions_list.json?t=' + Date.now());
            if(manifestReq.ok) {
                const files = await manifestReq.json();
                const fetches = files.map(f => fetch('Questions/' + f).then(r => r.json()));
                const rawResults = await Promise.all(fetches);
                
                // Merge & Process
                let allQs = [];
                rawResults.forEach(file => {
                    const meta = file.meta || {};
                    // Normalizing hierarchy keys
                    const term = meta.source || 'General';
                    const subject = meta.subject || 'All';
                    const lesson = meta.lesson || 'Misc';
                    
                    file.questions.forEach(q => {
                        allQs.push({
                            ...q,
                            // Enrich Q with hierarchy data for filtering
                            h: { term, subject, lesson, chapter: q.chapter || 'Chapter 1' } 
                        });
                    });
                });

                // Update Cache if Changed
                if (JSON.stringify(allQs).length !== JSON.stringify(State.questions).length) {
                    State.questions = allQs;
                    localStorage.setItem(STORAGE_KEYS.DATA, JSON.stringify(allQs));
                    buildHierarchy();
                    renderMenu();
                    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© âœ…');
                }
            }

            // 2. Sync Progress (Cloud -> Local Merge)
            if(DB && USER_ID !== 'guest') {
                const snap = await DB.ref(`users/${USER_ID}/progress`).once('value');
                const cloudProg = snap.val() || {};
                
                // Cloud wins for conflict (Simple Merge)
                State.progress = { ...State.progress, ...cloudProg };
                localStorage.setItem(STORAGE_KEYS.PROGRESS + '_' + USER_ID, JSON.stringify(State.progress));
                renderStats();
            }

            setSyncStatus('Online ğŸŸ¢');

        } catch(e) {
            console.error(e);
            setSyncStatus('Offline âš¡');
            if(State.questions.length === 0) {
                 document.getElementById('loaderMsg').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹";
            }
        }
    }

    function buildHierarchy() {
        State.hierarchy = {};
        State.questions.forEach(q => {
            const h = q.h;
            // Structure: Term -> Subject -> Lesson -> Chapter
            setDeep(State.hierarchy, [h.term, h.subject, h.lesson, h.chapter], 1, true);
        });
    }

    // Helper to count and set deep keys
    function setDeep(obj, path, val, increment=false) {
        let curr = obj;
        for(let i=0; i<path.length-1; i++){
            let key = path[i];
            if(!curr[key]) curr[key] = {};
            curr = curr[key];
        }
        let lastKey = path[path.length-1];
        if(increment) curr[lastKey] = (curr[lastKey] || 0) + val;
        else curr[lastKey] = val;
    }

    // Recursively count leaf nodes (Total questions under a category)
    function countTotal(node) {
        if (typeof node === 'number') return node;
        let sum = 0;
        Object.values(node).forEach(v => sum += countTotal(v));
        return sum;
    }

    /** =============================================
     *  UI RENDERING
     *  ============================================= */

    function renderMenu() {
        const listEl = document.getElementById('menu-list');
        listEl.innerHTML = '';
        
        let pointer = State.hierarchy;
        // Traverse to current path
        State.path.forEach(key => pointer = pointer[key]);
        
        // Show/Hide Back Button
        const bc = document.getElementById('breadcrumbs');
        if(State.path.length > 0) {
            bc.classList.remove('hidden');
            document.getElementById('crumbText').innerText = State.path.join(' > ');
        } else {
            bc.classList.add('hidden');
        }

        // Determine Level: (0:Term, 1:Subject, 2:Lesson, 3:Chapter)
        const isLeaves = Object.values(pointer)[0] && typeof Object.values(pointer)[0] === 'number';
        const level = State.path.length;
        const Icons = ['ğŸ“…', 'ğŸ“˜', 'ğŸ“‘', 'ğŸ”–'];

        // Add "Test All" Option if deep enough
        if(level >= 2 && !isLeaves) { 
             const allCard = createCard('ğŸ¯', 'Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ ÙÙŠ (ÙƒÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³)', countTotal(pointer), true);
             allCard.onclick = () => openSetup('group', 'All');
             listEl.appendChild(allCard);
        }
        if(isLeaves) {
             const allCard = createCard('ğŸ“š', 'Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ (ÙƒÙ„ Ø§Ù„ÙØµÙˆÙ„)', countTotal(pointer), true);
             allCard.onclick = () => openSetup('group', 'All');
             listEl.appendChild(allCard);
        }

        // Render Children
        Object.keys(pointer).forEach(key => {
            const val = pointer[key];
            const count = isLeaves ? val : countTotal(val);
            const card = createCard(Icons[level] || 'ğŸ“‚', key, count);
            
            card.onclick = () => {
                if(isLeaves) openSetup('chapter', key); // Selected a specific chapter
                else {
                    State.path.push(key);
                    renderMenu();
                }
            };
            listEl.appendChild(card);
        });
    }

    function createCard(icon, title, count, highlight=false) {
        const div = document.createElement('div');
        div.className = 'menu-card';
        if(highlight) div.style.borderColor = 'var(--primary)';
        div.innerHTML = `
            <div style="display:flex; align-items:center; gap:12px">
                <span style="font-size:1.4rem">${icon}</span>
                <div><div class="menu-title">${title}</div></div>
            </div>
            <div class="count-pill">${count}</div>
        `;
        return div;
    }

    function renderStats() {
        let c = 0, w = 0;
        Object.values(State.progress).forEach(s => s==='correct'?c++ : w++);
        document.getElementById('lblCorrect').innerText = c;
        document.getElementById('lblWrong').innerText = w;
    }

    /** =============================================
     *  QUIZ SETUP & LOGIC
     *  ============================================= */

    function goBack() {
        if(State.path.length > 0) {
            State.path.pop();
            renderMenu();
        }
    }

    function openSetup(type, name) {
        State.selectedContext = { type, name };
        
        switchView('view-setup');
        const levelNames = ['Ø§Ù„ØªØ±Ù…', 'Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ù„Ø¯Ø±Ø³', 'Ø§Ù„ÙØµÙ„'];
        let ctx = State.path.length < 3 ? 'Ø´Ø§Ù…Ù„' : State.path[2]; 
        
        // Dynamic title
        document.getElementById('setup-title').innerText = `Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø®ØªØ¨Ø§Ø±: ${name==='All'?'Ø§Ù„ÙƒÙ„':name}`;
        document.getElementById('error-msg').classList.add('hidden');
    }

    function selectMode(m, el) { 
        State.settings.mode = m; 
        document.querySelectorAll('#chip-mode .chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }

    function selectQty(q, el) { 
        State.settings.qty = q; 
        document.querySelectorAll('#chip-qty .chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }

    function startQuiz() {
        const mode = State.settings.mode;
        // Current Path: [Term, Subject, Lesson]
        // Filter logic:
        const pathFilters = {
            term: State.path[0],
            subject: State.path[1],
            lesson: State.path[2]
        };

        let candidates = State.questions.filter(q => {
            const h = q.h;
            // Match current Path (if defined)
            if(pathFilters.term && h.term !== pathFilters.term) return false;
            if(pathFilters.subject && h.subject !== pathFilters.subject) return false;
            // Lesson matching is tricky depending on 'Test All' at higher level
            if(State.path.length >= 3 && pathFilters.lesson && h.lesson !== pathFilters.lesson) return false;
            
            // Chapter matching
            if(State.selectedContext.name !== 'All') {
                 if(State.selectedContext.type === 'chapter' && h.chapter !== State.selectedContext.name) return false;
            }
            return true;
        });

        // Filter by Mode
        if (mode === 'new') {
            candidates = candidates.filter(q => State.progress[q.id] !== 'correct');
        } else if (mode === 'mistake') {
            candidates = candidates.filter(q => State.progress[q.id] === 'wrong');
        }

        if(candidates.length === 0) {
            document.getElementById('error-msg').classList.remove('hidden');
            return;
        }

        // Shuffle & Limit
        candidates.sort(() => Math.random() - 0.5);
        State.quizQueue = candidates.slice(0, State.settings.qty);
        State.currQIndex = 0;

        switchView('view-quiz');
        renderQuestion();
    }

    /** =============================================
     *  ACTIVE QUIZ
     *  ============================================= */

    function renderQuestion() {
        const Q = State.quizQueue[State.currQIndex];
        
        // Reset UI
        document.getElementById('q-counter').innerText = `${State.currQIndex+1} / ${State.quizQueue.length}`;
        document.getElementById('btn-next').classList.add('hidden');
        document.getElementById('q-expl').style.display = 'none';
        
        // Text & Image
        document.getElementById('q-text').innerText = Q.question;
        const imgWrap = document.getElementById('q-image');
        // Example check: adjust property if your JSON has images differently
        if(Q.image || Q.img) {
             imgWrap.querySelector('img').src = Q.image || Q.img;
             imgWrap.style.display = 'block';
        } else {
            imgWrap.style.display = 'none';
        }

        // Options
        const optsDiv = document.getElementById('opt-container');
        optsDiv.innerHTML = '';

        if(Q.type === 'matching') {
            optsDiv.innerHTML = `<div style="padding:20px; text-align:center; color:orange">âš ï¸ Ø³Ø¤Ø§Ù„ ØªÙˆØµÙŠÙ„ (ÙŠØ±Ø¬Ù‰ Ø­Ù„Ù‡ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨)</div>`;
            document.getElementById('btn-next').classList.remove('hidden');
        } else {
            // MCQ
            Q.options.forEach((txt, i) => {
                const btn = document.createElement('div');
                btn.className = 'opt-btn';
                btn.innerText = txt;
                btn.onclick = () => submitAnswer(i, Q, btn);
                optsDiv.appendChild(btn);
            });
        }
        
        // Auto scroll top
        window.scrollTo(0,0);
    }

    function submitAnswer(selIdx, Q, btnElement) {
        if(btnElement.parentElement.classList.contains('locked')) return;
        btnElement.parentElement.classList.add('locked');

        const correct = selIdx === Q.correct_option_id; // JSON property
        const status = correct ? 'correct' : 'wrong';

        if(correct) {
            btnElement.classList.add('correct');
            showToast('Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ğŸ‘');
        } else {
            btnElement.classList.add('wrong');
            // Highlight right one
            const allBtns = document.getElementById('opt-container').children;
            if(allBtns[Q.correct_option_id]) allBtns[Q.correct_option_id].classList.add('correct');
            TG.HapticFeedback && TG.HapticFeedback.notificationOccurred('error');
        }

        // Show Explanation
        if(Q.explanation) {
            const exp = document.getElementById('q-expl');
            exp.innerHTML = `<strong>ØªÙˆØ¶ÙŠØ­:</strong><br>${Q.explanation}`;
            exp.style.display = 'block';
        }

        // Save Logic
        State.progress[Q.id] = status;
        localStorage.setItem(STORAGE_KEYS.PROGRESS + '_' + USER_ID, JSON.stringify(State.progress));
        renderStats();

        // Cloud Push (Fire & Forget)
        if(DB && USER_ID !== 'guest' && navigator.onLine) {
            DB.ref(`users/${USER_ID}/progress/${Q.id}`).set(status);
        }

        document.getElementById('btn-next').classList.remove('hidden');
    }

    function nextQuestion() {
        if(State.currQIndex < State.quizQueue.length - 1) {
            State.currQIndex++;
            renderQuestion();
        } else {
            // End
            showToast('Ø£ØªÙ…Ù…Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰');
            setTimeout(showHome, 1000);
        }
    }

    function confirmExit() {
        TG.showConfirm("Ù‡Ù„ ØªÙˆØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ", (ok) => {
            if(ok) showHome();
        });
    }

    // --- View Navigation Helper ---
    function switchView(viewId) {
        ['view-home', 'view-setup', 'view-quiz'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(viewId).classList.remove('hidden');
    }

    function showHome() { 
        switchView('view-home');
        renderStats();
    }
    
    function forceSync() {
        if(!navigator.onLine) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø§Ù†ØªØ±Ù†Øª!'); return; }
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('loaderMsg').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«...";
        
        syncData().then(() => {
            setTimeout(() => {
                document.getElementById('loader').classList.add('hidden');
            }, 800);
        });
    }

    // --- Helpers ---
    function setSyncStatus(msg) { document.getElementById('syncStatus').innerText = msg; }
    
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display='block';
        setTimeout(()=>t.style.display='none', 3000);
    }

    // --- Boot ---
    window.addEventListener('load', init);

</script>
</body>
</html>
